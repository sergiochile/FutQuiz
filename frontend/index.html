<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>FutQuiz</title>
    <!-- Google Fonts - Nunito (gaming look) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Facebook Instant Games SDK (requerido para Facebook Games) -->
    <script src="https://connect.facebook.net/en_US/fbinstant.6.3.js"></script>
    <!-- ConfiguraciÃ³n de la app (API URL, Facebook App ID) -->
    <script src="config.js"></script>
        <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FUTQUIZ â€” Dark Mobile-First Design System
           Paleta: Verde-teal #00D4AA, Dorado #FFD700, Dark #0B1426
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary:    #00D4AA;
            --primary-dk: #00A882;
            --primary-lt: rgba(0,212,170,0.15);
            --secondary:  #FFD700;
            --sec-dk:     #E6B800;
            --accent:     #FF6B35;
            --success:    #2ECC71;
            --danger:     #FF4757;
            --dark:       #0B1426;
            --dark2:      #111D35;
            --dark3:      #162040;
            --card-bg:    #1C2B47;
            --card-bg2:   #233459;
            --surface:    rgba(255,255,255,0.06);
            --border:     rgba(255,255,255,0.10);
            --border2:    rgba(255,255,255,0.18);
            --text:       #E8F0FE;
            --text2:      #8FA3BF;
            --text3:      #5A7A9B;
            --radius:     12px;
            --radius-lg:  18px;
            --radius-xl:  24px;
            --shadow:     0 4px 20px rgba(0,0,0,0.4);
            --shadow-lg:  0 8px 40px rgba(0,0,0,0.6);
            --glow:       0 0 20px rgba(0,212,170,0.3);
            --glow-gold:  0 0 20px rgba(255,215,0,0.4);
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Nunito', 'Segoe UI', system-ui, sans-serif;
            background: var(--dark);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* â”€â”€ Animaciones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @keyframes fadeIn    { from{opacity:0}  to{opacity:1} }
        @keyframes slideUp   { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }
        @keyframes slideIn   { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
        @keyframes popIn     { 0%{transform:scale(0.6);opacity:0} 70%{transform:scale(1.06)} 100%{transform:scale(1);opacity:1} }
        @keyframes bounce    { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
        @keyframes pulse     { 0%,100%{opacity:1} 50%{opacity:0.55} }
        @keyframes spin      { to{transform:rotate(360deg)} }
        @keyframes shimmer   { 0%{background-position:-200% center} 100%{background-position:200% center} }
        @keyframes unlockAnim{ 0%{transform:translateY(36px) scale(0.7);opacity:0} 60%{transform:translateY(-8px) scale(1.05);opacity:1} 100%{transform:translateY(0) scale(1)} }
        @keyframes timerPulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.18)} }
        @keyframes glowPulse { 0%,100%{box-shadow:0 0 8px rgba(0,212,170,0.3)} 50%{box-shadow:0 0 24px rgba(0,212,170,0.8)} }
        @keyframes glowGold  { 0%,100%{box-shadow:0 0 8px rgba(255,215,0,0.3)} 50%{box-shadow:0 0 24px rgba(255,215,0,0.8)} }
        @keyframes shake     { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-7px)} 40%{transform:translateX(7px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }
        @keyframes confettiFall { 0%{transform:translateY(-20px) rotate(0);opacity:1} 100%{transform:translateY(100vh) rotate(720deg);opacity:0} }
        @keyframes rippleAnim{ to{transform:scale(4);opacity:0} }
        @keyframes flicker   { 0%,100%{transform:scaleY(1)} 25%{transform:scaleY(1.12) scaleX(0.88)} 75%{transform:scaleY(0.9) scaleX(1.1)} }
        @keyframes floatBg   { 0%,100%{transform:translateY(0) rotate(0) scale(1);opacity:0.3} 50%{transform:translateY(-28px) rotate(180deg) scale(1.1);opacity:0.5} }
        @keyframes slideInFromRight { from{opacity:0;transform:translateX(28px)} to{opacity:1;transform:translateX(0)} }
        @keyframes slideInFromLeft  { from{opacity:0;transform:translateX(-28px)} to{opacity:1;transform:translateX(0)} }
        @keyframes optionStagger    { from{opacity:0;transform:translateX(-14px)} to{opacity:1;transform:translateX(0)} }
        @keyframes starBurst { 0%{transform:scale(0) rotate(0);opacity:1} 100%{transform:scale(2.5) rotate(45deg);opacity:0} }
        @keyframes promotionAnim { 0%{transform:scale(0.5) translateY(20px);opacity:0} 60%{transform:scale(1.12) translateY(-8px);opacity:1} 100%{transform:scale(1) translateY(0)} }
        @keyframes scoreFloat{ 0%{transform:translateY(0);opacity:1} 100%{transform:translateY(-60px);opacity:0} }
        @keyframes timerShrink { from{stroke-dashoffset:0} to{stroke-dashoffset:283} }
        @keyframes authBg { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }

        /* â”€â”€ Ripple â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn,.menu-btn,.mode-card,.option-btn,.btn-small,
        .filter-btn,.pvp-accept-btn,.pvp-reject-btn,.tab-btn {
            position:relative; overflow:hidden;
        }
        .ripple {
            position:absolute; border-radius:50%;
            background:rgba(255,255,255,0.25);
            width:100px; height:100px;
            margin-top:-50px; margin-left:-50px;
            animation:rippleAnim 0.6s linear;
            pointer-events:none; z-index:10;
        }

        /* â”€â”€ Loading overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .loading-overlay {
            display:none; position:fixed; inset:0;
            background:rgba(11,20,38,0.85);
            z-index:200; align-items:center; justify-content:center;
            flex-direction:column; gap:16px; backdrop-filter:blur(4px);
        }
        .loading-overlay.show { display:flex; }
        .spinner {
            width:52px; height:52px;
            border:4px solid rgba(0,212,170,0.2);
            border-top-color:var(--primary);
            border-radius:50%; animation:spin 0.85s linear infinite;
        }
        .loading-text { color:var(--text); font-weight:700; font-size:0.95em; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           AUTH SCREEN â€” Pantalla de inicio de sesiÃ³n
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #authScreen {
            display:flex; justify-content:center; align-items:center;
            min-height:100vh; padding:20px;
            background: linear-gradient(135deg, #060D1F 0%, #0B1426 40%, #0D1F3C 70%, #071229 100%);
            background-size:400% 400%;
            animation:authBg 12s ease infinite, fadeIn 0.6s;
            position:relative; overflow:hidden;
        }
        #authScreen.hidden { display:none; }

        /* PartÃ­culas decorativas de fondo */
        #authScreen::before {
            content:'âš½ ğŸ† â­ ğŸ¥… ğŸ‘Ÿ ğŸ… âš½ ğŸ”¥';
            position:absolute; inset:0;
            font-size:3em; opacity:0.04;
            display:flex; flex-wrap:wrap; align-items:center;
            justify-content:space-around; padding:20px;
            pointer-events:none; line-height:2;
            letter-spacing:20px;
        }
        #authScreen::after {
            content:'';
            position:absolute; width:400px; height:400px;
            background:radial-gradient(circle, rgba(0,212,170,0.08) 0%, transparent 70%);
            top:-100px; left:-100px; border-radius:50%;
            pointer-events:none; animation:floatBg 8s ease-in-out infinite;
        }

        .auth-box {
            background:var(--card-bg);
            border:1px solid var(--border2);
            border-radius:var(--radius-xl);
            padding:36px 30px;
            width:100%; max-width:390px;
            box-shadow:var(--shadow-lg), 0 0 60px rgba(0,212,170,0.06);
            animation:slideUp 0.65s cubic-bezier(0.34,1.56,0.64,1);
            position:relative; z-index:1;
        }

        .auth-header { text-align:center; margin-bottom:24px; }
        .auth-logo {
            display:block; font-size:3.8em; margin-bottom:8px;
            filter:drop-shadow(0 4px 12px rgba(0,212,170,0.5));
            animation:bounce 2.5s ease-in-out infinite;
        }
        .auth-header h2 {
            font-size:1.9em; font-weight:900;
            background:linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
            background-clip:text; margin-bottom:6px;
        }
        .auth-header p {
            color:var(--text2); font-size:0.9em; line-height:1.4;
        }

        .lang-selector {
            display:flex; gap:8px; justify-content:center;
            flex-wrap:wrap; margin:10px 0 18px;
        }
        .lang-btn {
            padding:6px 14px; border-radius:20px;
            border:1.5px solid var(--border2);
            background:var(--surface); color:var(--text2);
            font-size:0.8em; font-weight:700;
            cursor:pointer; transition:all 0.2s; font-family:inherit;
        }
        .lang-btn:hover  { background:rgba(0,212,170,0.15); color:var(--primary); border-color:var(--primary); }
        .lang-btn.active { background:var(--primary); border-color:var(--primary); color:#0B1426; }

        .tab-buttons {
            display:flex; gap:6px; margin-bottom:22px;
            background:var(--dark2); border-radius:var(--radius); padding:5px;
            border:1px solid var(--border);
        }
        .tab-btn {
            flex:1; padding:11px; border:none;
            background:transparent; cursor:pointer;
            font-weight:700; color:var(--text2); font-size:0.95em;
            transition:all 0.3s; border-radius:9px; font-family:inherit;
        }
        .tab-btn.active {
            background:var(--card-bg2); color:var(--primary);
            box-shadow:0 2px 10px rgba(0,0,0,0.3);
        }

        .error-msg {
            background:rgba(255,71,87,0.15); color:#FF6B7A;
            border:1px solid rgba(255,71,87,0.3);
            padding:12px 16px; border-radius:var(--radius);
            margin-bottom:16px; display:none; animation:slideIn 0.3s;
            font-size:0.88em; font-weight:600;
        }
        .error-msg.show { display:block; }

        .form { display:none; }
        .form.active { display:block; animation:fadeIn 0.3s; }

        .form-group { margin-bottom:16px; }
        .form-group label {
            display:block; margin-bottom:7px;
            font-weight:700; color:var(--text2); font-size:0.85em;
            text-transform:uppercase; letter-spacing:0.5px;
        }
        .form-group input {
            width:100%; padding:14px 16px;
            background:var(--dark2); border:1.5px solid var(--border2);
            border-radius:var(--radius); color:var(--text);
            font-size:1em; font-family:inherit;
            transition:border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input::placeholder { color:var(--text3); }
        .form-group input:focus {
            outline:none; border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(0,212,170,0.15);
        }

        .btn {
            width:100%; padding:16px; border:none;
            border-radius:var(--radius); font-size:1.05em;
            font-weight:800; cursor:pointer;
            transition:all 0.25s; margin-top:8px;
            font-family:inherit; letter-spacing:0.3px;
        }
        .btn-primary {
            background:linear-gradient(135deg, var(--primary) 0%, var(--primary-dk) 100%);
            color:#0B1426;
            box-shadow:0 4px 20px rgba(0,212,170,0.35);
        }
        .btn-primary:hover {
            transform:translateY(-2px);
            box-shadow:0 8px 28px rgba(0,212,170,0.5);
        }
        .btn-primary:active { transform:translateY(0); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           GAME SHELL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #gameScreen {
            display:none; min-height:100vh;
            background: linear-gradient(180deg, var(--dark) 0%, var(--dark2) 100%);
            padding:12px 16px max(16px, env(safe-area-inset-bottom)) 16px;
            padding-top:max(12px, env(safe-area-inset-top));
        }
        #gameScreen.active { display:flex; flex-direction:column; }
        .game-container { max-width:520px; margin:0 auto; width:100%; flex:1; display:flex; flex-direction:column; }

        /* â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .top-bar {
            display:flex; align-items:center; gap:8px;
            padding:10px 14px; margin-bottom:16px;
            background:rgba(28,43,71,0.8);
            backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
            border:1px solid var(--border); border-radius:var(--radius-lg);
            animation:slideIn 0.4s; flex-wrap:wrap;
        }
        .logo-game {
            font-size:1.1em; font-weight:900; color:var(--primary);
            letter-spacing:-0.5px; flex-shrink:0;
        }
        .score-display {
            background:linear-gradient(135deg, var(--primary), var(--secondary));
            color:#0B1426; padding:5px 12px; border-radius:20px;
            font-weight:800; font-size:0.85em; flex-shrink:0;
        }
        .mute-btn {
            background:var(--surface); border:1px solid var(--border);
            border-radius:8px; padding:5px 9px;
            cursor:pointer; font-size:0.95em;
            transition:all 0.2s; color:white; line-height:1; flex-shrink:0;
        }
        .mute-btn:hover { background:rgba(255,255,255,0.15); transform:scale(1.1); }
        .user-logout {
            background:rgba(255,71,87,0.2); color:#FF6B7A;
            border:1px solid rgba(255,71,87,0.3);
            padding:5px 10px; border-radius:8px; cursor:pointer;
            font-weight:700; font-size:0.78em; transition:all 0.2s; flex-shrink:0;
        }
        .user-logout:hover { background:rgba(255,71,87,0.35); }

        /* Topbar lang */
        .topbar-lang { display:flex; gap:4px; align-items:center; }
        .topbar-lang .lang-btn {
            padding:3px 8px; font-size:0.7em;
            border-color:var(--border); background:var(--surface);
        }

        /* Energy display */
        .energy-display {
            display:flex; align-items:center; gap:2px;
            background:var(--surface); border-radius:20px;
            padding:4px 9px; cursor:pointer; flex-shrink:0; border:1px solid var(--border);
        }
        .energy-heart { font-size:0.88em; transition:all 0.3s; }
        .energy-heart.empty { filter:grayscale(1); opacity:0.35; }
        .energy-count { color:white; font-size:0.75em; font-weight:700; margin-left:2px; }

        /* â”€â”€ Screens show/hide â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .screen { display:none; flex:1; flex-direction:column; animation:fadeIn 0.4s; }
        .screen.active { display:flex; }
        .screen.slide-right { animation:slideInFromRight 0.32s ease-out; }
        .screen.slide-left  { animation:slideInFromLeft 0.32s ease-out; }

        /* â”€â”€ Back button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .back-btn {
            background:var(--surface); color:var(--text2);
            border:1px solid var(--border2);
            padding:8px 16px; border-radius:var(--radius);
            cursor:pointer; font-weight:700; font-size:0.85em;
            transition:all 0.2s; margin-bottom:14px;
            display:inline-flex; align-items:center; gap:6px;
            width:fit-content; font-family:inherit;
        }
        .back-btn:hover { background:rgba(255,255,255,0.12); color:white; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAIN MENU
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .main-menu { text-align:center; padding:20px 0; position:relative; }
        .menu-particles {
            position:absolute; top:0; left:0; width:100%; height:100%;
            pointer-events:none; overflow:hidden; z-index:0;
        }
        .menu-particles span {
            position:absolute; border-radius:50%;
            background:rgba(0,212,170,0.06);
            animation:floatBg ease-in-out infinite;
        }
        .main-menu > *:not(.menu-particles) { position:relative; z-index:1; }

        .menu-title {
            font-size:2.4em; font-weight:900; margin-bottom:6px;
            background:linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
            background-clip:text;
        }
        .menu-subtitle { color:var(--text2); margin-bottom:22px; font-size:0.95em; }

        .menu-buttons { display:flex; flex-direction:column; gap:10px; }
        .menu-btn {
            background:var(--card-bg); border:1px solid var(--border2);
            padding:16px 20px; border-radius:var(--radius-lg);
            font-size:1.05em; font-weight:700; cursor:pointer;
            transition:all 0.25s; color:var(--text); text-align:left;
            font-family:inherit;
        }
        .menu-btn:hover {
            transform:translateY(-3px);
            border-color:var(--primary); background:var(--card-bg2);
            box-shadow:0 6px 20px rgba(0,0,0,0.3), 0 0 0 1px rgba(0,212,170,0.2);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MODE SELECTOR
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .mode-selector { padding:10px 0; }
        .screen-title { font-size:1.5em; font-weight:900; color:white; text-align:center; margin-bottom:4px; }
        .screen-subtitle { color:var(--text2); text-align:center; margin-bottom:20px; font-size:0.88em; }

        .mode-cards { display:flex; flex-direction:column; gap:12px; }
        .mode-card {
            background:var(--card-bg); border:1px solid var(--border2);
            border-radius:var(--radius-lg); padding:18px;
            cursor:pointer; transition:all 0.25s;
        }
        .mode-card:hover {
            transform:translateY(-3px);
            border-color:var(--primary); background:var(--card-bg2);
            box-shadow:0 8px 24px rgba(0,0,0,0.4), var(--glow);
        }
        .mode-card-top { display:flex; align-items:center; gap:14px; margin-bottom:8px; }
        .mode-icon { font-size:2em; flex-shrink:0; }
        .mode-name { font-size:1.15em; font-weight:800; color:var(--text); }
        .mode-desc { font-size:0.85em; color:var(--text2); margin-top:2px; }
        .mode-tags { display:flex; gap:7px; margin-top:10px; flex-wrap:wrap; }
        .mode-tag {
            background:var(--surface); color:var(--text2);
            padding:4px 10px; border-radius:20px; font-size:0.75em; font-weight:700;
            border:1px solid var(--border);
        }
        .mode-tag.green  { background:rgba(46,204,113,0.15); color:#2ECC71; border-color:rgba(46,204,113,0.3); }
        .mode-tag.yellow { background:rgba(255,215,0,0.12);  color:#FFD700;  border-color:rgba(255,215,0,0.25); }
        .mode-tag.red    { background:rgba(255,71,87,0.12);  color:#FF6B7A;  border-color:rgba(255,71,87,0.25); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           QUIZ SCREEN
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .quiz-container { flex:1; flex-direction:column; justify-content:flex-start; gap:12px; }

        /* Duel HUD */
        .duel-hud {
            background:rgba(0,0,0,0.35); border:1px solid var(--border);
            border-radius:var(--radius-lg); padding:12px 16px;
            display:none; align-items:center; gap:0;
        }
        .duel-hud.active { display:flex; }
        .duel-player-side { flex:1; display:flex; flex-direction:column; align-items:center; gap:4px; }
        .duel-avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid var(--primary); }
        .duel-name   { font-size:0.72em; color:white; font-weight:700; text-align:center; max-width:80px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .duel-score  { font-size:1.3em; font-weight:900; color:var(--primary); }
        .duel-score.losing  { color:var(--danger); }
        .duel-score.winning { color:var(--success); }
        .duel-vs { font-size:1.1em; font-weight:900; color:var(--text2); padding:0 10px; }
        .duel-bot-thinking { font-size:0.65em; color:var(--text3); text-align:center; height:14px; }

        /* Indicador de conexiÃ³n del rival (HUD real 1v1) */
        .duel-rival-status {
            font-size:0.6em; height:12px; text-align:center;
            transition: color 0.3s;
        }
        .duel-rival-status.connected    { color:var(--success); }
        .duel-rival-status.disconnected { color:var(--danger); animation: pulse 1s infinite; }

        /* Overlay de espera al rival (pantalla post-partida) */
        #duelWaitRivalOverlay {
            display:none; position:fixed; inset:0; z-index:300;
            background:rgba(11,20,38,0.92); backdrop-filter:blur(8px);
            flex-direction:column; align-items:center; justify-content:center; gap:20px;
        }
        #duelWaitRivalOverlay.active { display:flex; }
        .duel-wait-icon  { font-size:3.5rem; }
        .duel-wait-title { font-size:1.3em; font-weight:900; color:white; text-align:center; }
        .duel-wait-sub   { font-size:0.88em; color:var(--text2); text-align:center; max-width:280px; }
        .duel-wait-score { font-size:2rem; font-weight:900; color:var(--primary); }
        .duel-wait-bar   { width:220px; height:6px; background:var(--card-bg); border-radius:3px; overflow:hidden; }
        .duel-wait-fill  { height:100%; background:linear-gradient(90deg,var(--primary),var(--secondary)); border-radius:3px; transition:width 1s linear; }

        /* Quiz HUD row */
        .quiz-hud {
            display:flex; justify-content:space-between; align-items:center;
            background:var(--card-bg); border:1px solid var(--border);
            border-radius:var(--radius); padding:10px 16px;
        }
        .lives-display { font-size:1em; letter-spacing:2px; }
        .streak-badge {
            background:linear-gradient(135deg, var(--accent), #FF8C42);
            color:white; padding:4px 12px; border-radius:20px;
            font-weight:800; font-size:0.82em; display:none;
        }
        .timer-display {
            font-size:1.25em; font-weight:900; color:var(--primary);
            min-width:36px; text-align:center;
        }
        .timer-display.urgent { color:var(--danger); animation:timerPulse 0.5s infinite; }

        /* Question box */
        .question-box {
            background:var(--card-bg); border:1px solid var(--border2);
            border-radius:var(--radius-lg); padding:22px 20px;
            box-shadow:var(--shadow);
        }
        .question-progress {
            display:flex; justify-content:space-between; align-items:center;
            margin-bottom:14px; font-size:0.82em; color:var(--text2);
        }
        .progress-bar {
            flex:1; height:5px; background:var(--surface);
            border-radius:3px; margin:0 10px; overflow:hidden;
        }
        .progress-fill {
            height:100%;
            background:linear-gradient(90deg, var(--primary), var(--secondary));
            background-size:200% auto;
            animation:shimmer 2.5s linear infinite;
            transition:width 0.4s ease;
        }
        .level-badge {
            background:var(--surface); border:1px solid var(--border2);
            color:var(--text2); padding:4px 10px; border-radius:20px;
            font-size:0.78em; font-weight:700; margin-bottom:14px;
            display:inline-block;
        }
        .question-text {
            font-size:1.2em; font-weight:800; color:var(--text);
            line-height:1.4;
        }

        /* Options â€” chips con prefijo A/B/C/D */
        .options { display:flex; flex-direction:column; gap:9px; }
        .option-btn {
            background:var(--card-bg); border:1.5px solid var(--border2);
            padding:0; border-radius:var(--radius);
            cursor:pointer; font-size:0.97em; font-weight:700;
            color:var(--text); transition:all 0.22s; text-align:left;
            display:flex; align-items:center; gap:0; overflow:hidden;
        }
        .option-btn:hover:not(:disabled) {
            border-color:var(--primary); background:var(--card-bg2);
            transform:translateX(5px);
        }
        .option-btn:disabled { cursor:not-allowed; opacity:0.85; }

        /* Prefijo A/B/C/D */
        .option-letter {
            min-width:42px; height:100%; padding:13px 0;
            background:var(--surface); border-right:1.5px solid var(--border);
            text-align:center; font-weight:900; font-size:0.9em;
            color:var(--text2); flex-shrink:0;
            display:flex; align-items:center; justify-content:center;
        }
        .option-text {
            padding:13px 14px; flex:1; line-height:1.3;
        }
        .option-btn.correct { background:rgba(46,204,113,0.15); border-color:#2ECC71; }
        .option-btn.correct .option-letter { background:rgba(46,204,113,0.3); color:#2ECC71; }
        .option-btn.correct .option-text   { color:#2ECC71; }
        .option-btn.incorrect { background:rgba(255,71,87,0.12); border-color:var(--danger); }
        .option-btn.incorrect .option-letter { background:rgba(255,71,87,0.25); color:var(--danger); }
        .option-btn.incorrect .option-text   { color:#FF6B7A; }
        .option-btn.correct { animation:glowPulse 0.5s ease-out 2; }

        /* Stagger animation */
        .option-btn.stagger-0 { animation:optionStagger 0.22s ease-out both; }
        .option-btn.stagger-1 { animation:optionStagger 0.22s ease-out 0.07s both; }
        .option-btn.stagger-2 { animation:optionStagger 0.22s ease-out 0.14s both; }
        .option-btn.stagger-3 { animation:optionStagger 0.22s ease-out 0.21s both; }

        /* Feedback */
        .answer-feedback {
            background:var(--card-bg); border-radius:var(--radius);
            padding:14px 18px; border-left:4px solid var(--primary);
            display:none; animation:slideIn 0.3s;
        }
        .answer-feedback.show { display:flex; align-items:center; gap:12px; }
        .answer-feedback.correct-fb   { border-color:var(--success); background:rgba(46,204,113,0.08); }
        .answer-feedback.incorrect-fb { border-color:var(--danger);  background:rgba(255,71,87,0.08); }
        .feedback-emoji   { font-size:1.7em; flex-shrink:0; }
        .feedback-text    { font-weight:800; color:var(--text); font-size:0.93em; }
        .feedback-explanation { font-size:0.8em; color:var(--text2); margin-top:3px; }
        .feedback-points  { font-weight:900; color:var(--primary); margin-left:auto; font-size:1.1em; flex-shrink:0; }

        /* Game footer */
        .game-footer { display:flex; gap:10px; padding-top:4px; }
        .btn-small {
            flex:1; padding:14px; border:none; border-radius:var(--radius);
            font-weight:800; cursor:pointer; transition:all 0.25s;
            font-size:0.95em; font-family:inherit;
        }
        .btn-next {
            background:linear-gradient(135deg, var(--primary), var(--primary-dk));
            color:#0B1426;
            box-shadow:0 4px 16px rgba(0,212,170,0.35);
        }
        .btn-next:hover { transform:translateY(-2px); box-shadow:0 6px 22px rgba(0,212,170,0.5); }
        .btn-menu { background:var(--card-bg); color:var(--text2); border:1px solid var(--border2); }
        .btn-menu:hover { background:var(--card-bg2); color:white; }
        .btn-danger { background:var(--danger); color:white; }

        /* Shake on wrong */
        .shake { animation:shake 0.4s ease-out; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESULTS SCREEN
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .results-screen { flex:1; flex-direction:column; padding-bottom:20px; }
        .results-card {
            background:linear-gradient(145deg, var(--card-bg) 0%, var(--card-bg2) 100%);
            border:1px solid var(--border2);
            border-radius:var(--radius-xl); padding:28px 24px;
            text-align:center;
            box-shadow:var(--shadow-lg);
            animation:popIn 0.6s cubic-bezier(0.34,1.56,0.64,1);
        }
        .results-card.perfect {
            border-color:rgba(255,215,0,0.5);
            box-shadow:var(--shadow-lg), var(--glow-gold);
        }
        .rank-emoji {
            font-size:4.5em; margin-bottom:8px; display:block;
            filter:drop-shadow(0 4px 12px rgba(255,215,0,0.4));
        }
        .rank-name {
            font-size:1.25em; font-weight:900; color:white; margin-bottom:22px;
        }

        .results-stats {
            display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:22px;
        }
        .stat-item {
            background:var(--dark2); border:1px solid var(--border);
            border-radius:var(--radius-lg); padding:16px 12px; text-align:center;
        }
        .stat-value { font-size:1.9em; font-weight:900; color:var(--primary); }
        .stat-label { font-size:0.72em; color:var(--text2); font-weight:700; margin-top:4px; letter-spacing:0.5px; }
        .stat-item.highlight .stat-value { color:var(--secondary); }

        /* Unlock section */
        .unlock-section {
            background:linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,140,0,0.08));
            border:2px solid rgba(255,215,0,0.4);
            border-radius:var(--radius-lg); padding:18px;
            margin-bottom:18px; animation:unlockAnim 0.8s ease-out;
            box-shadow:var(--glow-gold);
        }
        .unlock-title { font-weight:700; color:var(--secondary); margin-bottom:12px; font-size:0.9em; }
        .unlock-player { display:flex; align-items:center; gap:14px; }
        .unlock-avatar {
            width:62px; height:62px; border-radius:50%;
            background:linear-gradient(135deg, var(--primary), var(--secondary));
            display:flex; align-items:center; justify-content:center; font-size:1.5em;
            overflow:hidden; border:3px solid var(--secondary);
            box-shadow:0 0 16px rgba(255,215,0,0.4); flex-shrink:0;
        }
        .unlock-avatar img { width:100%; height:100%; object-fit:cover; }
        .unlock-info { text-align:left; }
        .unlock-name { font-weight:900; color:white; font-size:1.1em; margin-bottom:4px; }

        /* Rarity badges */
        .unlock-rarity {
            font-size:0.78em; font-weight:700; padding:3px 10px; border-radius:12px; display:inline-block;
        }
        .rarity-bronce   { background:rgba(205,127,50,0.2); color:#CD7F32; border:1px solid rgba(205,127,50,0.4); }
        .rarity-plata    { background:rgba(192,192,192,0.15); color:#C0C0C0; border:1px solid rgba(192,192,192,0.3); }
        .rarity-oro      { background:rgba(255,215,0,0.15); color:#FFD700; border:1px solid rgba(255,215,0,0.35); }
        .rarity-diamante { background:rgba(0,188,212,0.15); color:#00BCD4; border:1px solid rgba(0,188,212,0.35); }
        .rarity-leyenda  { background:linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,69,0,0.2)); color:#FFB400; border:1px solid rgba(255,165,0,0.5); }

        /* Rarity dots */
        .rarity-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
        .rarity-dot.bronce   { background:#CD7F32; }
        .rarity-dot.plata    { background:#C0C0C0; }
        .rarity-dot.oro      { background:#FFD700; }
        .rarity-dot.diamante { background:#00BCD4; }
        .rarity-dot.leyenda  { background:linear-gradient(135deg, #FFD700, #FF4500); }

        /* Duel result section */
        .duel-result-section {
            background:var(--dark2); border:1px solid var(--border);
            border-radius:var(--radius-lg); padding:22px; margin-bottom:18px;
            text-align:center; display:none; animation:popIn 0.6s;
        }
        .duel-result-section.show { display:block; }
        .duel-result-emoji { font-size:4em; margin-bottom:8px; }
        .duel-result-title { font-size:1.5em; font-weight:900; margin-bottom:8px; }
        .duel-result-title.win  { color:var(--secondary); }
        .duel-result-title.lose { color:var(--danger); }
        .duel-result-title.draw { color:var(--text2); }
        .duel-score-comparison { display:flex; justify-content:center; gap:18px; margin:14px 0; }
        .duel-score-box { background:var(--surface); border-radius:var(--radius); padding:10px 18px; text-align:center; border:1px solid var(--border); }
        .duel-score-box-val   { font-size:1.6em; font-weight:900; color:white; }
        .duel-score-box-label { font-size:0.75em; color:var(--text2); margin-top:2px; }

        .results-buttons { display:flex; flex-direction:column; gap:10px; margin-top:4px; }
        .results-buttons .btn { margin-top:0; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TEAM / FIELD
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .team-header { text-align:center; margin-bottom:10px; }
        .team-header h2 { font-size:1.25em; color:white; margin-bottom:3px; font-weight:900; }
        .team-header p  { color:var(--text2); font-size:0.78em; }

        .field {
            background:linear-gradient(180deg, #1a6b30 0%, #156025 45%, #1a6b30 100%);
            border:2px solid rgba(255,255,255,0.22); border-radius:var(--radius-lg);
            padding:18px 10px 22px; margin-bottom:12px;
            display:flex; flex-direction:column;
            gap:14px; position:relative; overflow:hidden;
            box-shadow:0 8px 32px rgba(0,0,0,0.55);
        }
        /* Franjas de cÃ©sped */
        .field::before {
            content:''; position:absolute; inset:0;
            background:repeating-linear-gradient(180deg,
                rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 36px,
                transparent 36px, transparent 72px);
            pointer-events:none;
        }
        /* CÃ­rculo central + lÃ­nea media */
        .field::after {
            content:''; position:absolute; left:50%; top:50%;
            transform:translate(-50%,-50%);
            width:54px; height:54px;
            border:2px solid rgba(255,255,255,0.18);
            border-radius:50%; pointer-events:none;
            box-shadow:0 0 0 1px rgba(255,255,255,0.06);
        }
        .field-midline {
            position:absolute; left:0; right:0; top:50%; height:1px;
            background:rgba(255,255,255,0.1); pointer-events:none;
        }

        /* Etiqueta de lÃ­nea (PORTERO, DEFENSA, etc.) */
        .field-line-label {
            width:100%; text-align:center; font-size:0.58em;
            color:rgba(255,255,255,0.38); letter-spacing:2px;
            text-transform:uppercase; margin-bottom:-8px; position:relative; z-index:1;
        }

        .field-row { display:flex; justify-content:center; align-items:flex-start; gap:10px; position:relative; z-index:1; }

        .player-slot {
            width:58px; height:58px; border-radius:50%;
            background:rgba(255,255,255,0.1);
            border:2px dashed rgba(255,255,255,0.35);
            display:flex; align-items:center; justify-content:center;
            cursor:pointer; transition:all 0.22s; font-size:1.2em; flex-direction:column;
            position:relative; overflow:hidden;
            box-shadow:0 3px 10px rgba(0,0,0,0.35);
        }
        .player-slot:hover { transform:scale(1.12); background:rgba(0,212,170,0.25); border-color:var(--primary); box-shadow:0 0 14px rgba(0,212,170,0.4); }
        .player-slot.filled { border:2px solid rgba(255,255,255,0.5); background:rgba(0,0,0,0.28); }
        .player-slot img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
        .slot-wrap { display:flex; flex-direction:column; align-items:center; gap:4px; }
        .slot-name {
            font-size:0.6em; color:rgba(255,255,255,0.9);
            font-weight:800; white-space:nowrap; text-shadow:0 1px 4px rgba(0,0,0,1);
            text-align:center; max-width:62px; line-height:1.1;
            min-height:12px; overflow:hidden; text-overflow:ellipsis;
        }
        .team-value-bar {
            background:var(--card-bg); border:1px solid var(--border);
            border-radius:var(--radius); padding:9px 14px;
            display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;
        }
        .team-value-bar span { color:var(--text2); font-weight:600; font-size:0.82em; }
        .team-value-num { font-weight:900; color:var(--secondary); font-size:1em; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PLAYER SELECT MODAL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #playerModal {
            display:none; position:fixed; inset:0;
            background:rgba(0,0,0,0.75); z-index:100;
            justify-content:center; align-items:flex-end;
            animation:fadeIn 0.2s;
        }
        #playerModal.open { display:flex; }
        .modal-sheet {
            background:var(--card-bg); border:1px solid var(--border2);
            border-radius:var(--radius-xl) var(--radius-xl) 0 0;
            width:100%; max-width:500px; max-height:70vh;
            overflow:hidden; display:flex; flex-direction:column;
            animation:slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1);
        }
        .modal-header {
            padding:18px 20px 12px; border-bottom:1px solid var(--border);
            display:flex; justify-content:space-between; align-items:center;
        }
        .modal-title { font-weight:900; color:white; font-size:1.05em; }
        .modal-close {
            background:var(--surface); border:1px solid var(--border);
            border-radius:8px; font-size:1.1em; cursor:pointer; color:var(--text2);
            width:32px; height:32px; display:flex; align-items:center; justify-content:center;
        }
        .modal-grid {
            display:grid; grid-template-columns:repeat(auto-fill, minmax(90px, 1fr));
            gap:10px; padding:14px; overflow-y:auto; flex:1;
        }
        .modal-player-card {
            background:var(--card-bg2); border:1px solid var(--border);
            border-radius:var(--radius); padding:10px 6px;
            text-align:center; cursor:pointer; transition:all 0.22s;
        }
        .modal-player-card:hover { border-color:var(--primary); transform:translateY(-3px); }
        .modal-player-avatar {
            width:50px; height:50px; border-radius:50%; margin:0 auto 6px;
            background:linear-gradient(135deg, var(--primary), var(--secondary));
            overflow:hidden;
        }
        .modal-player-avatar img { width:100%; height:100%; object-fit:cover; }
        .modal-player-name { font-size:0.7em; font-weight:700; color:var(--text); line-height:1.2; }
        .modal-player-rating { font-size:0.68em; color:var(--text2); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CATALOG
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .catalog-header { text-align:center; margin-bottom:14px; }
        .catalog-header h2 { font-size:1.4em; color:white; margin-bottom:4px; }
        .catalog-filters {
            display:flex; gap:7px; overflow-x:auto; padding-bottom:10px;
            margin-bottom:10px; scrollbar-width:none;
        }
        .catalog-filters::-webkit-scrollbar { display:none; }
        .filter-btn {
            background:var(--surface); color:var(--text2);
            border:1px solid var(--border2);
            padding:7px 14px; border-radius:20px; cursor:pointer;
            font-size:0.78em; font-weight:700; white-space:nowrap; transition:all 0.2s;
            font-family:inherit;
        }
        .filter-btn.active, .filter-btn:hover { background:var(--primary); border-color:var(--primary); color:#0B1426; }

        .players-grid {
            display:grid; grid-template-columns:repeat(auto-fill, minmax(100px, 1fr));
            gap:10px; overflow-y:auto; flex:1;
        }
        .player-card {
            background:var(--card-bg); border:1px solid var(--border2);
            border-radius:var(--radius); overflow:hidden;
            box-shadow:var(--shadow); cursor:pointer; transition:all 0.25s; position:relative;
        }
        .player-card:hover { transform:translateY(-4px); border-color:var(--primary); box-shadow:0 8px 20px rgba(0,0,0,0.4); }
        .player-card.locked { filter:grayscale(0.6) brightness(0.7); }
        .player-img {
            width:100%; height:90px;
            display:flex; align-items:center; justify-content:center; overflow:hidden;
        }
        .player-img img { width:100%; height:100%; object-fit:cover; }
        .player-info { padding:6px 8px 8px; }
        .player-name-card { font-size:0.76em; font-weight:700; color:var(--text); margin-bottom:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .player-meta { display:flex; justify-content:space-between; align-items:center; }
        .player-rating-card { font-size:0.7em; color:var(--text2); font-weight:700; }
        .lock-overlay {
            position:absolute; top:0; left:0; right:0; bottom:0;
            background:rgba(0,0,0,0.5); display:flex; align-items:center;
            justify-content:center; font-size:1.4em; border-radius:var(--radius);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LEADERBOARD
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .leaderboard-header { text-align:center; margin-bottom:18px; }
        .leaderboard-header h2 { font-size:1.4em; color:white; }
        .leaderboard-tabs {
            display:flex; gap:6px; margin-bottom:14px;
            background:var(--dark2); border-radius:var(--radius); padding:5px;
            border:1px solid var(--border);
        }
        .lb-tab {
            flex:1; padding:10px; border:none; background:transparent; cursor:pointer;
            font-weight:700; color:var(--text2); transition:all 0.3s; border-radius:9px;
            font-size:0.85em; font-family:inherit;
        }
        .lb-tab.active { background:var(--card-bg2); color:var(--primary); }
        .lb-list { display:flex; flex-direction:column; gap:8px; flex:1; overflow-y:auto; }
        .lb-entry {
            background:var(--card-bg); border:1px solid var(--border);
            border-radius:var(--radius); padding:13px 15px;
            display:flex; align-items:center; gap:12px;
            animation:slideIn 0.3s;
        }
        .lb-rank { font-size:1.05em; font-weight:900; min-width:28px; text-align:center; color:var(--text2); }
        .lb-rank.top1 { color:#FFD700; }
        .lb-rank.top2 { color:#C0C0C0; }
        .lb-rank.top3 { color:#CD7F32; }
        .lb-name { font-weight:700; color:var(--text); flex:1; font-size:0.92em; }
        .lb-score { font-weight:900; color:var(--primary); font-size:0.98em; }
        .lb-meta { font-size:0.73em; color:var(--text2); margin-top:2px; }
        .lb-view-btn {
            background:var(--primary); color:#0B1426; border:none; border-radius:8px;
            padding:6px 12px; font-size:0.76em; font-weight:800; cursor:pointer;
            white-space:nowrap; transition:background 0.2s; flex-shrink:0;
        }
        .lb-view-btn:hover { background:var(--secondary); }
        .lb-view-btn.own { background:var(--surface); color:var(--text2); cursor:default; }

        /* Ver equipo ajeno */
        #viewTeamScreen .team-header h2 span { font-size:0.7em; opacity:0.8; font-weight:500; }
        .view-team-value-bar {
            display:flex; justify-content:space-between; align-items:center;
            background:var(--card-bg); border-radius:var(--radius);
            padding:9px 14px; margin-bottom:10px; font-size:0.82em; border:1px solid var(--border);
        }
        .view-team-value-bar span { color:var(--text2); }
        .view-team-value-num { font-weight:900; font-size:1em; color:var(--secondary); }
        #viewTeamScreen .player-slot { cursor:default!important; pointer-events:none; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           COMPLETA EL XI
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #xiScreen { padding:10px 0; }
        .xi-header { text-align:center; color:white; margin-bottom:10px; }
        .xi-header h2 { font-size:1.4em; margin-bottom:4px; }
        .xi-header p  { font-size:0.85em; color:var(--text2); }
        .xi-meta { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-bottom:12px; }
        .xi-badge {
            background:var(--surface); color:var(--text2); border:1px solid var(--border);
            border-radius:20px; padding:4px 12px; font-size:0.8em; font-weight:700;
        }
        .xi-badge.diff-fÃ¡cil   { background:rgba(46,204,113,0.2); color:#2ECC71; border-color:rgba(46,204,113,0.4); }
        .xi-badge.diff-medio   { background:rgba(255,215,0,0.15); color:#FFD700; border-color:rgba(255,215,0,0.3); }
        .xi-badge.diff-difÃ­cil { background:rgba(255,71,87,0.15); color:#FF6B7A; border-color:rgba(255,71,87,0.3); }

        .xi-field {
            background:linear-gradient(180deg, #1a6b30 0%, #156025 50%, #0d4a1a 100%);
            border-radius:var(--radius-lg); border:2px solid rgba(255,255,255,0.25);
            padding:16px 10px; display:flex; flex-direction:column;
            gap:10px; position:relative; overflow:hidden;
            box-shadow:0 8px 32px rgba(0,0,0,0.5);
        }
        .xi-field::before {
            content:''; position:absolute; inset:0;
            background:repeating-linear-gradient(180deg,
                rgba(255,255,255,0.035) 0px, rgba(255,255,255,0.035) 40px,
                transparent 40px, transparent 80px);
            pointer-events:none;
        }
        .xi-field::after {
            content:''; position:absolute; left:50%; top:50%;
            transform:translate(-50%,-50%);
            width:70px; height:70px; border:2px solid rgba(255,255,255,0.2);
            border-radius:50%; pointer-events:none;
        }
        .xi-line { display:flex; justify-content:center; gap:8px; flex-wrap:wrap; position:relative; z-index:1; }
        .xi-line-label {
            width:100%; text-align:center; font-size:0.62em;
            color:rgba(255,255,255,0.45); letter-spacing:2px;
            text-transform:uppercase; margin-bottom:-4px;
        }
        .xi-slot { display:flex; flex-direction:column; align-items:center; gap:4px; width:76px; }
        .xi-slot-circle {
            width:52px; height:52px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            font-size:1.2em; border:2px solid rgba(255,255,255,0.5);
            box-shadow:0 2px 8px rgba(0,0,0,0.4); transition:all 0.3s;
            overflow:hidden; position:relative; background:rgba(255,255,255,0.12);
        }
        .xi-slot-circle img.player-photo {
            width:100%; height:100%; object-fit:cover;
            object-position:top center; border-radius:50%; display:block;
        }
        .xi-slot.known  .xi-slot-circle { border-color:rgba(255,255,255,0.65); }
        .xi-slot.hidden .xi-slot-circle { background:rgba(0,0,0,0.45); border-style:dashed; cursor:pointer; }
        .xi-slot.hidden .xi-slot-circle img.player-photo { display:none; }
        .xi-slot.correct .xi-slot-circle { border:3px solid #2ECC71; box-shadow:0 0 12px rgba(46,204,113,0.6); }
        .xi-slot.wrong   .xi-slot-circle { border:3px solid var(--danger); box-shadow:0 0 12px rgba(255,71,87,0.6); }
        .xi-slot-icon { position:absolute; font-size:1.4em; pointer-events:none; }
        .xi-slot-name {
            font-size:0.64em; color:white; text-align:center;
            font-weight:700; text-shadow:0 1px 4px rgba(0,0,0,0.9);
            max-width:76px; line-height:1.2; min-height:24px;
        }

        /* XI input modal */
        .xi-input-modal { display:none; position:fixed; inset:0; z-index:300; background:rgba(0,0,0,0.7); align-items:flex-end; justify-content:center; }
        .xi-input-modal.show { display:flex; }
        .xi-input-sheet {
            background:var(--card-bg); border:1px solid var(--border2);
            border-radius:var(--radius-xl) var(--radius-xl) 0 0;
            padding:24px; width:100%; max-width:500px; animation:slideUp 0.25s;
        }
        .xi-input-sheet h3 { margin-bottom:8px; color:white; font-size:1em; }
        .xi-input-sheet p  { margin-bottom:14px; color:var(--text2); font-size:0.85em; }
        .xi-text-input {
            width:100%; padding:14px 16px; background:var(--dark2);
            border:1.5px solid var(--border2); border-radius:var(--radius);
            color:var(--text); font-size:1em; margin-bottom:12px;
            outline:none; transition:border 0.2s; font-family:inherit;
        }
        .xi-text-input:focus { border-color:var(--primary); }
        .xi-text-input::placeholder { color:var(--text3); }
        .xi-input-actions { display:flex; gap:10px; }
        .xi-confirm-btn {
            flex:1; padding:13px; background:var(--primary); color:#0B1426; border:none;
            border-radius:var(--radius); font-size:1em; font-weight:800; cursor:pointer; font-family:inherit;
        }
        .xi-cancel-btn {
            padding:13px 18px; background:var(--surface); color:var(--text2); border:1px solid var(--border);
            border-radius:var(--radius); font-size:1em; cursor:pointer; font-family:inherit;
        }

        /* XI timer */
        .xi-timer-bar { background:rgba(255,255,255,0.08); border-radius:20px; height:8px; margin-bottom:8px; overflow:hidden; }
        .xi-timer-fill { height:100%; border-radius:20px; width:100%; background:linear-gradient(90deg, var(--primary), var(--secondary)); transition:width 1s linear, background 1s linear; }
        .xi-timer-fill.warning { background:linear-gradient(90deg, var(--danger), var(--accent)); }
        .xi-timer-label { text-align:center; font-size:0.88em; font-weight:800; color:white; margin-bottom:8px; letter-spacing:1px; }
        .xi-timer-label.warning { color:#FFD700; animation:timerPulse 0.6s infinite; }
        .xi-timer-label.expired { color:var(--danger); }

        .xi-actions { display:flex; gap:10px; margin-top:14px; }
        .xi-check-btn {
            flex:1; padding:14px; background:var(--secondary); color:#0B1426;
            border:none; border-radius:var(--radius-lg); font-size:1em; font-weight:900;
            cursor:pointer; transition:transform 0.1s; font-family:inherit;
        }
        .xi-check-btn:active { transform:scale(0.97); }
        .xi-next-btn {
            flex:1; padding:14px; background:var(--primary); color:#0B1426;
            border:none; border-radius:var(--radius-lg); font-size:1em; font-weight:900;
            cursor:pointer; display:none; font-family:inherit;
        }

        .xi-result-card {
            background:var(--card-bg); border:1px solid var(--border2);
            border-radius:var(--radius-lg); padding:18px; margin-top:14px;
            display:none; animation:popIn 0.4s;
        }
        .xi-result-card.show { display:block; }
        .xi-result-score { font-size:2em; font-weight:900; color:var(--primary); text-align:center; }
        .xi-result-detail { font-size:0.85em; color:var(--text2); text-align:center; margin-bottom:12px; }
        .xi-result-rows { display:flex; flex-direction:column; gap:6px; }
        .xi-result-row {
            display:flex; align-items:center; gap:8px;
            padding:8px 12px; border-radius:10px; font-size:0.85em;
        }
        .xi-result-row.ok   { background:rgba(46,204,113,0.12); }
        .xi-result-row.fail { background:rgba(255,71,87,0.1); }
        .xi-result-row .slot-label { font-weight:700; min-width:50px; color:var(--text2); }
        .xi-result-row .answer-given { color:var(--text2); flex:1; }
        .xi-result-row .correct-ans  { font-weight:700; }
        .xi-result-row.ok   .correct-ans { color:#2ECC71; }
        .xi-result-row.fail .correct-ans { color:#FF6B7A; }
        .result-row-photo { width:36px; height:36px; border-radius:50%; object-fit:cover; object-position:top center; flex-shrink:0; border:2px solid var(--border); }
        .xi-curiosity {
            background:linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2));
            border:1px solid rgba(102,126,234,0.3);
            color:var(--text); border-radius:var(--radius-lg); padding:14px; margin-top:12px;
            font-size:0.85em; line-height:1.5;
        }
        .xi-curiosity strong { display:block; margin-bottom:4px; color:var(--primary); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LEAGUE SYSTEM
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .league-banner {
            background:linear-gradient(135deg, var(--dark2), var(--dark3));
            border:1px solid rgba(255,215,0,0.3);
            border-radius:var(--radius-lg); padding:14px 16px; margin-bottom:14px;
            display:flex; align-items:center; gap:12px;
            cursor:pointer; transition:all 0.3s;
            box-shadow:0 4px 16px rgba(0,0,0,0.3);
            position:relative; overflow:hidden;
        }
        .league-banner::before {
            content:''; position:absolute; top:-50%; right:-20px;
            width:100px; height:200%; background:rgba(255,215,0,0.03);
            transform:rotate(20deg);
        }
        .league-banner:hover { transform:translateY(-2px); border-color:rgba(255,215,0,0.6); box-shadow:var(--glow-gold); }
        .league-emblem { font-size:2em; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .league-info { flex:1; }
        .league-name { color:var(--secondary); font-weight:800; font-size:0.95em; margin-bottom:4px; }
        .league-progress-row { display:flex; align-items:center; gap:8px; }
        .league-progress-bar { flex:1; height:7px; background:rgba(255,255,255,0.1); border-radius:10px; overflow:hidden; }
        .league-progress-fill { height:100%; border-radius:10px; background:linear-gradient(90deg, var(--secondary), var(--accent)); transition:width 0.8s cubic-bezier(0.4,0,0.2,1); }
        .league-wins-label { color:var(--text2); font-size:0.73em; white-space:nowrap; }
        .league-arrow { color:var(--text3); font-size:1.2em; }

        #leagueScreen { padding:10px 0; }
        .league-screen-header { text-align:center; color:white; margin-bottom:18px; }
        .league-screen-header h2 { font-size:1.5em; margin-bottom:4px; }
        .current-division-card {
            background:linear-gradient(135deg, var(--dark2), var(--dark3));
            border:2px solid rgba(255,215,0,0.4); border-radius:var(--radius-xl);
            padding:28px; text-align:center; margin-bottom:18px;
            box-shadow:0 0 30px rgba(255,215,0,0.12);
        }
        .division-emoji { font-size:4em; margin-bottom:10px; display:block; }
        .division-title { font-size:1.7em; font-weight:900; color:var(--secondary); margin-bottom:6px; }
        .division-sub { color:var(--text2); font-size:0.88em; margin-bottom:18px; }
        .division-stats { display:flex; gap:12px; justify-content:center; margin-bottom:18px; flex-wrap:wrap; }
        .div-stat { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:12px 16px; text-align:center; }
        .div-stat-val { font-size:1.6em; font-weight:900; color:white; }
        .div-stat-val.green { color:var(--success); }
        .div-stat-val.red   { color:var(--danger); }
        .div-stat-label { font-size:0.7em; color:var(--text2); margin-top:2px; }
        .division-progress-big { background:rgba(255,255,255,0.08); border-radius:20px; height:12px; overflow:hidden; margin-bottom:8px; }
        .division-progress-big-fill { height:100%; border-radius:20px; background:linear-gradient(90deg, var(--secondary), var(--accent)); transition:width 1s cubic-bezier(0.4,0,0.2,1); }
        .division-progress-label { font-size:0.8em; color:var(--text2); text-align:center; }
        .league-ladder { display:flex; flex-direction:column; gap:7px; margin-bottom:18px; }
        .ladder-row {
            background:var(--surface); border:1px solid var(--border);
            border-radius:var(--radius); padding:11px 15px;
            display:flex; align-items:center; gap:12px; transition:all 0.2s;
        }
        .ladder-row.current { background:rgba(255,215,0,0.1); border-color:rgba(255,215,0,0.35); }
        .ladder-row.locked  { opacity:0.45; }
        .ladder-div-num { font-size:1.1em; min-width:28px; text-align:center; }
        .ladder-div-name { flex:1; color:white; font-weight:600; font-size:0.88em; }
        .ladder-badge { font-size:0.7em; padding:3px 8px; border-radius:10px; background:var(--surface); color:var(--text2); }
        .ladder-badge.current-badge { background:var(--secondary); color:#0B1426; font-weight:800; }

        .promotion-toast {
            position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
            background:linear-gradient(135deg, var(--secondary), var(--accent));
            color:#0B1426; font-weight:900; font-size:1.3em;
            padding:20px 34px; border-radius:var(--radius-xl); z-index:500;
            text-align:center; display:none;
            box-shadow:0 10px 40px rgba(255,165,0,0.5);
        }
        .promotion-toast.show { display:block; animation:promotionAnim 0.6s ease-out; }
        .relegation-toast {
            position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
            background:linear-gradient(135deg, var(--danger), #C0392B);
            color:white; font-weight:900; font-size:1.3em;
            padding:20px 34px; border-radius:var(--radius-xl); z-index:500;
            text-align:center; display:none;
            box-shadow:0 10px 40px rgba(231,76,60,0.5);
        }
        .relegation-toast.show { display:block; animation:promotionAnim 0.6s ease-out; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ENERGY MODAL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .energy-modal { display:none; position:fixed; inset:0; z-index:400; background:rgba(0,0,0,0.75); align-items:center; justify-content:center; backdrop-filter:blur(4px); }
        .energy-modal.show { display:flex; }
        .energy-modal-card {
            background:var(--card-bg); border:1px solid var(--border2);
            border-radius:var(--radius-xl); padding:32px 28px;
            max-width:340px; width:92%; text-align:center;
            animation:popIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
        }
        .energy-modal-card h2 { font-size:1.4em; color:white; margin-bottom:8px; }
        .energy-modal-card p  { color:var(--text2); font-size:0.88em; margin-bottom:18px; }
        .energy-timer { font-size:1.8em; font-weight:900; color:var(--primary); margin-bottom:18px; }
        .energy-hearts-big { font-size:2em; letter-spacing:4px; margin-bottom:18px; }
        .energy-modal-btns { display:flex; flex-direction:column; gap:10px; }
        .btn-ad-watch {
            background:linear-gradient(135deg, var(--accent), #FF8C42);
            color:white; border:none; padding:14px; border-radius:var(--radius);
            font-size:1em; font-weight:800; cursor:pointer; font-family:inherit;
        }
        .btn-energy-close {
            background:var(--surface); color:var(--text2); border:1px solid var(--border);
            padding:12px; border-radius:var(--radius); font-size:0.9em; cursor:pointer; font-family:inherit;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DAILY REWARD MODAL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .daily-modal { display:none; position:fixed; inset:0; z-index:450; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; }
        .daily-modal.show { display:flex; }
        .daily-modal-card {
            background:linear-gradient(145deg, var(--dark2), var(--dark3));
            border:2px solid rgba(255,215,0,0.35); border-radius:var(--radius-xl);
            padding:30px 24px; max-width:360px; width:92%; text-align:center;
            animation:popIn 0.5s cubic-bezier(0.34,1.56,0.64,1);
        }
        .daily-modal-card h2 { color:var(--secondary); font-size:1.5em; margin-bottom:4px; }
        .daily-modal-card > p { color:var(--text2); font-size:0.85em; margin-bottom:18px; }
        .daily-streak-row { display:flex; justify-content:center; gap:6px; margin-bottom:16px; flex-wrap:wrap; }
        .day-bubble {
            width:36px; height:36px; border-radius:50%; border:2px solid var(--border);
            display:flex; align-items:center; justify-content:center;
            font-size:0.75em; font-weight:700; color:var(--text2);
            transition:all 0.3s;
        }
        .day-bubble.claimed { background:var(--success); border-color:var(--success); color:white; }
        .day-bubble.next    { background:var(--secondary); border-color:var(--secondary); color:#0B1426; transform:scale(1.2); box-shadow:0 0 14px rgba(255,215,0,0.5); }
        .daily-reward-big {
            background:rgba(255,215,0,0.08); border:2px solid rgba(255,215,0,0.3);
            border-radius:var(--radius-lg); padding:18px; margin-bottom:18px;
        }
        .daily-reward-emoji { font-size:3em; margin-bottom:8px; }
        .daily-reward-name  { color:var(--secondary); font-weight:800; font-size:1.2em; }
        .daily-reward-sub   { color:var(--text2); font-size:0.8em; margin-top:4px; }
        .btn-claim-daily {
            width:100%; padding:16px;
            background:linear-gradient(135deg, var(--secondary), var(--accent));
            color:#0B1426; border:none; border-radius:var(--radius-lg);
            font-size:1.05em; font-weight:900; cursor:pointer; transition:all 0.3s;
            box-shadow:0 5px 20px rgba(255,165,0,0.4); font-family:inherit;
        }
        .btn-claim-daily:hover { transform:translateY(-2px); box-shadow:0 8px 26px rgba(255,165,0,0.5); }
        .btn-claim-daily:disabled { background:var(--surface); color:var(--text2); cursor:not-allowed; box-shadow:none; transform:none; }
        .btn-daily-close { background:none; border:none; color:var(--text3); font-size:0.85em; cursor:pointer; margin-top:12px; padding:6px; font-family:inherit; }
        .daily-reward-glow { animation:glowGold 1s ease-in-out infinite; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PVP SCREEN â€” COMPACT MOBILE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #pvpScreen { padding:12px 14px 20px; }
        #pvpScreen .screen-title { font-size:1.3em; margin-bottom:2px; }
        #pvpScreen .screen-subtitle { font-size:0.75em; margin-bottom:10px; }

        /* Stats banner */
        .pvp-stats-banner {
            display:flex; gap:6px; margin-bottom:14px;
        }
        .pvp-stat-pill {
            flex:1; display:flex; flex-direction:column; align-items:center;
            gap:1px; padding:8px 4px;
            background:var(--card-bg); border:1px solid var(--border);
            border-radius:12px;
        }
        .pvp-stat-pill.wins  { border-color:rgba(0,200,83,0.35); background:rgba(0,200,83,0.07); }
        .pvp-stat-pill.losses{ border-color:rgba(255,68,68,0.35); background:rgba(255,68,68,0.07); }
        .pvp-stat-pill.total { border-color:rgba(155,48,255,0.35); background:rgba(155,48,255,0.07); }
        .pvp-stat-val {
            font-size:1.4em; font-weight:900; line-height:1;
        }
        .pvp-stat-val.green { color:#00C853; }
        .pvp-stat-val.red   { color:#FF4444; }
        .pvp-stat-val.purple{ color:#9b30ff; }
        .pvp-stat-label {
            font-size:0.65em; font-weight:700; color:var(--text3);
            text-transform:uppercase; letter-spacing:0.04em;
        }
        .pvp-stat-wr {
            font-size:0.6em; color:var(--text3); margin-top:1px;
        }

        /* Tabs pill */
        .pvp-tabs-bar {
            display:flex; gap:4px; margin-bottom:14px;
            background:var(--dark2); border-radius:12px; padding:3px;
        }
        .pvp-tab-btn {
            flex:1; padding:7px 4px; border-radius:10px; border:none;
            background:transparent; color:var(--text2); font-size:0.72em;
            font-weight:700; cursor:pointer; transition:all 0.2s; font-family:inherit;
            position:relative; white-space:nowrap;
        }
        .pvp-tab-btn.active {
            background:linear-gradient(135deg,#6a0dad,#9b30ff);
            color:white; box-shadow:0 2px 10px rgba(155,48,255,0.4);
        }
        .pvp-tab-badge {
            position:absolute; top:-2px; right:2px;
            background:#FF4444; color:white; border-radius:8px;
            padding:0 4px; font-size:0.7em; line-height:1.4;
            min-width:14px; text-align:center;
        }

        /* Secciones */
        .pvp-section { margin-bottom:12px; }
        .pvp-label {
            display:flex; align-items:center; gap:5px;
            color:var(--text2); font-size:0.75em; font-weight:700;
            margin-bottom:5px; text-transform:uppercase; letter-spacing:0.03em;
        }

        /* Input bÃºsqueda rival */
        .pvp-search-wrap { position:relative; }
        .pvp-input {
            width:100%; padding:9px 12px 9px 34px; border-radius:10px;
            border:1px solid var(--border2); background:var(--dark2);
            color:var(--text); font-size:0.88em; font-family:inherit;
            box-sizing:border-box;
        }
        .pvp-input:focus { outline:none; border-color:rgba(155,48,255,0.7); background:rgba(106,13,173,0.12); }
        .pvp-search-icon {
            position:absolute; left:10px; top:50%; transform:translateY(-50%);
            font-size:0.9em; pointer-events:none; opacity:0.5;
        }

        /* Resultado bÃºsqueda */
        .pvp-found-pill {
            display:flex; align-items:center; gap:8px; margin-top:6px;
            padding:7px 10px; background:rgba(0,200,83,0.1);
            border:1px solid rgba(0,200,83,0.3); border-radius:10px;
        }
        .pvp-found-pill .pf-avatar {
            width:26px; height:26px; border-radius:50%;
            background:linear-gradient(135deg,#9b30ff,#6a0dad);
            display:flex; align-items:center; justify-content:center;
            font-size:0.8em; font-weight:800; color:white; flex-shrink:0;
        }
        .pvp-found-pill .pf-name { font-weight:700; color:#00C853; font-size:0.85em; }
        .pvp-found-pill .pf-level { color:var(--text2); font-size:0.75em; margin-left:auto; }

        /* Apuesta chips */
        .pvp-wager-row {
            display:flex; gap:6px;
        }
        .pvp-wager-btn {
            flex:1; padding:7px 4px; border-radius:10px; border:1px solid var(--border);
            background:var(--surface); color:var(--text2); font-size:0.75em;
            font-weight:700; cursor:pointer; transition:all 0.2s; font-family:inherit;
            text-align:center;
        }
        .pvp-wager-btn.active {
            background:linear-gradient(135deg,rgba(106,13,173,0.6),rgba(155,48,255,0.4));
            color:white; border-color:rgba(155,48,255,0.6);
        }

        /* Input XP apuesta */
        .pvp-xp-row {
            display:flex; align-items:center; gap:8px; margin-top:6px;
        }
        .pvp-xp-row input {
            flex:1; padding:8px 10px; border-radius:10px;
            border:1px solid var(--border2); background:var(--dark2);
            color:var(--text); font-size:0.9em; font-family:inherit;
        }
        .pvp-xp-row input:focus { outline:none; border-color:rgba(155,48,255,0.7); }
        .pvp-xp-hint { font-size:0.72em; color:var(--text3); margin-top:3px; }

        /* Jugadores para apostar */
        #pvpPlayerPickList {
            display:grid; grid-template-columns:repeat(3,1fr); gap:6px;
            max-height:160px; overflow-y:auto; padding:6px;
            background:rgba(255,255,255,0.04); border-radius:10px;
            scrollbar-width:thin;
        }
        .pvp-player-chip {
            display:flex; flex-direction:column; align-items:center; gap:3px;
            padding:6px 4px; border-radius:10px; border:1px solid var(--border);
            background:var(--surface); cursor:pointer; transition:all 0.2s;
            font-size:0.7em; color:var(--text2); text-align:center;
        }
        .pvp-player-chip.selected {
            border-color:var(--secondary); background:rgba(255,215,0,0.12);
            color:var(--secondary);
        }
        .pvp-player-chip img { width:32px; height:32px; border-radius:50%; object-fit:cover; }
        .pvp-player-chip .chip-name {
            font-weight:700; overflow:hidden; text-overflow:ellipsis;
            white-space:nowrap; width:100%; text-align:center;
        }

        /* Jugador seleccionado preview */
        .pvp-selected-player {
            display:flex; align-items:center; gap:8px; margin-top:6px;
            padding:7px 10px; background:rgba(255,215,0,0.08);
            border:1px solid rgba(255,215,0,0.3); border-radius:10px;
        }
        .pvp-selected-player img { width:30px; height:30px; border-radius:50%; }
        .pvp-selected-player .sp-name { font-weight:700; color:var(--secondary); font-size:0.82em; }
        .pvp-selected-player .sp-rarity { font-size:0.7em; color:var(--text2); }

        /* BotÃ³n enviar desafÃ­o */
        .pvp-send-btn {
            width:100%; padding:11px; border-radius:12px; border:none;
            background:linear-gradient(135deg,#6a0dad,#9b30ff);
            color:white; font-weight:800; font-size:0.9em;
            cursor:pointer; font-family:inherit; margin-top:10px;
            box-shadow:0 4px 16px rgba(155,48,255,0.35);
            transition:all 0.2s;
        }
        .pvp-send-btn:active { transform:scale(0.97); }
        .pvp-send-result {
            margin-top:8px; padding:9px 12px; border-radius:10px;
            font-size:0.82em; text-align:center; display:none;
        }

        /* Cards desafÃ­os pendientes */
        .pvp-challenge-card {
            background:var(--card-bg); border:1px solid var(--border);
            border-radius:12px; padding:10px 12px; margin-bottom:8px;
            display:flex; flex-direction:column; gap:6px;
        }
        .pvp-card-top {
            display:flex; align-items:center; gap:8px;
        }
        .pvp-card-avatar {
            width:34px; height:34px; border-radius:50%;
            background:linear-gradient(135deg,#9b30ff,#6a0dad);
            display:flex; align-items:center; justify-content:center;
            font-size:1em; font-weight:800; color:white; flex-shrink:0;
        }
        .pvp-card-info { flex:1; min-width:0; }
        .pvp-card-name { font-weight:800; color:#9b30ff; font-size:0.88em; line-height:1.2; }
        .pvp-card-wager { color:var(--secondary); font-size:0.72em; margin-top:1px; }
        .pvp-card-time { font-size:0.7em; color:var(--text3); margin-left:auto; flex-shrink:0; }
        .pvp-challenge-btns { display:flex; gap:6px; }
        .pvp-accept-btn {
            flex:1; padding:7px; border-radius:10px; border:none;
            background:#00C853; color:white; font-weight:800;
            cursor:pointer; font-family:inherit; font-size:0.8em;
        }
        .pvp-reject-btn {
            flex:1; padding:7px; border-radius:10px; border:none;
            background:var(--danger); color:white; font-weight:700;
            cursor:pointer; font-family:inherit; font-size:0.8em;
        }

        /* En curso card */
        .pvp-active-card {
            background:var(--card-bg); border:1px solid var(--border);
            border-radius:12px; padding:10px 12px; margin-bottom:8px;
        }
        .pvp-active-vs {
            display:flex; align-items:center; justify-content:space-between;
            gap:8px; margin-bottom:8px;
        }
        .pvp-active-player { text-align:center; flex:1; }
        .pvp-active-player .ap-name { font-weight:700; font-size:0.8em; color:var(--text); }
        .pvp-active-player .ap-score { font-weight:800; font-size:1.2em; color:var(--primary-light); }
        .pvp-vs-badge {
            font-weight:900; font-size:0.85em; color:var(--text3);
            flex-shrink:0;
        }
        .pvp-active-wager {
            text-align:center; font-size:0.72em; color:var(--secondary); margin-bottom:8px;
        }
        .pvp-play-duel-btn {
            width:100%; padding:8px; border-radius:10px; border:none;
            background:linear-gradient(135deg,#FFD700,#FF8C00);
            color:#1a1a2e; font-weight:800; cursor:pointer;
            font-family:inherit; font-size:0.82em;
        }
        .pvp-active-actions { display:flex; flex-direction:column; gap:0; }

        /* Empty state */
        .pvp-empty {
            text-align:center; padding:24px 10px;
            color:var(--text3); font-size:0.82em;
        }
        .pvp-empty-icon { font-size:2.5em; margin-bottom:8px; opacity:0.5; }

        .rarity-lock-notice {
            background:rgba(255,215,0,0.07); border:1px solid rgba(255,215,0,0.2);
            border-radius:10px; padding:8px 12px; margin-bottom:10px;
            font-size:0.75em; color:var(--text2); line-height:1.5;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MATCHMAKING NOTIFICATION SYSTEM
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #matchmakingOverlay {
            display:none; position:fixed; inset:0; z-index:9999;
            background:rgba(6,13,31,0.85); backdrop-filter:blur(6px);
            align-items:flex-end; justify-content:center;
            padding-bottom:24px;
        }
        #matchmakingOverlay.active { display:flex; }
        .mm-sheet {
            background:var(--card-bg); border:1px solid var(--border);
            border-radius:22px 22px 16px 16px; padding:24px 20px 20px;
            width:100%; max-width:420px; box-shadow:0 -4px 40px rgba(0,0,0,0.6);
            animation:slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform:translateY(100%); opacity:0; }
            to   { transform:translateY(0);   opacity:1; }
        }
        .mm-drag-handle {
            width:40px; height:4px; background:var(--border);
            border-radius:2px; margin:0 auto 18px;
        }
        /* Estado: buscando */
        .mm-waiting { text-align:center; padding:10px 0 6px; }
        .mm-waiting-icon {
            font-size:3em; margin-bottom:10px;
            animation:mmPulse 1.5s ease-in-out infinite;
        }
        @keyframes mmPulse {
            0%,100% { transform:scale(1);   opacity:1; }
            50%      { transform:scale(1.12); opacity:0.7; }
        }
        .mm-waiting-title { font-size:1.15em; font-weight:800; color:var(--text); margin-bottom:6px; }
        .mm-waiting-sub { font-size:0.85em; color:var(--text2); margin-bottom:16px; }
        .mm-dots span {
            display:inline-block; width:8px; height:8px; border-radius:50%;
            background:var(--primary); margin:0 3px;
            animation:mmDot 1.2s ease-in-out infinite;
        }
        .mm-dots span:nth-child(2) { animation-delay:0.2s; }
        .mm-dots span:nth-child(3) { animation-delay:0.4s; }
        @keyframes mmDot {
            0%,80%,100% { transform:scale(0.6); opacity:0.4; }
            40%          { transform:scale(1.1); opacity:1; }
        }
        /* Estado: rival encontrado */
        .mm-matched { text-align:center; }
        .mm-matched-badge {
            display:inline-block; background:rgba(0,212,170,0.15);
            border:1px solid rgba(0,212,170,0.4); border-radius:20px;
            padding:3px 14px; font-size:0.75em; color:var(--primary);
            font-weight:700; margin-bottom:14px; text-transform:uppercase;
            letter-spacing:0.05em;
        }
        .mm-rival-row {
            display:flex; align-items:center; justify-content:center;
            gap:14px; margin:14px 0 18px;
        }
        .mm-avatar {
            width:56px; height:56px; border-radius:50%;
            background:linear-gradient(135deg,var(--primary),var(--primary-dk));
            display:flex; align-items:center; justify-content:center;
            font-size:1.6em; font-weight:900; color:var(--dark);
            border:2px solid var(--primary);
        }
        .mm-vs-sep { font-size:1.2em; font-weight:900; color:var(--text2); }
        .mm-rival-name {
            font-weight:800; font-size:1.05em; color:var(--text);
            margin-top:4px;
        }
        .mm-countdown-bar {
            background:var(--dark3); border-radius:4px; height:6px;
            margin:0 0 18px; overflow:hidden;
        }
        .mm-countdown-fill {
            height:100%; border-radius:4px;
            background:linear-gradient(90deg,var(--primary),var(--secondary));
            transition:width 0.9s linear;
        }
        .mm-countdown-label {
            font-size:0.78em; color:var(--text2); text-align:center;
            margin-bottom:18px;
        }
        .mm-actions { display:flex; gap:10px; }
        .mm-btn-accept {
            flex:1; padding:14px; border:none; border-radius:var(--radius);
            background:linear-gradient(135deg,var(--primary),var(--primary-dk));
            color:var(--dark); font-weight:900; font-size:1em;
            cursor:pointer; font-family:inherit; transition:opacity 0.2s;
        }
        .mm-btn-accept:active { opacity:0.8; }
        .mm-btn-reject {
            flex:1; padding:14px; border:none; border-radius:var(--radius);
            background:rgba(255,71,87,0.15); border:1px solid rgba(255,71,87,0.4);
            color:var(--danger); font-weight:800; font-size:0.95em;
            cursor:pointer; font-family:inherit; transition:all 0.2s;
        }
        .mm-btn-reject:active { background:rgba(255,71,87,0.25); }
        /* Estado: aceptado */
        .mm-accepted { text-align:center; padding:8px 0; }
        .mm-accepted-icon { font-size:3em; margin-bottom:8px; }
        .mm-accepted-title { font-size:1.1em; font-weight:800; color:var(--success); }
        .mm-accepted-sub { font-size:0.85em; color:var(--text2); margin-top:6px; }
        /* Estado: cancelado */
        .mm-cancelled { text-align:center; padding:8px 0; }
        .mm-cancelled-icon { font-size:2.5em; margin-bottom:8px; }
        .mm-cancelled-title { font-size:1em; font-weight:800; color:var(--danger); }
        .mm-cancelled-sub { font-size:0.82em; color:var(--text2); margin-top:6px; margin-bottom:14px; }

        /* Setup â€” configurar apuesta */
        .mm-setup-title { font-size:1.1em; font-weight:800; color:var(--text); margin-bottom:4px; }
        .mm-setup-sub   { font-size:0.82em; color:var(--text2); margin-bottom:16px; }
        .mm-wager-options { display:flex; gap:8px; margin-bottom:16px; }
        .mm-wager-opt {
            flex:1; padding:12px 8px; border-radius:var(--radius);
            border:1.5px solid var(--border); background:var(--dark3);
            color:var(--text2); font-weight:700; font-size:0.85em;
            cursor:pointer; text-align:center; transition:all 0.18s;
            font-family:inherit;
        }
        .mm-wager-opt.active {
            border-color:var(--primary); background:rgba(0,212,170,0.12);
            color:var(--primary);
        }
        .mm-wager-detail { margin-bottom:16px; min-height:64px; }
        .mm-wager-input {
            width:100%; padding:11px 14px; border-radius:var(--radius);
            border:1.5px solid var(--border); background:var(--dark3);
            color:var(--text); font-size:0.95em; font-family:inherit;
            box-sizing:border-box; transition:border 0.18s;
        }
        .mm-wager-input:focus { outline:none; border-color:var(--primary); }
        .mm-xp-hint { font-size:0.78em; color:var(--text2); margin-top:5px; }
        .mm-player-scroll {
            display:flex; flex-wrap:wrap; gap:7px; max-height:130px;
            overflow-y:auto; padding:6px;
            background:rgba(255,255,255,0.03); border-radius:var(--radius);
            border:1px solid var(--border);
        }
        .mm-player-chip {
            display:flex; align-items:center; gap:5px; padding:5px 9px;
            border-radius:var(--radius); border:1px solid var(--border);
            background:var(--dark3); cursor:pointer; font-size:0.78em;
            color:var(--text2); transition:all 0.15s;
        }
        .mm-player-chip.selected {
            border-color:var(--secondary); background:rgba(255,215,0,0.13);
            color:var(--secondary);
        }
        /* Pill de apuesta en la notificaciÃ³n matched */
        .mm-wager-pill {
            display:inline-flex; align-items:center; gap:6px;
            background:rgba(255,215,0,0.1); border:1px solid rgba(255,215,0,0.3);
            border-radius:20px; padding:5px 13px; font-size:0.8em;
            color:var(--secondary); font-weight:700; margin:10px 0 14px;
        }
        .mm-wager-pill.no-wager {
            background:rgba(255,255,255,0.05); border-color:var(--border);
            color:var(--text2);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CONFETTI + MISC
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #confettiContainer {
            position:fixed; top:0; left:0; width:100%; height:100%;
            pointer-events:none; z-index:9999; overflow:hidden;
        }
        .confetti-piece {
            position:absolute; top:-20px; border-radius:3px;
            animation:confettiFall linear forwards;
        }

        .streak-flame { display:inline-block; animation:flicker 0.35s ease-in-out infinite; }

        /* Glossy highlight on primary buttons */
        .btn-primary::after, .btn-next::after {
            content:''; position:absolute; top:0; left:0; right:0;
            height:42%; background:rgba(255,255,255,0.1);
            border-radius:inherit; pointer-events:none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESPONSIVE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width:480px) {
            #gameScreen { padding:10px 12px; }
            .menu-title { font-size:2em; }
            .question-text { font-size:1.1em; }
            .results-card { padding:22px 18px; }
            .auth-box { padding:28px 22px; }
            .top-bar { padding:8px 12px; gap:6px; }
        }
        @media (max-width:360px) {
            .option-btn { font-size:0.9em; }
            .option-letter { min-width:36px; }
            .stat-value { font-size:1.6em; }
        }
    </style>

</head>
<body>

<!-- PANTALLA DE CARGA -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText" data-i18n="loading_default">Cargando...</div>
</div>

<!-- MODAL SELECTOR DE JUGADOR (team builder) -->
<div id="playerModal">
    <div class="modal-sheet">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle" data-i18n="modal_title_default">Elige un jugador</div>
            <button class="modal-close" onclick="closePlayerModal()">âœ•</button>
        </div>
        <div class="modal-grid" id="modalGrid"></div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- PANTALLA DE AUTENTICACIÃ“N -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="authScreen">
    <div class="auth-box">
        <div class="auth-header">
            <span class="auth-logo">âš½</span>
            <h2>FutQuiz</h2>
            <p data-i18n="auth_subtitle">Â¿CuÃ¡nto sabes de fÃºtbol? Juega y crea el mejor XI</p>
        </div>
        <!-- Selector de idioma -->
        <div class="lang-selector">
            <button class="lang-btn active" data-lang="es" onclick="setLanguage('es')">ğŸ‡ªğŸ‡¸ ES</button>
            <button class="lang-btn"        data-lang="en" onclick="setLanguage('en')">ğŸ‡¬ğŸ‡§ EN</button>
        </div>
        <div class="error-msg" id="errorMsg"></div>
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchAuthTab('login', this)" data-i18n="auth_tab_login">Entrar</button>
            <button class="tab-btn" onclick="switchAuthTab('register', this)" data-i18n="auth_tab_register">Crear Cuenta</button>
        </div>
        <!-- LOGIN -->
        <form class="form active" id="loginForm">
            <div class="form-group">
                <label for="loginUsername" data-i18n="auth_label_username">Usuario</label>
                <input type="text" id="loginUsername" data-i18n-ph="auth_ph_username" placeholder="tu_usuario" required>
            </div>
            <div class="form-group">
                <label for="loginPassword" data-i18n="auth_label_password">ContraseÃ±a</label>
                <input type="password" id="loginPassword" data-i18n-ph="auth_ph_password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
            </div>
            <button type="submit" class="btn btn-primary" data-i18n="auth_btn_login">Entrar</button>
        </form>
        <!-- REGISTRO -->
        <form class="form" id="registerForm">
            <div class="form-group">
                <label for="regUsername" data-i18n="auth_label_username">Usuario</label>
                <input type="text" id="regUsername" data-i18n-ph="auth_ph_username" placeholder="tu_usuario" minlength="3" maxlength="20" required>
            </div>
            <div class="form-group">
                <label for="regPassword" data-i18n="auth_label_password">ContraseÃ±a</label>
                <input type="password" id="regPassword" data-i18n-ph="auth_ph_password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" minlength="4" required>
            </div>
            <button type="submit" class="btn btn-primary" data-i18n="auth_btn_register">Crear Cuenta</button>
        </form>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- PANTALLA DE JUEGO -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="gameScreen">
    <div class="game-container">

        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="logo-game">âš½ FutQuiz</div>
            <div class="score-display">â­ <span id="scoreDisplay">0</span></div>
            <!-- EnergÃ­a (corazones) -->
            <div class="energy-display" id="energyDisplay" onclick="showEnergyModal()" title="EnergÃ­a">
                <span class="energy-heart" id="eHeart1">â¤ï¸</span>
                <span class="energy-heart" id="eHeart2">â¤ï¸</span>
                <span class="energy-heart" id="eHeart3">â¤ï¸</span>
                <span class="energy-heart" id="eHeart4">â¤ï¸</span>
                <span class="energy-heart" id="eHeart5">â¤ï¸</span>
            </div>
            <!-- Recompensa diaria -->
            <div id="dailyBtn" onclick="showDailyModal()" style="cursor:pointer;font-size:1.3em;position:relative;" title="Recompensa diaria">
                ğŸ<span id="dailyDot" style="display:none;position:absolute;top:-2px;right:-2px;width:8px;height:8px;background:#FFD700;border-radius:50%;border:1px solid #1a1a2e;"></span>
            </div>
            <div class="topbar-lang">
                <button class="lang-btn active" data-lang="es" onclick="setLanguage('es')">ES</button>
                <button class="lang-btn"        data-lang="en" onclick="setLanguage('en')">EN</button>
            </div>
            <button class="mute-btn" id="muteBtn" onclick="Sound.toggleMute()" title="Sonido/MÃºsica">ğŸ”Š</button>
            <button class="user-logout" onclick="logout()" data-i18n="topbar_logout">Salir</button>
        </div>

        <!-- â”€â”€ MENÃš PRINCIPAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="screen main-menu active" id="mainMenu">
            <!-- PartÃ­culas flotantes de fondo -->
            <div class="menu-particles" aria-hidden="true">
                <span style="width:80px;height:80px;left:10%;top:15%;animation-duration:7s;animation-delay:0s;"></span>
                <span style="width:50px;height:50px;left:80%;top:10%;animation-duration:9s;animation-delay:1s;"></span>
                <span style="width:120px;height:120px;left:60%;top:50%;animation-duration:11s;animation-delay:2s;"></span>
                <span style="width:40px;height:40px;left:25%;top:70%;animation-duration:8s;animation-delay:0.5s;"></span>
                <span style="width:70px;height:70px;left:5%;top:85%;animation-duration:10s;animation-delay:3s;"></span>
            </div>
            <div class="menu-title" data-i18n="menu_title">FutQuiz</div>
            <div class="menu-subtitle" id="menuWelcome">Â¡Listo para jugar?</div>

            <!-- BANNER DE LIGA -->
            <div class="league-banner" id="leagueBanner" onclick="goToLeagueScreen()">
                <div class="league-emblem" id="leagueEmoji">âš½</div>
                <div class="league-info">
                    <div class="league-name" id="leagueName">DivisiÃ³n 10</div>
                    <div class="league-progress-row">
                        <div class="league-progress-bar">
                            <div class="league-progress-fill" id="leagueProgressFill" style="width:0%"></div>
                        </div>
                        <div class="league-wins-label" id="leagueWinsLabel">0/3 victorias</div>
                    </div>
                </div>
                <div class="league-arrow">â€º</div>
            </div>

            <div class="menu-buttons">
                <button class="menu-btn" onclick="startDuelMode()" style="background:linear-gradient(135deg,#1a1a2e,#16213e);color:#FFD700;border:2px solid rgba(255,215,0,0.4);">âš”ï¸ Jugar Duelo vs Bot</button>
                <button class="menu-btn pvp-btn" onclick="goToPvP()" style="background:linear-gradient(135deg,#6a0dad,#9b30ff);color:white;position:relative;">
                    âš”ï¸ Duelo PvP
                    <span id="pvpBadge" style="display:none;position:absolute;top:-4px;right:-4px;background:#FF4444;color:white;font-size:0.65em;font-weight:800;min-width:18px;height:18px;border-radius:9px;padding:0 4px;display:none;align-items:center;justify-content:center;line-height:18px;" id="pvpPendingBadge"></span>
                </button>
                <button class="menu-btn" id="mmSearchBtn" onclick="mmOpenSetup()" style="background:linear-gradient(135deg,#00A882,#00D4AA);color:#0B1426;font-weight:900;position:relative;">
                    ğŸ” Buscar Rival 1v1
                </button>
                <button class="menu-btn" onclick="goToModeSelector()" data-i18n="menu_btn_quiz">ğŸ® Jugar Quiz</button>
                <button class="menu-btn" onclick="goToXI()" data-i18n="menu_btn_xi">ğŸ“ Completa el XI</button>
                <button class="menu-btn" onclick="goToTeam()" data-i18n="menu_btn_team">âš½ Mi Equipo</button>
                <button class="menu-btn" onclick="goToCatalog()" data-i18n="menu_btn_catalog">ğŸ“¸ CatÃ¡logo</button>
                <button class="menu-btn" onclick="goToLeaderboard()" data-i18n="menu_btn_ranking">ğŸ† Ranking</button>
            </div>
        </div>

        <!-- â”€â”€ SELECTOR DE MODO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="screen" id="modeScreen">
            <button class="back-btn" onclick="goToMenu()" data-i18n="mode_back">â† MenÃº</button>
            <div class="screen-title" data-i18n="mode_title">Elige el Modo</div>
            <div class="screen-subtitle" data-i18n="mode_subtitle">Â¿CÃ³mo quieres jugar?</div>
            <div class="mode-cards">

                <!-- CLÃSICO 10 -->
                <div class="mode-card" onclick="startGame('classic', 10)">
                    <div class="mode-card-top">
                        <div class="mode-icon">ğŸ®</div>
                        <div>
                            <div class="mode-name" data-i18n="mode_classic_fast_name">ClÃ¡sico RÃ¡pido</div>
                            <div class="mode-desc" data-i18n="mode_classic_fast_desc">10 preguntas, 3 vidas, dificultad progresiva</div>
                        </div>
                    </div>
                    <div class="mode-tags">
                        <span class="mode-tag green" data-i18n="tag_10q">10 preguntas</span>
                        <span class="mode-tag red"   data-i18n="tag_3lives">3 vidas</span>
                        <span class="mode-tag"       data-i18n="tag_6levels">6 niveles</span>
                    </div>
                </div>

                <!-- CLÃSICO 20 -->
                <div class="mode-card" onclick="startGame('classic', 20)">
                    <div class="mode-card-top">
                        <div class="mode-icon">âš½</div>
                        <div>
                            <div class="mode-name" data-i18n="mode_classic_normal_name">ClÃ¡sico Normal</div>
                            <div class="mode-desc" data-i18n="mode_classic_normal_desc">20 preguntas, 3 vidas, dificultad progresiva</div>
                        </div>
                    </div>
                    <div class="mode-tags">
                        <span class="mode-tag green" data-i18n="tag_20q">20 preguntas</span>
                        <span class="mode-tag red"   data-i18n="tag_3lives">3 vidas</span>
                        <span class="mode-tag"       data-i18n="tag_6levels">6 niveles</span>
                    </div>
                </div>

                <!-- CLÃSICO 30 -->
                <div class="mode-card" onclick="startGame('classic', 30)">
                    <div class="mode-card-top">
                        <div class="mode-icon">ğŸ†</div>
                        <div>
                            <div class="mode-name" data-i18n="mode_classic_full_name">ClÃ¡sico Completo</div>
                            <div class="mode-desc" data-i18n="mode_classic_full_desc">30 preguntas, 3 vidas, dificultad progresiva</div>
                        </div>
                    </div>
                    <div class="mode-tags">
                        <span class="mode-tag green" data-i18n="tag_30q">30 preguntas</span>
                        <span class="mode-tag red"   data-i18n="tag_3lives">3 vidas</span>
                        <span class="mode-tag"       data-i18n="tag_6levels">6 niveles</span>
                    </div>
                </div>

                <!-- VELOCIDAD -->
                <div class="mode-card" onclick="startGame('speed')">
                    <div class="mode-card-top">
                        <div class="mode-icon">âš¡</div>
                        <div>
                            <div class="mode-name" data-i18n="mode_speed_name">Velocidad</div>
                            <div class="mode-desc" data-i18n="mode_speed_desc">Responde todo lo que puedas antes de que acabe el tiempo</div>
                        </div>
                    </div>
                    <div class="mode-tags">
                        <span class="mode-tag yellow" data-i18n="tag_nolimit">Sin lÃ­mite</span>
                        <span class="mode-tag green"  data-i18n="tag_nolives">Sin vidas</span>
                        <span class="mode-tag red"    data-i18n="tag_speed">Contrarreloj</span>
                    </div>
                </div>

                <!-- SUBIR DE NIVEL -->
                <div class="mode-card" onclick="startGame('level_up')">
                    <div class="mode-card-top">
                        <div class="mode-icon">ğŸ“ˆ</div>
                        <div>
                            <div class="mode-name" data-i18n="mode_levelup_name">Subir de Nivel</div>
                            <div class="mode-desc" data-i18n="mode_levelup_desc">Las preguntas se vuelven cada vez mÃ¡s difÃ­ciles</div>
                        </div>
                    </div>
                    <div class="mode-tags">
                        <span class="mode-tag"        data-i18n="tag_nolimit">Sin lÃ­mite</span>
                        <span class="mode-tag green"  data-i18n="tag_nolives">Sin vidas</span>
                        <span class="mode-tag yellow" data-i18n="tag_growing">Dificultad creciente</span>
                    </div>
                </div>

            </div>
        </div>

        <!-- â”€â”€ PANTALLA DE QUIZ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="screen quiz-container" id="quizContainer">
            <!-- HUD DEL DUELO (solo visible en modo duelo) -->
            <div class="duel-hud" id="duelHud">
                <div class="duel-player-side">
                    <img class="duel-avatar" id="duelPlayerAvatar"
                        src="https://api.dicebear.com/7.x/bottts/svg?seed=me" alt="TÃº">
                    <div class="duel-name" id="duelPlayerName">TÃº</div>
                    <div class="duel-score" id="duelPlayerScore">0</div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:center;">
                    <div class="duel-vs">VS</div>
                    <div class="duel-bot-thinking" id="duelBotThinking"></div>
                </div>
                <div class="duel-player-side">
                    <img class="duel-avatar" id="duelBotAvatar"
                        src="https://api.dicebear.com/7.x/bottts/svg?seed=bot1" alt="Bot">
                    <div class="duel-name" id="duelBotName">Bot</div>
                    <div class="duel-score" id="duelBotScore">0</div>
                    <div class="duel-rival-status connected" id="duelRivalStatus">â— online</div>
                </div>
            </div>
            <!-- HUD -->
            <div class="quiz-hud">
                <div class="lives-display" id="livesDisplay">â¤ï¸â¤ï¸â¤ï¸</div>
                <div class="streak-badge" id="streakBadge">ğŸ”¥ x1</div>
                <div class="timer-display" id="timerDisplay">â€”</div>
            </div>
            <!-- Pregunta -->
            <div class="question-box">
                <div class="question-progress">
                    <span id="questionNum">1</span>
                    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                    <span id="questionTotal">30</span>
                </div>
                <div class="level-badge" id="levelBadge">Nivel 1</div>
                <div class="question-text" id="questionText" data-i18n="quiz_loading">Cargando pregunta...</div>
            </div>
            <!-- Opciones -->
            <div class="options" id="optionsContainer"></div>
            <!-- Feedback -->
            <div class="answer-feedback" id="answerFeedback">
                <div class="feedback-emoji" id="feedbackEmoji"></div>
                <div>
                    <div class="feedback-text" id="feedbackText"></div>
                    <div class="feedback-explanation" id="feedbackExplanation"></div>
                </div>
                <div class="feedback-points" id="feedbackPoints"></div>
            </div>
            <!-- Footer -->
            <div class="game-footer">
                <button class="btn-small btn-next" id="nextBtn" style="display:none;" onclick="nextQuestion()" data-i18n="quiz_next">Siguiente â†’</button>
                <button class="btn-small btn-menu" onclick="confirmAbandon()" data-i18n="quiz_abandon">Abandonar</button>
            </div>
        </div>

        <!-- Aviso rareza restringida en modo quiz normal -->
        <div class="rarity-lock-notice" style="margin-top:2px;">
            ğŸ”’ <strong>Bronce, Plata y Oro</strong> se desbloquean en el quiz normal.<br>
            ğŸ’ <strong class="rarity-diamante">Diamante</strong> y ğŸ”¥ <strong class="rarity-leyenda">Leyenda</strong> solo se consiguen <strong>ganando Duelos PvP o Duelos vs Bot</strong>.
        </div>
    </div><!-- modeScreen -->
        <div class="screen results-screen" id="resultsScreen">
            <div class="results-card">
                <!-- Rank -->
                <div class="rank-emoji" id="rankEmoji">ğŸ¯</div>
                <div class="rank-name" id="rankName">Resultado</div>

                <!-- Stats grid -->
                <div class="results-stats">
                    <div class="stat-item highlight">
                        <div class="stat-value" id="finalScore">0</div>
                        <div class="stat-label" data-i18n="results_points">PUNTOS</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="finalAccuracy">0%</div>
                        <div class="stat-label" data-i18n="results_accuracy">PRECISIÃ“N</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="finalCorrect">0/0</div>
                        <div class="stat-label" data-i18n="results_correct">CORRECTAS</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="finalStreak">0</div>
                        <div class="stat-label" data-i18n="results_streak">RACHA MÃX.</div>
                    </div>
                </div>

                <!-- Resultado del duelo (si aplica) -->
                <div class="duel-result-section" id="duelResultSection">
                    <div class="duel-result-emoji" id="duelResultEmoji">ğŸ†</div>
                    <div class="duel-result-title" id="duelResultTitle">Â¡Ganaste!</div>
                    <div class="duel-score-comparison">
                        <div class="duel-score-box">
                            <div class="duel-score-box-val" id="duelFinalYou">0</div>
                            <div class="duel-score-box-label" data-i18n="duel_you">TÃš</div>
                        </div>
                        <div style="color:var(--text3);align-self:center;font-size:1.4em;font-weight:900;">VS</div>
                        <div class="duel-score-box">
                            <div class="duel-score-box-val" id="duelFinalBot">0</div>
                            <div class="duel-score-box-label" id="duelFinalBotName">Bot</div>
                        </div>
                    </div>
                    <div style="color:var(--text2);font-size:0.8em;margin-top:6px;" id="duelLeagueResultText"></div>
                </div>

                <!-- Jugador desbloqueado (si aplica) -->
                <div class="unlock-section" id="unlockSection" style="display:none;">
                    <div class="unlock-title" data-i18n="results_new_player">ğŸ‰ Â¡Nuevo Jugador Desbloqueado!</div>
                    <div class="unlock-player">
                        <div class="unlock-avatar" id="unlockAvatar">âš½</div>
                        <div class="unlock-info">
                            <div class="unlock-name" id="unlockName">Jugador</div>
                            <span class="unlock-rarity" id="unlockRarity">Bronce</span>
                        </div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="results-buttons">
                    <button class="btn btn-primary" onclick="playAgainAfterDuel()" id="btnPlayAgain" data-i18n="results_play_again">ğŸ® Jugar de Nuevo</button>
                    <button class="btn" style="background:var(--card-bg2);color:var(--text2);border:1px solid var(--border2);" onclick="goToMenu()" data-i18n="results_menu">â† MenÃº</button>
                </div>
            </div>
        </div>

        <!-- â”€â”€ EQUIPO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="screen" id="teamScreen">
            <button class="back-btn" onclick="goToMenu()" data-i18n="team_back">â† MenÃº</button>
            <div class="team-header">
                <h2 data-i18n="team_title">âš½ Mi Equipo</h2>
                <p data-i18n="team_subtitle">Toca una posiciÃ³n para cambiar el jugador</p>
            </div>
            <div class="team-value-bar">
                <span data-i18n="team_value">Valor del equipo</span>
                <span class="team-value-num" id="teamValue">0</span>
            </div>
            <div class="field">
                <div class="field-midline"></div>
                <!-- Delanteros -->
                <div class="field-line-label">Delantera</div>
                <div class="field-row">
                    <div class="slot-wrap"><div class="player-slot" id="slot_DEL1" onclick="openPlayerModal('DEL1')">â­•</div><span class="slot-name">DEL</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="slot_DEL2" onclick="openPlayerModal('DEL2')">â­•</div><span class="slot-name">DEL</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="slot_DEL3" onclick="openPlayerModal('DEL3')">â­•</div><span class="slot-name">DEL</span></div>
                </div>
                <!-- Mediocampistas -->
                <div class="field-line-label">Mediocampo</div>
                <div class="field-row">
                    <div class="slot-wrap"><div class="player-slot" id="slot_MED1" onclick="openPlayerModal('MED1')">â­•</div><span class="slot-name">MED</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="slot_MED2" onclick="openPlayerModal('MED2')">â­•</div><span class="slot-name">MED</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="slot_MED3" onclick="openPlayerModal('MED3')">â­•</div><span class="slot-name">MED</span></div>
                </div>
                <!-- Defensas -->
                <div class="field-line-label">Defensa</div>
                <div class="field-row">
                    <div class="slot-wrap"><div class="player-slot" id="slot_DEF1" onclick="openPlayerModal('DEF1')">â­•</div><span class="slot-name">DEF</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="slot_DEF2" onclick="openPlayerModal('DEF2')">â­•</div><span class="slot-name">DEF</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="slot_DEF3" onclick="openPlayerModal('DEF3')">â­•</div><span class="slot-name">DEF</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="slot_DEF4" onclick="openPlayerModal('DEF4')">â­•</div><span class="slot-name">DEF</span></div>
                </div>
                <!-- Portero -->
                <div class="field-line-label">Portero</div>
                <div class="field-row">
                    <div class="slot-wrap"><div class="player-slot" id="slot_POR" onclick="openPlayerModal('POR')">â­•</div><span class="slot-name">POR</span></div>
                </div>
            </div>
            <button class="btn btn-primary" id="saveTeamBtn" onclick="saveTeam()" style="display:none;" data-i18n="team_save">ğŸ’¾ Guardar Equipo</button>
        </div>

        <!-- â”€â”€ VER EQUIPO DE OTRO USUARIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="screen" id="viewTeamScreen">
            <button class="back-btn" id="viewTeamBackBtn" onclick="goToLeaderboard()">â† Ranking</button>
            <div class="team-header">
                <h2 id="viewTeamTitle">âš½ Equipo de <span id="viewTeamUsername"></span></h2>
            </div>
            <div class="view-team-value-bar">
                <span>â­ Valor del equipo</span>
                <span class="view-team-value-num" id="viewTeamValue">0</span>
            </div>
            <div class="field">
                <div class="field-midline"></div>
                <div class="field-line-label">Delantera</div>
                <div class="field-row">
                    <div class="slot-wrap"><div class="player-slot" id="vslot_DEL1">â­•</div><span class="slot-name">DEL</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="vslot_DEL2">â­•</div><span class="slot-name">DEL</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="vslot_DEL3">â­•</div><span class="slot-name">DEL</span></div>
                </div>
                <div class="field-line-label">Mediocampo</div>
                <div class="field-row">
                    <div class="slot-wrap"><div class="player-slot" id="vslot_MED1">â­•</div><span class="slot-name">MED</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="vslot_MED2">â­•</div><span class="slot-name">MED</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="vslot_MED3">â­•</div><span class="slot-name">MED</span></div>
                </div>
                <div class="field-line-label">Defensa</div>
                <div class="field-row">
                    <div class="slot-wrap"><div class="player-slot" id="vslot_DEF1">â­•</div><span class="slot-name">DEF</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="vslot_DEF2">â­•</div><span class="slot-name">DEF</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="vslot_DEF3">â­•</div><span class="slot-name">DEF</span></div>
                    <div class="slot-wrap"><div class="player-slot" id="vslot_DEF4">â­•</div><span class="slot-name">DEF</span></div>
                </div>
                <div class="field-line-label">Portero</div>
                <div class="field-row">
                    <div class="slot-wrap"><div class="player-slot" id="vslot_POR">â­•</div><span class="slot-name">POR</span></div>
                </div>
            </div>
        </div>
        <div class="screen" id="catalogScreen">
            <button class="back-btn" onclick="goToMenu()" data-i18n="catalog_back">â† MenÃº</button>
            <div class="catalog-header">
                <h2 data-i18n="catalog_title">ğŸ“¸ CatÃ¡logo</h2>
                <p id="catalogStats" data-i18n="catalog_loading">Cargando...</p>
            </div>
            <div class="catalog-filters" id="catalogFilters">
                <button class="filter-btn active" onclick="filterCatalog('all', this)"      data-i18n="filter_all">Todos</button>
                <button class="filter-btn"        onclick="filterCatalog('unlocked', this)" data-i18n="filter_unlocked">Desbloqueados</button>
                <button class="filter-btn"        onclick="filterCatalog('leyenda', this)">â­ Leyenda</button>
                <button class="filter-btn"        onclick="filterCatalog('diamante', this)">ğŸ’ Diamante</button>
                <button class="filter-btn"        onclick="filterCatalog('oro', this)">ğŸ¥‡ Oro</button>
                <button class="filter-btn"        onclick="filterCatalog('plata', this)">ğŸ¥ˆ Plata</button>
                <button class="filter-btn"        onclick="filterCatalog('bronce', this)">ğŸ¥‰ Bronce</button>
            </div>
            <div class="players-grid" id="playersGrid"></div>
        </div>

        <!-- â”€â”€ RANKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="screen" id="leaderboardScreen">
            <button class="back-btn" onclick="goToMenu()" data-i18n="ranking_back">â† MenÃº</button>
            <div class="leaderboard-header">
                <h2 data-i18n="ranking_title">ğŸ† Ranking Global</h2>
            </div>
            <div class="leaderboard-tabs">
                <button class="lb-tab active" onclick="switchLbTab('scores', this)" data-i18n="ranking_tab_scores">Puntuaciones</button>
                <button class="lb-tab"        onclick="switchLbTab('teams', this)"  data-i18n="ranking_tab_teams">Equipos</button>
            </div>
            <div class="lb-list" id="lbList"></div>
        </div>

        <!-- â”€â”€ COMPLETA EL XI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="screen" id="xiScreen">
            <button class="back-btn" onclick="goToMenu()" data-i18n="xi_back">â† MenÃº</button>

            <div class="xi-header">
                <h2 data-i18n="xi_title">ğŸ“ Completa el XI</h2>
                <p data-i18n="xi_subtitle">Adivina los jugadores que faltan en el equipo</p>
            </div>

            <!-- Meta del equipo -->
            <div class="xi-meta" id="xiMeta"></div>

            <!-- Selector de equipo -->
            <div id="xiTeamSelector" style="margin-bottom:12px;">
                <select id="xiTeamSelect" onchange="selectXiTeam(parseInt(this.value))"
                    style="width:100%;padding:12px;border-radius:12px;border:none;
                           font-size:0.9em;background:rgba(255,255,255,0.15);
                           color:white;outline:none;cursor:pointer;">
                    <option value="0" style="color:#333;" data-i18n-opt="xi_random">ğŸ² Equipo aleatorio</option>
                </select>
            </div>

            <!-- Campo de fÃºtbol -->
            <div class="xi-timer-label" id="xiTimerLabel">â± 45s</div>
            <div class="xi-timer-bar">
                <div class="xi-timer-fill" id="xiTimerFill"></div>
            </div>
            <div class="xi-field" id="xiField"></div>

            <!-- Acciones -->
            <div class="xi-actions">
                <button class="xi-check-btn" id="xiCheckBtn" onclick="checkXI()" data-i18n="xi_verify">âœ… Verificar respuestas</button>
                <button class="xi-next-btn"  id="xiNextBtn"  onclick="loadXiTeam(0)" data-i18n="xi_next">â­ Siguiente</button>
            </div>

            <!-- Resultado -->
            <div class="xi-result-card" id="xiResultCard">
                <div class="xi-result-score" id="xiResultScore"></div>
                <div class="xi-result-detail" id="xiResultDetail"></div>
                <div class="xi-result-rows"   id="xiResultRows"></div>
                <div class="xi-curiosity"     id="xiCuriosity"></div>
            </div>
        </div>

        <!-- Input modal para responder un slot -->
        <div class="xi-input-modal" id="xiInputModal">
            <div class="xi-input-sheet">
                <h3 id="xiInputTitle">Â¿QuiÃ©n juega aquÃ­?</h3>
                <p  id="xiInputHint"></p>
                <input class="xi-text-input" type="text" id="xiInputField"
                    data-i18n-ph="xi_input_ph"
                    placeholder="Escribe el apellido..."
                    onkeydown="if(event.key==='Enter')confirmXiInput()">
                <div class="xi-input-actions">
                    <button class="xi-cancel-btn"  onclick="closeXiInput()" data-i18n="xi_input_cancel">Cancelar</button>
                    <button class="xi-confirm-btn" onclick="confirmXiInput()" data-i18n="xi_input_confirm">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- â”€â”€ PANTALLA DE LIGA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="screen" id="leagueScreen">
            <button class="back-btn" onclick="goToMenu()">â† MenÃº</button>
            <div class="league-screen-header">
                <h2>ğŸŸï¸ Sistema de Ligas</h2>
                <p style="color:rgba(255,255,255,0.6);font-size:0.85em;">Gana partidas para ascender de divisiÃ³n</p>
            </div>
            <!-- DivisiÃ³n actual -->
            <div class="current-division-card">
                <span class="division-emoji" id="ldEmoji">âš½</span>
                <div class="division-title" id="ldName">DivisiÃ³n 10</div>
                <div class="division-sub" id="ldSub">Gana 3 partidas para ascender</div>
                <div class="division-stats">
                    <div class="div-stat">
                        <div class="div-stat-val green" id="ldWins">0</div>
                        <div class="div-stat-label">Victorias</div>
                    </div>
                    <div class="div-stat">
                        <div class="div-stat-val red" id="ldLosses">0</div>
                        <div class="div-stat-label">Derrotas</div>
                    </div>
                    <div class="div-stat">
                        <div class="div-stat-val" id="ldPromos" style="color:#FFD700;">0</div>
                        <div class="div-stat-label">Ascensos</div>
                    </div>
                </div>
                <div class="division-progress-big">
                    <div class="division-progress-big-fill" id="ldProgressFill" style="width:0%"></div>
                </div>
                <div class="division-progress-label" id="ldProgressLabel">0 / 3 victorias para ascender</div>
            </div>
            <!-- Escalera de divisiones -->
            <div style="color:white;font-weight:700;margin-bottom:10px;font-size:0.9em;opacity:0.7;">ğŸ“Š Todas las divisiones</div>
            <div class="league-ladder" id="leagueLadder"></div>
            <button class="menu-btn" onclick="startDuelMode()" style="background:linear-gradient(135deg,#FFD700,#FF8C00);color:#1a1a2e;margin-top:10px;">âš”ï¸ Jugar Duelo ahora</button>
        </div>

        <!-- â”€â”€ DUELO PVP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="screen" id="pvpScreen">
            <button class="back-btn" onclick="goToMenu()">â† MenÃº</button>
            <div class="screen-title">âš”ï¸ Duelo PvP</div>
            <div class="screen-subtitle">DesafÃ­a amigos Â· apuesta XP o cartas</div>

            <!-- Stats banner -->
            <div class="pvp-stats-banner" id="pvpStatsBanner">
                <div class="pvp-stat-pill wins">
                    <div class="pvp-stat-val green" id="pvpStatWins">â€”</div>
                    <div class="pvp-stat-label">Victorias</div>
                </div>
                <div class="pvp-stat-pill losses">
                    <div class="pvp-stat-val red" id="pvpStatLosses">â€”</div>
                    <div class="pvp-stat-label">Derrotas</div>
                </div>
                <div class="pvp-stat-pill total">
                    <div class="pvp-stat-val purple" id="pvpStatTotal">â€”</div>
                    <div class="pvp-stat-label">Partidas</div>
                    <div class="pvp-stat-wr" id="pvpStatWR">â€”% win rate</div>
                </div>
            </div>

            <!-- Tabs pill bar -->
            <div class="pvp-tabs-bar">
                <button class="pvp-tab-btn active" id="pvpTabChallenge" onclick="pvpShowTab('challenge')">â• Nuevo</button>
                <button class="pvp-tab-btn" id="pvpTabPending" onclick="pvpShowTab('pending')" style="position:relative;">
                    ğŸ“¬ Pendientes
                    <span class="pvp-tab-badge" id="pvpPendingCount" style="display:none;"></span>
                </button>
                <button class="pvp-tab-btn" id="pvpTabActive" onclick="pvpShowTab('active')">âš”ï¸ En Curso</button>
            </div>

            <!-- â”€â”€ TAB: NUEVO DESAFÃO â”€â”€ -->
            <div id="pvpTabContentChallenge">

                <!-- BÃºsqueda rival -->
                <div class="pvp-section">
                    <div class="pvp-label">ğŸ‘¤ Rival</div>
                    <div class="pvp-search-wrap">
                        <span class="pvp-search-icon">ğŸ”</span>
                        <input type="text" id="pvpOpponentInput" class="pvp-input"
                            placeholder="Nombre exacto del rivalâ€¦"
                            oninput="pvpSearchUser(this.value)" autocomplete="off" />
                    </div>
                    <div id="pvpUserFound" style="display:none;" class="pvp-found-pill">
                        <div class="pf-avatar" id="pvpFoundAvatar">?</div>
                        <span class="pf-name" id="pvpFoundName"></span>
                        <span class="pf-level" id="pvpFoundLevel"></span>
                    </div>
                    <div id="pvpUserNotFound" style="display:none;margin-top:5px;color:#FF6B6B;font-size:0.78em;">âŒ Usuario no encontrado</div>
                </div>

                <!-- Tipo de apuesta -->
                <div class="pvp-section">
                    <div class="pvp-label">ğŸ° Apuesta <span style="font-weight:400;text-transform:none;letter-spacing:0;">(opcional)</span></div>
                    <div class="pvp-wager-row">
                        <button class="pvp-wager-btn active" id="wagerNone"   onclick="pvpSelectWager('none')">ğŸš« Ninguna</button>
                        <button class="pvp-wager-btn"        id="wagerXp"     onclick="pvpSelectWager('xp')">â­ XP</button>
                        <button class="pvp-wager-btn"        id="wagerPlayer" onclick="pvpSelectWager('player')">ğŸƒ Carta</button>
                    </div>
                </div>

                <!-- Apuesta XP -->
                <div id="pvpWagerXpDiv" style="display:none;" class="pvp-section">
                    <div class="pvp-label">â­ XP a apostar</div>
                    <div class="pvp-xp-row">
                        <input type="number" id="pvpXpAmount" placeholder="Ej: 500" min="100" step="100" />
                    </div>
                    <div class="pvp-xp-hint" id="pvpMyXpLabel">Tu XP: cargandoâ€¦</div>
                </div>

                <!-- Apuesta jugador/carta -->
                <div id="pvpWagerPlayerDiv" style="display:none;" class="pvp-section">
                    <div class="pvp-label">ğŸƒ Carta a apostar</div>
                    <div id="pvpPlayerPickList"></div>
                    <div id="pvpSelectedPlayerInfo" style="display:none;" class="pvp-selected-player"></div>
                </div>

                <button class="pvp-send-btn" id="pvpSendChallengeBtn" onclick="pvpSendChallenge()">
                    âš”ï¸ Enviar DesafÃ­o
                </button>
                <div id="pvpSendResult" class="pvp-send-result"></div>
            </div>

            <!-- â”€â”€ TAB: PENDIENTES â”€â”€ -->
            <div id="pvpTabContentPending" style="display:none;">
                <div id="pvpPendingList">
                    <div class="pvp-empty"><div class="pvp-empty-icon">ğŸ“¬</div>Cargando desafÃ­osâ€¦</div>
                </div>
            </div>

            <!-- â”€â”€ TAB: EN CURSO â”€â”€ -->
            <div id="pvpTabContentActive" style="display:none;">
                <div id="pvpActiveList">
                    <div class="pvp-empty"><div class="pvp-empty-icon">âš”ï¸</div>Cargando duelosâ€¦</div>
                </div>
            </div>
        </div>

    </div><!-- .game-container -->
</div><!-- #gameScreen -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- MODAL: ENERGÃA VACÃA                                   -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="energy-modal" id="energyModal">
    <div class="energy-modal-card">
        <div style="font-size:2.5em;margin-bottom:8px;">âš¡</div>
        <h2>Sin energÃ­a</h2>
        <p>Necesitas energÃ­a para jugar. Se recarga 1 cada 30 minutos.</p>
        <div class="energy-hearts-big" id="energyHeartsModal">ğŸ’”ğŸ’”ğŸ’”ğŸ’”ğŸ’”</div>
        <div class="energy-timer" id="energyTimerModal">â€”</div>
        <div class="energy-modal-btns">
            <button class="btn-ad-watch" onclick="watchAdForEnergy()">ğŸ“º Ver anuncio â†’ +1 EnergÃ­a</button>
            <button class="btn-energy-close" onclick="document.getElementById('energyModal').classList.remove('show')">Cerrar</button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- MODAL: RECOMPENSA DIARIA                               -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="daily-modal" id="dailyModal">
    <div class="daily-modal-card">
        <h2>ğŸ Recompensa Diaria</h2>
        <p id="dailyStreakText">Â¡Vuelve cada dÃ­a para mejores premios!</p>
        <!-- Semana de burbujas -->
        <div class="daily-streak-row" id="dailyWeekRow">
            <!-- generado por JS -->
        </div>
        <!-- Premio de hoy -->
        <div class="daily-reward-big">
            <div class="daily-reward-emoji" id="dailyRewardEmoji">ğŸ</div>
            <div class="daily-reward-name" id="dailyRewardName">Cargando...</div>
            <div class="daily-reward-sub"  id="dailyRewardSub">Premio de hoy</div>
        </div>
        <button class="btn-claim-daily" id="btnClaimDaily" onclick="claimDailyReward()">Â¡Reclamar premio!</button>
        <button class="btn-daily-close" onclick="document.getElementById('dailyModal').classList.remove('show')">Cerrar</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- MODAL: CONFIRMAR APUESTA PVP                           -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="energy-modal" id="pvpWagerModal" style="display:none;opacity:0;">
    <div class="energy-modal-card" style="text-align:center;">
        <div style="font-size:2.5em;margin-bottom:8px;" id="pvpWagerModalEmoji">âš”ï¸</div>
        <h2>Â¿Confirmar apuesta?</h2>
        <p id="pvpWagerModalText" style="color:rgba(255,255,255,0.8);font-size:0.95em;line-height:1.5;">Esta acciÃ³n no se puede deshacer.</p>
        <p style="color:#FF6B6B;font-size:0.8em;margin-top:8px;">âš ï¸ Si pierdes, perderÃ¡s esta apuesta.</p>
        <div class="energy-modal-btns" style="margin-top:16px;">
            <button class="btn-ad-watch" onclick="pvpConfirmSend()" style="background:linear-gradient(135deg,#6a0dad,#9b30ff);">âœ… Confirmar y Enviar</button>
            <button class="btn-energy-close" onclick="pvpCloseWagerModal()">Cancelar</button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- MODAL: RESULTADO DUELO PVP                             -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="energy-modal" id="pvpResultModal" style="display:none;opacity:0;">
    <div class="energy-modal-card" style="text-align:center;">
        <div style="font-size:3em;margin-bottom:8px;" id="pvpResultEmoji">ğŸ†</div>
        <h2 id="pvpResultTitle">Â¡Victoria!</h2>
        <div id="pvpResultScores" style="display:flex;gap:12px;justify-content:center;margin:12px 0;font-size:1.1em;font-weight:700;"></div>
        <div id="pvpResultWager" style="margin-top:10px;padding:10px;background:rgba(255,215,0,0.1);border:1px solid rgba(255,215,0,0.3);border-radius:10px;display:none;"></div>
        <div id="pvpResultReward" style="margin-top:10px;padding:10px;background:rgba(0,188,212,0.1);border:1px solid rgba(0,188,212,0.4);border-radius:10px;display:none;font-size:0.9em;"></div>
        <button class="menu-btn" onclick="document.getElementById('pvpResultModal').style.display='none'" style="margin-top:14px;">Cerrar</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TOAST: ASCENSO / DESCENSO                             -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="promotion-toast" id="promotionToast"></div>
<div class="relegation-toast" id="relegationToast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- i18n: cargado ANTES del script del juego -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="translations.js"></script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- JAVASCRIPT -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentUser   = null;
let authToken     = null;
let userScore     = 0;
let allPlayers    = [];
let userTeam      = {};          // {position: player}
let pendingTeam   = {};          // cambios sin guardar
let currentPickPos = null;       // posiciÃ³n que se estÃ¡ editando

// Quiz state
let currentSession    = null;    // session_id del backend
let currentQuestion   = null;    // pregunta activa
let questionStartTime = null;
let questionTimer     = null;
let gameMode          = 'classic';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE SONIDO â€” Web Audio API (sin archivos externos)
// TemÃ¡tica futbolÃ­stica: estadio, ambiente de partido, efectos de juego
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class SoundManager {
    constructor() {
        this.ctx = null;
        this.muted = localStorage.getItem('futquiz_muted') === '1';
        this._musicNodes = [];
        this._musicPlaying = false;
        this._musicTimeout = null;
        this._beatStep = 0;
        document.addEventListener('DOMContentLoaded', () => this._updateMuteBtn());
    }

    _getCtx() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (this.ctx.state === 'suspended') this.ctx.resume();
        return this.ctx;
    }

    _updateMuteBtn() {
        const btn = document.getElementById('muteBtn');
        if (btn) btn.textContent = this.muted ? 'ğŸ”‡' : 'ğŸ”Š';
    }

    toggleMute() {
        this.muted = !this.muted;
        localStorage.setItem('futquiz_muted', this.muted ? '1' : '0');
        this._updateMuteBtn();
        if (this.muted) {
            this.stopMusic();
        } else {
            this._tone(880, 0.06, 0.1, 'sine');
            this.startMusic();
        }
    }

    // â”€â”€ Primitiva: un tono sintÃ©tico â”€â”€
    _tone(freq, duration, gain = 0.15, type = 'sine', startOffset = 0) {
        if (this.muted) return;
        try {
            const ctx = this._getCtx();
            const osc = ctx.createOscillator();
            const amp = ctx.createGain();
            osc.connect(amp);
            amp.connect(ctx.destination);
            osc.type = type;
            const t = ctx.currentTime + startOffset;
            osc.frequency.setValueAtTime(freq, t);
            amp.gain.setValueAtTime(gain, t);
            amp.gain.exponentialRampToValueAtTime(0.001, t + duration);
            osc.start(t);
            osc.stop(t + duration + 0.05);
        } catch(e) {}
    }

    // â”€â”€ Primitiva: ruido (bombo/percusiÃ³n) â”€â”€
    _noise(duration, gain = 0.15, startOffset = 0) {
        if (this.muted) return;
        try {
            const ctx = this._getCtx();
            const bufSize = ctx.sampleRate * duration;
            const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
            const data = buf.getChannelData(0);
            for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
            const src = ctx.createBufferSource();
            src.buffer = buf;
            const amp = ctx.createGain();
            src.connect(amp); amp.connect(ctx.destination);
            const t = ctx.currentTime + startOffset;
            amp.gain.setValueAtTime(gain, t);
            amp.gain.exponentialRampToValueAtTime(0.001, t + duration);
            src.start(t);
        } catch(e) {}
    }

    // â”€â”€ Click de UI â”€â”€
    playClick() {
        this._tone(440, 0.05, 0.08, 'sine');
    }

    // â”€â”€ Â¡Respuesta correcta! â€” Silbato de Ã¡rbitro corto + fanfarria â”€â”€
    playCorrect() {
        // Silbato: frecuencia alta, tipo square, rÃ¡pido
        this._tone(2800, 0.08, 0.12, 'square', 0);
        this._tone(2800, 0.08, 0.10, 'square', 0.10);
        // Acorde de celebraciÃ³n tipo gol pequeÃ±o
        this._tone(523, 0.18, 0.10, 'sine', 0.22);
        this._tone(659, 0.18, 0.09, 'sine', 0.32);
        this._tone(784, 0.28, 0.09, 'sine', 0.42);
    }

    // â”€â”€ Respuesta incorrecta â€” Sonido de fallo de tiro â”€â”€
    playWrong() {
        // Golpe sordo + descenso
        this._noise(0.08, 0.12, 0);
        this._tone(220, 0.12, 0.12, 'sawtooth', 0.05);
        this._tone(160, 0.30, 0.09, 'sawtooth', 0.18);
    }

    // â”€â”€ Se acaba el tiempo â€” Silbato final de Ã¡rbitro (3 pitidos) â”€â”€
    playTimeUp() {
        this._tone(2800, 0.10, 0.14, 'square', 0.00);
        this._tone(2800, 0.10, 0.12, 'square', 0.14);
        this._tone(2800, 0.22, 0.14, 'square', 0.28);
    }

    // â”€â”€ Pitido de cuenta atrÃ¡s urgente (Ãºltimos 5 seg) â”€â”€
    playTimerBeep() {
        this._tone(1760, 0.06, 0.10, 'square');
    }

    // â”€â”€ Pitido de cuenta atrÃ¡s crÃ­tico (Ãºltimos 3 seg) â”€â”€
    playTimerUrgent() {
        this._tone(2200, 0.06, 0.13, 'square', 0.00);
        this._tone(2200, 0.06, 0.13, 'square', 0.08);
    }

    // â”€â”€ Desbloquear jugador â€” Fanfarria de estadio â”€â”€
    playUnlock() {
        // Redoble de tambor + fanfarria
        this._noise(0.05, 0.18, 0.00);
        this._noise(0.05, 0.16, 0.06);
        this._noise(0.05, 0.14, 0.12);
        this._noise(0.08, 0.20, 0.18);
        // MelodÃ­a festiva tipo himno
        const mel = [392, 392, 523, 523, 659, 784];
        mel.forEach((f, i) => this._tone(f, 0.20, 0.10, 'sine', 0.30 + i * 0.14));
    }

    // â”€â”€ Subir de nivel â€” OvaciÃ³n del estadio â”€â”€
    playLevelUp() {
        this._noise(0.05, 0.14, 0.00);
        this._noise(0.05, 0.12, 0.05);
        this._noise(0.10, 0.18, 0.10);
        // Escala festiva
        [330, 392, 494, 523, 659, 784, 988, 1047].forEach((f, i) =>
            this._tone(f, 0.16, 0.09, 'triangle', 0.22 + i * 0.10));
    }

    // â”€â”€ Victoria / Ganar partido â€” Â¡GOL! â”€â”€
    playWin() {
        // Bombo (crowd roar simulado con noise en crescendo)
        this._noise(0.12, 0.18, 0.00);
        this._noise(0.18, 0.22, 0.10);
        this._noise(0.30, 0.28, 0.25);
        // Fanfarria de gol
        const gol = [523, 659, 784, 1047, 784, 1047, 1319];
        gol.forEach((f, i) => this._tone(f, 0.20, 0.10, 'sine', 0.55 + i * 0.12));
    }

    // â”€â”€ Victoria perfecta â€” Â¡Golazo Ã©pico! â”€â”€
    playPerfect() {
        // Silbato final
        this._tone(2800, 0.08, 0.13, 'square', 0.00);
        this._tone(2800, 0.08, 0.11, 'square', 0.10);
        this._tone(2800, 0.20, 0.13, 'square', 0.22);
        // Tambores + fanfarria completa
        this._noise(0.10, 0.20, 0.50);
        this._noise(0.10, 0.20, 0.60);
        this._noise(0.20, 0.28, 0.72);
        const epic = [392, 523, 659, 784, 1047, 1319, 1047, 1319, 1568, 2093];
        epic.forEach((f, i) => this._tone(f, 0.22, 0.09, 'sine', 0.95 + i * 0.11));
    }

    // â”€â”€ Derrota / Perder partido â”€â”€
    playLose() {
        // Silbato final triste
        this._tone(2200, 0.12, 0.10, 'square', 0.00);
        // Descenso grave
        this._tone(330, 0.20, 0.10, 'sine', 0.20);
        this._tone(294, 0.20, 0.09, 'sine', 0.38);
        this._tone(262, 0.25, 0.09, 'sine', 0.55);
        this._tone(220, 0.40, 0.08, 'sine', 0.75);
    }

    // â”€â”€ Recompensa diaria â€” Fanfarria corta â”€â”€
    playDailyReward() {
        this._noise(0.06, 0.15, 0.00);
        [392, 494, 587, 784, 988].forEach((f, i) => this._tone(f, 0.16, 0.10, 'sine', 0.12 + i * 0.11));
    }

    // â”€â”€ EnergÃ­a vacÃ­a â€” SeÃ±al de advertencia â”€â”€
    playEnergyEmpty() {
        this._tone(440, 0.12, 0.12, 'square', 0.00);
        this._tone(330, 0.12, 0.10, 'square', 0.16);
        this._tone(220, 0.30, 0.12, 'square', 0.32);
    }

    // â”€â”€ PvP Win â€” Fanfarria de campeÃ³n â”€â”€
    playPvpWin() {
        this._noise(0.08, 0.18, 0.00);
        this._noise(0.08, 0.18, 0.08);
        this._noise(0.15, 0.22, 0.18);
        const champ = [523, 659, 784, 1047, 1319, 1047, 784, 1047, 1319, 1568];
        champ.forEach((f, i) => this._tone(f, 0.16, 0.09, 'sine', 0.38 + i * 0.11));
    }

    // â”€â”€ PvP Lose â€” Final triste de partido â”€â”€
    playPvpLose() {
        this._tone(2200, 0.10, 0.09, 'square', 0.00);
        [330, 294, 262, 247, 220].forEach((f, i) => this._tone(f, 0.22, 0.09, 'sine', 0.18 + i * 0.16));
    }

    // â”€â”€ Racha de aciertos (streak) â”€â”€
    playStreak() {
        this._noise(0.04, 0.12, 0.00);
        this._noise(0.04, 0.12, 0.05);
        [523, 659, 784, 1047].forEach((f, i) => this._tone(f, 0.14, 0.09, 'sine', 0.12 + i * 0.09));
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MÃšSICA DE FONDO â€” Ambiente de estadio de fÃºtbol
    // Ritmo de bombo tipo partido + melodÃ­a tipo himno
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    startMusic() {
        if (this.muted || this._musicPlaying) return;
        try {
            const ctx = this._getCtx();
            this._musicPlaying = true;
            this._beatStep = 0;

            // MelodÃ­a tipo himno futbolÃ­stico (8 notas, se repite)
            // Inspirada en el ritmo de estadio â€” nota + pausa dramÃ¡tica
            const melody = [
                // [freq, durSec, gainMul, type, beatOffset]
                [392, 0.38, 1.0, 'triangle', 0.00],   // Sol  â€” arranque
                [392, 0.18, 0.8, 'triangle', 0.50],   // Sol  â€” eco
                [523, 0.55, 1.1, 'triangle', 0.75],   // Do   â€” subida
                [494, 0.28, 0.8, 'triangle', 1.38],   // Si   â€” tensiÃ³n
                [440, 0.40, 0.9, 'triangle', 1.75],   // La   â€” resoluciÃ³n
                [392, 0.55, 1.0, 'triangle', 2.25],   // Sol  â€” anchor
                [349, 0.28, 0.8, 'triangle', 2.88],   // Fa   â€” descenso
                [330, 0.55, 0.9, 'triangle', 3.25],   // Mi   â€” pausa
            ];
            // DuraciÃ³n total del loop = 4.0 s

            // Bajo de bombo tipo percusiÃ³n futbolÃ­stica (cada beat = 0.5s)
            const bass = [
                [98,  0.40, 1.4, 0.00],  // Bombo fuerte
                [98,  0.25, 0.9, 0.50],  // Bombo eco
                [110, 0.40, 1.2, 1.00],  // Bombo medio
                [98,  0.25, 0.8, 1.50],  // Bombo eco
                [98,  0.40, 1.4, 2.00],  // Bombo fuerte
                [98,  0.25, 0.9, 2.50],  // Bombo eco
                [110, 0.40, 1.2, 3.00],  // Bombo medio
                [98,  0.25, 0.8, 3.50],  // Bombo eco
            ];

            // PercusiÃ³n â€” golpe de tambor de estadio (noise corto cada beat)
            const drums = [0.00, 1.00, 2.00, 3.00];

            const volBase = 0.030;

            const playLoop = () => {
                if (!this._musicPlaying || this.muted) return;
                const t = ctx.currentTime;

                // BaterÃ­a de estadio
                drums.forEach(offset => {
                    const bufSize = Math.floor(ctx.sampleRate * 0.06);
                    const buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
                    const data = buf.getChannelData(0);
                    for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufSize * 0.3));
                    const src = ctx.createBufferSource();
                    src.buffer = buf;
                    const g = ctx.createGain();
                    src.connect(g); g.connect(ctx.destination);
                    const bt = t + offset;
                    g.gain.setValueAtTime(volBase * 1.8, bt);
                    g.gain.exponentialRampToValueAtTime(0.001, bt + 0.06);
                    src.start(bt);
                    this._musicNodes.push(src);
                });

                // Bajo tipo bombo de estadio
                bass.forEach(([freq, dur, gainMul, offset]) => {
                    const osc = ctx.createOscillator();
                    const g   = ctx.createGain();
                    osc.connect(g); g.connect(ctx.destination);
                    osc.type = 'sine';
                    const bt = t + offset;
                    osc.frequency.setValueAtTime(freq * 1.8, bt);
                    osc.frequency.exponentialRampToValueAtTime(freq, bt + 0.06);
                    g.gain.setValueAtTime(volBase * gainMul, bt);
                    g.gain.exponentialRampToValueAtTime(0.001, bt + dur);
                    osc.start(bt); osc.stop(bt + dur + 0.05);
                    this._musicNodes.push(osc);
                });

                // MelodÃ­a de himno futbolÃ­stico
                melody.forEach(([freq, dur, gainMul, type, offset]) => {
                    const osc = ctx.createOscillator();
                    const g   = ctx.createGain();
                    osc.connect(g); g.connect(ctx.destination);
                    osc.type = type;
                    const mt = t + offset;
                    osc.frequency.setValueAtTime(freq, mt);
                    g.gain.setValueAtTime(volBase * gainMul * 0.55, mt);
                    g.gain.exponentialRampToValueAtTime(0.001, mt + dur);
                    osc.start(mt); osc.stop(mt + dur + 0.05);
                    this._musicNodes.push(osc);
                });

                // Acorde de relleno (harmÃ³nico, tipo viento/coro de estadio)
                const chords = [
                    [196, 0.90, 0.5, 0.00],
                    [196, 0.90, 0.5, 2.00],
                ];
                chords.forEach(([freq, dur, gainMul, offset]) => {
                    [1, 1.5, 2.0].forEach(harmonic => {
                        const osc = ctx.createOscillator();
                        const g   = ctx.createGain();
                        osc.connect(g); g.connect(ctx.destination);
                        osc.type = 'sine';
                        const ct = t + offset;
                        osc.frequency.setValueAtTime(freq * harmonic, ct);
                        g.gain.setValueAtTime(volBase * gainMul * 0.3 / harmonic, ct);
                        g.gain.exponentialRampToValueAtTime(0.001, ct + dur);
                        osc.start(ct); osc.stop(ct + dur + 0.05);
                        this._musicNodes.push(osc);
                    });
                });

                this._musicTimeout = setTimeout(playLoop, 4000);
            };

            this._musicTimeout = setTimeout(playLoop, 600);
        } catch(e) {}
    }

    stopMusic() {
        this._musicPlaying = false;
        clearTimeout(this._musicTimeout);
        this._musicNodes.forEach(n => { try { n.stop(); } catch(e) {} });
        this._musicNodes = [];
    }
}

const Sound = new SoundManager();
// Update mute button state immediately when script runs
setTimeout(() => Sound._updateMuteBtn(), 0);

// Pause/resume music when tab loses/gains focus
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        Sound.stopMusic();
    } else if (!Sound.muted) {
        Sound.startMusic();
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RIPPLE EFFECT â€” Onda al tocar/hacer clic en botones
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function addRipple(el, clientX, clientY) {
    const ripple = document.createElement('span');
    ripple.className = 'ripple';
    const rect = el.getBoundingClientRect();
    ripple.style.left = (clientX - rect.left) + 'px';
    ripple.style.top  = (clientY - rect.top) + 'px';
    el.appendChild(ripple);
    setTimeout(() => ripple.remove(), 700);
}

// Global click handler for ripple (delegated, efficient)
document.addEventListener('click', (e) => {
    const el = e.target.closest(
        '.btn, .menu-btn, .mode-card, .option-btn, .btn-small, ' +
        '.filter-btn, .pvp-accept-btn, .pvp-reject-btn, .tab-btn, ' +
        '.lang-btn, .mute-btn'
    );
    if (el) {
        addRipple(el, e.clientX, e.clientY);
    }
}, true);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFETTI â€” CelebraciÃ³n de puntuaciÃ³n perfecta
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function launchConfetti() {
    const container = document.getElementById('confettiContainer');
    if (!container) return;
    const colors = ['#1ABC9C','#F1C40F','#E74C3C','#3498DB','#9B59B6','#FF8C00','#ffffff'];
    for (let i = 0; i < 90; i++) {
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        piece.style.left    = (Math.random() * 100) + '%';
        piece.style.background = colors[Math.floor(Math.random() * colors.length)];
        const size = (6 + Math.random() * 9) + 'px';
        piece.style.width  = size;
        piece.style.height = size;
        piece.style.animationDuration = (1.4 + Math.random() * 2) + 's';
        piece.style.animationDelay    = (Math.random() * 0.6) + 's';
        // Some pieces are rectangular for variety
        if (Math.random() > 0.5) piece.style.borderRadius = '1px';
        container.appendChild(piece);
        setTimeout(() => piece.remove(), 4500);
    }
}

const API_URL = (window.GAME_CONFIG && window.GAME_CONFIG.apiUrl)
    ? window.GAME_CONFIG.apiUrl
    : '/api';

const SILHOUETTE_URL = 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Unknown_person.jpg/240px-Unknown_person.jpg';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILIDADES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showLoading(msg) {
    document.getElementById('loadingText').textContent = msg || T('loading_default');
    document.getElementById('loadingOverlay').classList.add('show');
}
function hideLoading() { document.getElementById('loadingOverlay').classList.remove('show'); }

function showError(message) {
    const el = document.getElementById('errorMsg');
    el.textContent = message;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

const _menuScreens = ['mainMenu'];
function showScreen(id, direction) {
    document.querySelectorAll('.screen').forEach(s => {
        s.classList.remove('active', 'slide-right', 'slide-left');
    });
    const el = document.getElementById(id);
    el.classList.add('active');
    // Apply slide direction animation
    if (direction === 'back' || _menuScreens.includes(id)) {
        el.classList.add('slide-left');
    } else if (direction !== 'none') {
        el.classList.add('slide-right');
    }
}

const RARITY_COLORS = {
    bronce: { bg: '#FF8C00', gradient: 'linear-gradient(135deg, #A0522D, #CD853F)' },
    plata:  { bg: '#95A5A6', gradient: 'linear-gradient(135deg, #7F8C8D, #BDC3C7)' },
    oro:    { bg: '#F1C40F', gradient: 'linear-gradient(135deg, #F39C12, #F1C40F)' },
    diamante: { bg: '#3498DB', gradient: 'linear-gradient(135deg, #2980B9, #74B9FF)' },
    leyenda:  { bg: '#E74C3C', gradient: 'linear-gradient(135deg, #C0392B, #FF6B6B)' },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FACEBOOK INSTANT GAMES SDK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function initFacebookSDK() {
    if (typeof FBInstant === 'undefined') return false;
    try {
        await FBInstant.initializeAsync();
        const fbPlayerId = FBInstant.player.getID();
        const fbName     = FBInstant.player.getName() || 'Jugador';
        const fbPhoto    = FBInstant.player.getPhoto();

        const fbEmail = `fb_${fbPlayerId}@facebook.player`;
        const fbPass  = `fbpwd_${fbPlayerId}`;

        let ok = await tryFbLogin(fbEmail, fbPass);
        if (!ok) ok = await tryFbRegister(fbName, fbEmail, fbPass);

        if (ok && fbPhoto) {
            document.querySelectorAll('.user-avatar').forEach(el => { el.src = fbPhoto; });
        }
        await FBInstant.startGameAsync();
        return true;
    } catch (err) {
        console.warn('FB SDK error:', err);
        return false;
    }
}

async function tryFbLogin(username, password) {
    try {
        const res = await fetch(`${API_URL}/auth/login`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.success) { applyLogin(data); return true; }
    } catch (_) {}
    return false;
}

async function tryFbRegister(username, password) {
    try {
        const res = await fetch(`${API_URL}/auth/register`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.success) { applyLogin(data); return true; }
    } catch (_) {}
    return false;
}

function applyLogin(data) {
    currentUser = { id: data.user_id, username: data.username, email: data.email };
    authToken   = data.auth_token;
    localStorage.setItem('authToken', authToken);
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    enterGame();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTENTICACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchAuthTab(tab, btn) {
    document.querySelectorAll('.form').forEach(f => f.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(tab + 'Form').classList.add('active');
    btn.classList.add('active');
}

document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    showLoading(T('loading_login'));
    try {
        const res  = await fetch(`${API_URL}/auth/login`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        hideLoading();
        if (data.success) { applyLogin(data); }
        else { showError(data.message || T('error_credentials')); }
    } catch { hideLoading(); showError(T('error_connection')); }
});

document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('regUsername').value;
    const password = document.getElementById('regPassword').value;
    showLoading(T('loading_register'));
    try {
        const res  = await fetch(`${API_URL}/auth/register`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        hideLoading();
        if (data.success) { applyLogin(data); }
        else { showError(data.message || T('error_create_account')); }
    } catch { hideLoading(); showError(T('error_connection')); }
});

function logout() {
    if (!confirm(T('logout_confirm'))) return;
    currentUser = null; authToken = null; allPlayers = []; userTeam = {};
    localStorage.removeItem('authToken'); localStorage.removeItem('currentUser');
    document.getElementById('gameScreen').classList.remove('active');
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('loginForm').reset();
    document.getElementById('registerForm').reset();
    userScore = 0;
    document.getElementById('scoreDisplay').textContent = '0';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTRAR AL JUEGO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function enterGame() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('gameScreen').classList.add('active');
    document.getElementById('menuWelcome').textContent = `${T('hello')}${currentUser.username}${T('hello_suffix')}`;
    showScreen('mainMenu');
    Sound.startMusic();
    await loadPlayers();
    // Cargar XP acumulado del usuario
    loadUserXp();
    // Cargar datos de retenciÃ³n en paralelo
    loadLeagueData();
    loadEnergyData();
    loadDailyData();
    // Badge desafÃ­os PvP pendientes
    pvpLoadPendingBadge();
}

async function loadUserXp() {
    if (!currentUser) return;
    try {
        const r = await fetch(`${API_URL}/user/${currentUser.username}/xp`);
        if (!r.ok) return;
        const data = await r.json();
        userScore = data.xp || 0;
        document.getElementById('scoreDisplay').textContent = userScore.toLocaleString();
    } catch (e) { /* silencioso */ }
}

async function loadPlayers() {
    try {
        const res  = await fetch(`${API_URL}/players/catalog?username=${currentUser.username}`);
        const data = await res.json();
        allPlayers = data.players || [];
    } catch (err) { console.error('Error cargando jugadores:', err); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVEGACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function goToMenu() {
    clearInterval(questionTimer);
    // Si habÃ­a un duelo real activo, detener heartbeat y limpiar
    if (window._pvpIsRealDuel) {
        pvpStopHeartbeat();
        document.getElementById('duelWaitRivalOverlay')?.classList.remove('active');
        window._pvpIsRealDuel        = false;
        window._pvpActiveChallengeId = null;
        window._pvpRivalName         = null;
    }
    showScreen('mainMenu', 'back');
}
function goToModeSelector()  { showScreen('modeScreen'); }
function goToTeam()          { showScreen('teamScreen'); renderTeam(); }
async function goToCatalog() { showScreen('catalogScreen'); await loadPlayers(); renderCatalog(); }
async function goToLeaderboard() { showScreen('leaderboardScreen'); await loadLeaderboard('scores'); }
function goToLeagueScreen()      { showScreen('leagueScreen'); renderLeagueScreen(); }
async function goToPvP() {
    showScreen('pvpScreen');
    pvpShowTab('challenge');
    pvpLoadDuelStats();       // carga stats sin bloquear
    await pvpLoadPending();
}

async function pvpLoadDuelStats() {
    try {
        const r = await fetch(`${API_URL}/user/${encodeURIComponent(currentUser.username)}/duel-stats`);
        if (!r.ok) return;
        const d = await r.json();
        const wins   = d.wins        ?? 0;
        const losses = d.losses      ?? 0;
        const total  = d.games_played ?? 0;
        const wr     = d.win_rate    ?? (total > 0 ? Math.round(wins / total * 100) : 0);
        document.getElementById('pvpStatWins').textContent   = wins;
        document.getElementById('pvpStatLosses').textContent = losses;
        document.getElementById('pvpStatTotal').textContent  = total;
        document.getElementById('pvpStatWR').textContent     = `${wr}% win rate`;
    } catch { /* silencioso */ }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ â€” INICIO CON BACKEND REAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function startGame(mode, numQuestions) {
    // Consumir energÃ­a (salvo que sea duelo vs bot o PvP real, que ya la consumieron/no la usan)
    if (!isDuelMode && !window._pvpIsRealDuel) {
        const hasEnergy = await consumeEnergy();
        if (!hasEnergy) return;
    }

    // Reset estado duelo del jugador (el bot ya se habrÃ¡ inicializado desde startDuelMode)
    if (isDuelMode) { duelPlayerScore = 0; }

    gameMode  = mode;
    userScore = 0;
    currentSession = null;
    document.getElementById('scoreDisplay').textContent = '0';
    document.getElementById('duelResultSection')?.classList.remove('show');

    // num_questions solo aplica al modo clÃ¡sico; default 30
    const num_questions = (mode === 'classic' && numQuestions) ? numQuestions : 30;

    showLoading(T('loading_game'));
    try {
        const res  = await fetch(`${API_URL}/game/start`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ player_name: currentUser.username, mode, num_questions })
        });
        const data = await res.json();
        hideLoading();

        if (!data.session_id) {
            alert(T('error_start_game')); return;
        }

        currentSession = data.session_id;
        showScreen('quizContainer');
        displayQuestion(data.first_question);
    } catch (err) {
        hideLoading();
        alert(T('error_server'));
        console.error(err);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ â€” MOSTRAR PREGUNTA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Devuelve el texto de una pregunta/opciÃ³n/respuesta/explicaciÃ³n en el idioma activo.
// Si no hay traducciÃ³n disponible, devuelve el valor en espaÃ±ol (campo base).
function qLang(q, field) {
    const lang = (typeof currentLang !== 'undefined') ? currentLang : 'es';
    if (lang !== 'es' && q.i18n && q.i18n[lang] && q.i18n[lang][field] !== undefined) {
        return q.i18n[lang][field];
    }
    return q[field];
}

function displayQuestion(q) {
    currentQuestion   = q;
    questionStartTime = Date.now();

    // Progreso
    document.getElementById('questionNum').textContent   = q.question_number;
    document.getElementById('questionTotal').textContent = q.total_questions;
    document.getElementById('progressFill').style.width  = (q.question_number / q.total_questions * 100) + '%';

    // Info de nivel
    document.getElementById('levelBadge').textContent = `${q.level_emoji} ${q.level_name}`;

    // Texto
    document.getElementById('questionText').textContent = qLang(q, 'question');

    // Opciones con prefijo A/B/C/D
    const container = document.getElementById('optionsContainer');
    const translatedOptions = qLang(q, 'options');
    const letters = ['A', 'B', 'C', 'D'];
    container.innerHTML = translatedOptions.map((opt, i) => `
        <button class="option-btn">
            <span class="option-letter">${letters[i] || String.fromCharCode(65+i)}</span>
            <span class="option-text">${opt}</span>
        </button>
    `).join('');
    container.querySelectorAll('.option-btn').forEach((btn, idx) => {
        btn.classList.add(`stagger-${idx}`);
        btn.addEventListener('click', function() {
            selectAnswer(this, q.options[idx], translatedOptions[idx]);
        });
    });

    // Reset UI
    document.getElementById('answerFeedback').className = 'answer-feedback';
    document.getElementById('nextBtn').style.display = 'none';
    document.getElementById('streakBadge').style.display = 'none';

    // Vidas (solo modo classic)
    if (gameMode === 'classic') {
        document.getElementById('livesDisplay').style.display = '';
    } else {
        document.getElementById('livesDisplay').style.display = 'none';
    }

    // Timer
    startTimer(isDuelMode ? Math.min(q.time_limit, 5) : q.time_limit);
}

function startTimer(seconds) {
    clearInterval(questionTimer);
    let remaining = seconds;
    const el = document.getElementById('timerDisplay');
    el.textContent = remaining;
    el.className   = 'timer-display';

    questionTimer = setInterval(() => {
        remaining--;
        el.textContent = remaining;
        if (remaining <= 5)  el.classList.add('urgent');
        if (remaining <= 5 && remaining > 3) Sound.playTimerBeep();
        if (remaining <= 3 && remaining > 0) Sound.playTimerUrgent();
        if (remaining <= 0)  { clearInterval(questionTimer); Sound.playTimeUp(); autoTimeout(); }
    }, 1000);
}

async function autoTimeout() {
    // Enviar respuesta vacÃ­a (se cuenta como error)
    await submitAnswerToAPI('__TIMEOUT__', '__TIMEOUT__');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ â€” RESPONDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function selectAnswer(btn, selectedEs, selectedDisplay) {
    clearInterval(questionTimer);
    document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
    document.getElementById('timerDisplay').textContent = 'â€”';
    await submitAnswerToAPI(selectedEs, selectedDisplay);
}

async function submitAnswerToAPI(selectedEs, selectedDisplay) {
    const timeTaken = Math.min((Date.now() - questionStartTime) / 1000, 60);

    let data;
    try {
        const res = await fetch(`${API_URL}/game/answer`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id:      currentSession,
                question_id:     currentQuestion.question_id,
                selected_option: selectedEs,
                time_taken:      timeTaken
            })
        });
        data = await res.json();
    } catch (err) {
        console.error('Error al enviar respuesta:', err);
        return;
    }

    // Respuesta correcta traducida al idioma activo
    const correctAnswerDisplay = qLang(currentQuestion, 'answer');

    // Sonido y vibraciÃ³n segÃºn respuesta
    if (data.correct) {
        Sound.playCorrect();
        if (navigator.vibrate) navigator.vibrate(40);
    } else {
        Sound.playWrong();
        if (navigator.vibrate) navigator.vibrate([60, 40, 60]);
    }

    // Colorear botones â€” usar .option-text si existe, sino textContent
    document.querySelectorAll('.option-btn').forEach(btn => {
        const textEl = btn.querySelector('.option-text');
        const val = textEl ? textEl.textContent.trim() : btn.textContent.trim();
        if (val === correctAnswerDisplay) { btn.classList.add('correct'); }
        else if (val === selectedDisplay && !data.correct) {
            btn.classList.add('incorrect');
            btn.classList.add('shake');
        }
    });

    // Score
    userScore = data.total_score;
    document.getElementById('scoreDisplay').textContent = userScore;

    // Actualizar puntos del jugador en duelo
    if (isDuelMode) {
        duelPlayerScore = userScore;
        updateDuelScores();
        // Simular respuesta del bot (con los puntos de esta pregunta como referencia)
        if (data.correct) {
            simulateBotAnswer(data.points_earned || 150);
        } else {
            simulateBotAnswer(0);
        }
    }

    // Streak badge
    if (data.streak >= 2) {
        const sb = document.getElementById('streakBadge');
        const flame = data.streak >= 4 ? '<span class="streak-flame">ğŸ”¥</span> ' : '';
        sb.innerHTML = `${flame}${T('quiz_streak')}${data.streak}`;
        sb.style.display = 'inline-block';
        if (data.correct) Sound.playStreak();
    }

    // Vidas
    if (gameMode === 'classic') {
        const lives = Math.max(0, data.lives_remaining);
        document.getElementById('livesDisplay').textContent = 'â¤ï¸'.repeat(lives) + 'ğŸ–¤'.repeat(3 - lives);
    }

    // Feedback
    const fb = document.getElementById('answerFeedback');
    fb.classList.add('show', data.correct ? 'correct-fb' : 'incorrect-fb');
    document.getElementById('feedbackEmoji').textContent = data.correct ? 'âœ…' : 'âŒ';
    document.getElementById('feedbackText').textContent  = data.correct ? T('quiz_correct') : `${T('quiz_answer')}${correctAnswerDisplay}`;
    document.getElementById('feedbackExplanation').textContent = qLang(currentQuestion, 'explanation') || '';
    document.getElementById('feedbackPoints').textContent = data.correct ? `+${data.points_earned}` : '';

    // Siguiente / Resultados
    const nextBtn = document.getElementById('nextBtn');
    nextBtn.style.display = 'block';
    if (data.game_over) {
        nextBtn.textContent = T('quiz_see_results');
        nextBtn.onclick = () => showResults();
    } else {
        nextBtn.textContent = T('quiz_next');
        nextBtn.onclick = nextQuestion;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ â€” SIGUIENTE PREGUNTA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function nextQuestion() {
    showLoading('Cargando...');
    try {
        const res  = await fetch(`${API_URL}/game/${currentSession}/question`);
        const data = await res.json();
        hideLoading();

        if (data.game_over || !data.question) {
            await showResults();
        } else {
            displayQuestion(data.question);
        }
    } catch (err) {
        hideLoading();
        console.error('Error al obtener siguiente pregunta:', err);
    }
}

function confirmAbandon() {
    if (confirm(T('quiz_abandon_confirm'))) {
        clearInterval(questionTimer);
        goToMenu();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ â€” RESULTADOS FINALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function showResults() {
    clearInterval(questionTimer);
    showLoading(T('loading_results'));

    let results, finishData;

    // 1. Obtener estadÃ­sticas de la sesiÃ³n
    try {
        const res = await fetch(`${API_URL}/game/${currentSession}/results`);
        results = await res.json();
    } catch (err) {
        hideLoading();
        alert(T('error_results'));
        goToMenu();
        return;
    }

    // 2. Guardar + desbloquear jugador (finish requiere accuracy, correct, total)
    try {
        const res = await fetch(`${API_URL}/game/finish`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: currentUser.username,
                score:    results.score,
                accuracy: results.accuracy,
                correct:  results.correct,
                total:    results.total,
                mode:     isDuelMode ? 'duel' : (gameMode || 'classic'),
            })
        });
        finishData = await res.json();
        // Actualizar XP total en la burbuja de la estrella
        if (finishData.total_xp !== undefined) {
            userScore = finishData.total_xp;
            document.getElementById('scoreDisplay').textContent = userScore.toLocaleString();
        }
    } catch (_) { finishData = {}; }

    hideLoading();
    showScreen('resultsScreen');

    // Sonido de resultados
    if (results.accuracy === 100) {
        Sound.playPerfect();
        if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
        setTimeout(launchConfetti, 300);
        document.querySelector('.results-card')?.classList.add('perfect');
    } else if (results.score > 0) {
        Sound.playWin();
    } else {
        Sound.playLose();
    }

    // â”€â”€ Modo Duelo vs bot: finalizar y mostrar resultado â”€â”€
    if (isDuelMode) {
        await finalizeDuel(results.score);
    // â”€â”€ Modo PvP real 1v1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    } else if (window._pvpIsRealDuel && window._pvpActiveChallengeId) {
        pvpStopHeartbeat();
        await pvpFinishRealDuel(results.score);
    } else {
        const duelResultSection = document.getElementById('duelResultSection');
        if (duelResultSection) duelResultSection.classList.remove('show');
    }

    document.getElementById('rankEmoji').textContent     = results.rank_emoji || 'ğŸ¯';
    document.getElementById('rankName').textContent      = results.rank?.name || 'Resultado';
    document.getElementById('finalScore').textContent    = results.score;
    document.getElementById('finalAccuracy').textContent = results.accuracy + '%';
    document.getElementById('finalCorrect').textContent  = `${results.correct}/${results.total}`;
    document.getElementById('finalStreak').textContent   = results.max_streak;

    // 3. Jugador desbloqueado (viene del endpoint /game/finish)
    const unlockSection  = document.getElementById('unlockSection');
    const unlockedPlayer = finishData?.player_unlocked;

    if (unlockedPlayer) {
        unlockSection.style.display = 'block';
        setTimeout(() => Sound.playUnlock(), 600);
        document.getElementById('unlockName').textContent = unlockedPlayer.name;
        const rarityEl = document.getElementById('unlockRarity');
        rarityEl.textContent = unlockedPlayer.rarity.charAt(0).toUpperCase() + unlockedPlayer.rarity.slice(1);
        rarityEl.className   = `unlock-rarity rarity-${unlockedPlayer.rarity}`;

        const avatarEl = document.getElementById('unlockAvatar');
        const photoUrl = unlockedPlayer.photo || '';
        if (photoUrl) {
            avatarEl.innerHTML = `<img src="${photoUrl}" alt="${unlockedPlayer.name}" referrerpolicy="no-referrer" onerror="this.parentElement.textContent='âš½'">`;
        } else {
            avatarEl.textContent = 'âš½';
        }
        await loadPlayers(); // Actualizar catÃ¡logo
    } else {
        unlockSection.style.display = 'none';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATÃLOGO DE JUGADORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let catalogFilter = 'all';

function renderCatalog() {
    const grid = document.getElementById('playersGrid');
    grid.innerHTML = '';

    const unlocked = new Set(allPlayers.filter(p => p.unlocked).map(p => p.id));
    const total    = allPlayers.length;
    const uCount   = unlocked.size;

    document.getElementById('catalogStats').textContent = `${uCount} / ${total} ${T('catalog_unlocked_of')}`;

    let list = allPlayers;
    if (catalogFilter === 'unlocked') list = allPlayers.filter(p => p.unlocked);
    else if (catalogFilter !== 'all') list = allPlayers.filter(p => p.rarity === catalogFilter);

    // Ordenar: desbloqueados primero, luego por rating
    list.sort((a, b) => (b.unlocked - a.unlocked) || (b.rating - a.rating));

    const rarityColors = {
        bronce: '#FF8C00', plata: '#95A5A6', oro: '#F1C40F',
        diamante: '#3498DB', leyenda: '#E74C3C'
    };

    list.forEach(player => {
        const card = document.createElement('div');
        card.className = 'player-card' + (player.unlocked ? '' : ' locked');

        const bgColor = rarityColors[player.rarity] || '#95A5A6';

        card.innerHTML = `
            <div class="player-img" style="background: ${bgColor}20;">
                <img src="${player.photo || SILHOUETTE_URL}" alt="${player.name}"
                     referrerpolicy="no-referrer"
                     onerror="this.src=SILHOUETTE_URL">
            </div>
            <div class="player-info">
                <div class="player-name-card">${player.name}</div>
                <div class="player-meta">
                    <span class="player-rating-card">${player.rating} â˜…</span>
                    <span class="rarity-dot ${player.rarity}"></span>
                </div>
            </div>
            ${!player.unlocked ? '<div class="lock-overlay">ğŸ”’</div>' : ''}
        `;
        grid.appendChild(card);
    });
}

function filterCatalog(filter, btn) {
    catalogFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderCatalog();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EQUIPO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function renderTeam() {
    // Cargar equipo guardado del backend
    try {
        const res  = await fetch(`${API_URL}/user/${currentUser.username}/team`);
        const data = await res.json();
        userTeam = data.team || {};
    } catch (_) { userTeam = {}; }

    pendingTeam = { ...userTeam };
    refreshTeamUI();
}

function refreshTeamUI() {
    const positions = ['POR','DEF1','DEF2','DEF3','DEF4','MED1','MED2','MED3','DEL1','DEL2','DEL3'];
    const labels = { POR:'POR', DEF1:'DEF', DEF2:'DEF', DEF3:'DEF', DEF4:'DEF',
                     MED1:'MED', MED2:'MED', MED3:'MED', DEL1:'DEL', DEL2:'DEL', DEL3:'DEL' };
    let totalValue = 0;

    positions.forEach(pos => {
        const slot    = document.getElementById('slot_' + pos);
        const player  = pendingTeam[pos];
        // El .slot-name ahora es hermano del slot (dentro del .slot-wrap)
        const nameEl  = slot?.parentElement?.querySelector('.slot-name');

        if (player) {
            totalValue += player.rating || 0;
            const bg = RARITY_COLORS[player.rarity]?.gradient || 'linear-gradient(135deg, #95A5A6, #BDC3C7)';
            slot.style.background = bg;
            slot.style.border = '2px solid rgba(255,255,255,0.55)';
            slot.classList.add('filled');

            if (player.photo) {
                slot.innerHTML = `<img src="${player.photo}" alt="${player.name}" referrerpolicy="no-referrer" onerror="this.style.display='none'">`;
            } else {
                slot.innerHTML = `<span style="font-size:1em;line-height:1">${player.name.split(' ')[0]}</span>`;
            }
            if (nameEl) nameEl.textContent = player.name.split(' ').pop();
        } else {
            slot.style.background = '';
            slot.style.border = '';
            slot.classList.remove('filled');
            slot.innerHTML = 'â­•';
            if (nameEl) nameEl.textContent = labels[pos];
        }
    });

    document.getElementById('teamValue').textContent = totalValue;

    const hasChanges = JSON.stringify(pendingTeam) !== JSON.stringify(userTeam);
    document.getElementById('saveTeamBtn').style.display = hasChanges ? 'block' : 'none';
}

function openPlayerModal(position) {
    currentPickPos = position;

    // PosiciÃ³n preferida para filtrar
    const posMap = { POR: 'POR', DEF1: 'DEF', DEF2: 'DEF', DEF3: 'DEF', DEF4: 'DEF',
                     MED1: 'MED', MED2: 'MED', MED3: 'MED', DEL1: 'DEL', DEL2: 'DEL', DEL3: 'DEL' };
    const prefPos = posMap[position];

    document.getElementById('modalTitle').textContent = `${T('modal_pick_for')}${position}`;

    const unlockedPlayers = allPlayers.filter(p => p.unlocked);

    // Ordenar: primero los de la posiciÃ³n preferida, luego por rating
    const sorted = unlockedPlayers.sort((a, b) => {
        const aPref = a.position === prefPos ? 1 : 0;
        const bPref = b.position === prefPos ? 1 : 0;
        return (bPref - aPref) || (b.rating - a.rating);
    });

    const grid = document.getElementById('modalGrid');
    grid.innerHTML = '';

    if (sorted.length === 0) {
        grid.innerHTML = `<div style="padding:30px;text-align:center;color:#95A5A6;grid-column:1/-1">${T('modal_empty')}</div>`;
    } else {
        // OpciÃ³n para vaciar la posiciÃ³n
        const emptyCard = document.createElement('div');
        emptyCard.className = 'modal-player-card';
        emptyCard.style.background = '#FFF3CD';
        emptyCard.innerHTML = `<div class="modal-player-avatar" style="background:#95A5A6">ğŸš«</div>
            <div class="modal-player-name">${T('modal_remove')}</div>`;
        emptyCard.onclick = () => { pickPlayer(position, null); };
        grid.appendChild(emptyCard);

        sorted.forEach(player => {
            const card = document.createElement('div');
            card.className = 'modal-player-card';
            const bg = RARITY_COLORS[player.rarity]?.gradient || '#EEE';
            card.innerHTML = `
                <div class="modal-player-avatar" style="background:${bg}">
                    <img src="${player.photo || ''}" alt="${player.name}"
                         referrerpolicy="no-referrer"
                         style="display:${player.photo ? 'block' : 'none'}"
                         onerror="this.style.display='none'">
                </div>
                <div class="modal-player-name">${player.name}</div>
                <div class="modal-player-rating">${player.rating} â˜… Â· ${player.position}</div>
            `;
            card.onclick = () => pickPlayer(position, player);
            grid.appendChild(card);
        });
    }

    document.getElementById('playerModal').classList.add('open');
}

function pickPlayer(position, player) {
    if (player) { pendingTeam[position] = player; }
    else { delete pendingTeam[position]; }
    closePlayerModal();
    refreshTeamUI();
}

function closePlayerModal() {
    document.getElementById('playerModal').classList.remove('open');
    currentPickPos = null;
}

async function saveTeam() {
    const teamPayload = {};
    Object.entries(pendingTeam).forEach(([pos, player]) => {
        if (player) teamPayload[pos] = player.id;
    });

    showLoading(T('loading_saving'));
    try {
        const res  = await fetch(`${API_URL}/user/${currentUser.username}/team`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team: teamPayload })
        });
        const data = await res.json();
        hideLoading();

        if (data.success || data.saved) {
            userTeam = { ...pendingTeam };
            document.getElementById('saveTeamBtn').style.display = 'none';
            alert(T('team_saved_ok'));
        } else {
            alert(data.message || T('team_save_error'));
        }
    } catch (err) {
        hideLoading();
        alert(T('team_conn_error'));
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE LIGAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let userLeagueData = null;

async function loadLeagueData() {
    if (!currentUser) return;
    try {
        const r = await fetch(`${API_URL}/league/${currentUser.username}`);
        if (!r.ok) return;
        userLeagueData = await r.json();
        updateLeagueBanner();
    } catch (e) { /* silencioso */ }
}

function updateLeagueBanner() {
    if (!userLeagueData) return;
    const d = userLeagueData;
    const info = d.division_info || {};
    document.getElementById('leagueEmoji').textContent  = info.emoji  || 'âš½';
    document.getElementById('leagueName').textContent   = info.name   || `DivisiÃ³n ${d.division}`;
    document.getElementById('leagueProgressFill').style.width = (d.progress_pct || 0) + '%';
    document.getElementById('leagueWinsLabel').textContent =
        `${d.wins_in_division}/${d.wins_needed} victorias`;
}

function goToLeagueScreen() {
    showScreen('leagueScreen');
    renderLeagueScreen();
}

function renderLeagueScreen() {
    if (!userLeagueData) return;
    const d = userLeagueData;
    const info = d.division_info || {};

    document.getElementById('ldEmoji').textContent  = info.emoji || 'âš½';
    document.getElementById('ldName').textContent   = info.name  || `DivisiÃ³n ${d.division}`;
    document.getElementById('ldSub').textContent    = `Gana ${d.wins_needed - d.wins_in_division} partido(s) mÃ¡s para ascender`;
    document.getElementById('ldWins').textContent   = d.wins_in_division;
    document.getElementById('ldLosses').textContent = d.losses_in_division;
    document.getElementById('ldPromos').textContent = d.total_promotions || 0;

    const pct = d.progress_pct || 0;
    document.getElementById('ldProgressFill').style.width = pct + '%';
    document.getElementById('ldProgressLabel').textContent =
        `${d.wins_in_division} / ${d.wins_needed} victorias para ascender`;

    // Escalera
    const DIVS = [
        {n:1,e:'ğŸ†',name:'DivisiÃ³n 1'},   {n:2,e:'ğŸ’',name:'DivisiÃ³n 2'},
        {n:3,e:'ğŸ’',name:'DivisiÃ³n 3'},   {n:4,e:'ğŸ¥‡',name:'DivisiÃ³n 4'},
        {n:5,e:'ğŸ¥‡',name:'DivisiÃ³n 5'},   {n:6,e:'ğŸ¥ˆ',name:'DivisiÃ³n 6'},
        {n:7,e:'ğŸ¥ˆ',name:'DivisiÃ³n 7'},   {n:8,e:'ğŸ…',name:'DivisiÃ³n 8'},
        {n:9,e:'ğŸ…',name:'DivisiÃ³n 9'},   {n:10,e:'âš½',name:'DivisiÃ³n 10'},
    ];
    const ladder = document.getElementById('leagueLadder');
    ladder.innerHTML = DIVS.map(div => {
        const isCurrent = div.n === d.division;
        const isAbove   = div.n < d.division;  // divisiones superiores aÃºn bloqueadas
        return `<div class="ladder-row ${isCurrent?'current':''} ${(!isCurrent&&!isAbove)?'locked':''}">
            <div class="ladder-div-num">${div.e}</div>
            <div class="ladder-div-name">${div.name}</div>
            ${isCurrent ? '<span class="ladder-badge current-badge">AquÃ­</span>'
                        : isAbove ? '<span class="ladder-badge">âœ“</span>'
                        : '<span class="ladder-badge">ğŸ”’</span>'}
        </div>`;
    }).join('');
}

async function submitLeagueResult(won) {
    if (!currentUser) return null;
    try {
        const r = await fetch(`${API_URL}/league/result`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                username: currentUser.username,
                score: parseInt(document.getElementById('finalScore').textContent) || 0,
                accuracy: won ? 70 : 30,
                correct: won ? 10 : 0,
                total: 10,
                won: won,
                mode: isDuelMode ? 'duel' : (gameMode || 'classic'),
            })
        });
        if (!r.ok) return null;
        const result = await r.json();
        userLeagueData = result.league;
        updateLeagueBanner();
        return result;
    } catch (e) { return null; }
}

function showLeagueToast(promoted, relegated, divBefore, divAfter) {
    if (promoted) {
        const t = document.getElementById('promotionToast');
        t.innerHTML = `ğŸ† Â¡ASCENDISTE!<br><small>DivisiÃ³n ${divBefore} â†’ DivisiÃ³n ${divAfter}</small>`;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3500);
    } else if (relegated) {
        const t = document.getElementById('relegationToast');
        t.innerHTML = `ğŸ“‰ Descendiste<br><small>DivisiÃ³n ${divBefore} â†’ DivisiÃ³n ${divAfter}</small>`;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3500);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE ENERGÃA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let userEnergyData = null;
let energyTimerInterval = null;

async function loadEnergyData() {
    if (!currentUser) return;
    try {
        const r = await fetch(`${API_URL}/energy/${currentUser.username}`);
        if (!r.ok) return;
        userEnergyData = await r.json();
        renderEnergyHearts();
    } catch (e) { /* silencioso */ }
}

function renderEnergyHearts() {
    if (!userEnergyData) return;
    const energy = userEnergyData.energy;
    const max    = userEnergyData.max_energy || 5;
    for (let i = 1; i <= max; i++) {
        const el = document.getElementById(`eHeart${i}`);
        if (!el) continue;
        el.className = 'energy-heart' + (i > energy ? ' empty' : '');
    }
}

function showEnergyModal() {
    loadEnergyData().then(() => {
        const modal = document.getElementById('energyModal');
        modal.classList.add('show');
        updateEnergyModalContent();
        // Actualizar contador cada minuto
        clearInterval(energyTimerInterval);
        energyTimerInterval = setInterval(updateEnergyModalContent, 60000);
    });
}

function updateEnergyModalContent() {
    if (!userEnergyData) return;
    const e = userEnergyData;
    // Corazones
    const hearts = document.getElementById('energyHeartsModal');
    let hStr = '';
    for (let i = 0; i < e.max_energy; i++) {
        hStr += i < e.energy ? 'â¤ï¸' : 'ğŸ–¤';
    }
    hearts.textContent = hStr;
    // Timer
    const timer = document.getElementById('energyTimerModal');
    if (e.is_full) {
        timer.textContent = 'Â¡EnergÃ­a completa!';
    } else if (e.minutes_to_next_recharge !== null) {
        timer.textContent = `+1 en ${e.minutes_to_next_recharge} min`;
    }
}

async function watchAdForEnergy() {
    // En producciÃ³n: FBInstant.getRewardedVideoAsync() â†’ etc.
    // Por ahora simulamos el anuncio con un timeout de 3 segundos
    const btn = document.querySelector('.btn-ad-watch');
    btn.disabled = true;
    btn.textContent = 'ğŸ“º Cargando anuncio...';
    await new Promise(res => setTimeout(res, 2000));

    try {
        const r = await fetch(`${API_URL}/energy/refill`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({username: currentUser.username, amount: 1})
        });
        if (r.ok) {
            userEnergyData = await r.json();
            renderEnergyHearts();
            updateEnergyModalContent();
            btn.textContent = 'âœ… +1 EnergÃ­a ganada';
        }
    } catch (e) { /* */ }
    setTimeout(() => {
        btn.disabled = false;
        btn.textContent = 'ğŸ“º Ver anuncio â†’ +1 EnergÃ­a';
    }, 3000);
}

async function consumeEnergy() {
    if (!currentUser) return true; // sin auth = permitir
    try {
        const r = await fetch(`${API_URL}/energy/consume`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({username: currentUser.username})
        });
        const data = await r.json();
        if (!data.success) {
            Sound.playEnergyEmpty();
            showEnergyModal();
            return false;
        }
        userEnergyData = data;
        renderEnergyHearts();
        return true;
    } catch (e) { return true; } // si falla la API, permitir jugar
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECOMPENSA DIARIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let dailyData = null;

async function loadDailyData() {
    if (!currentUser) return;
    try {
        const r = await fetch(`${API_URL}/daily/${currentUser.username}`);
        if (!r.ok) return;
        dailyData = await r.json();
        // Mostrar punto amarillo si puede reclamar
        const dot = document.getElementById('dailyDot');
        if (dot) dot.style.display = dailyData.can_claim ? 'block' : 'none';
    } catch (e) { /* */ }
}

async function showDailyModal() {
    await loadDailyData();
    if (!dailyData) return;
    const d = dailyData;

    // Semana
    const weekRow = document.getElementById('dailyWeekRow');
    weekRow.innerHTML = (d.week_preview || []).map(r =>
        `<div class="day-bubble ${r.claimed?'claimed':''} ${r.is_next?'next':''}">
            ${r.claimed ? 'âœ“' : r.is_next ? r.emoji : r.day}
        </div>`
    ).join('');

    // Racha
    const streakText = document.getElementById('dailyStreakText');
    if (d.streak_days > 0) {
        streakText.textContent = `ğŸ”¥ Racha: ${d.streak_days} dÃ­a${d.streak_days>1?'s':''} seguidos`;
    } else {
        streakText.textContent = 'Â¡Vuelve cada dÃ­a para mejores premios!';
    }

    // Premio siguiente
    const nr = d.next_reward || {};
    document.getElementById('dailyRewardEmoji').textContent = nr.emoji || 'ğŸ';
    document.getElementById('dailyRewardName').textContent  = nr.label || 'Sorpresa';
    document.getElementById('dailyRewardSub').textContent   = `DÃ­a ${d.next_day} de 7`;

    // BotÃ³n
    const btn = document.getElementById('btnClaimDaily');
    btn.disabled = !d.can_claim;
    btn.textContent = d.can_claim ? 'Â¡Reclamar premio!' : 'Ya reclamado hoy âœ“';

    document.getElementById('dailyModal').classList.add('show');
}

async function claimDailyReward() {
    if (!currentUser) return;
    const btn = document.getElementById('btnClaimDaily');
    btn.disabled = true;
    btn.textContent = 'Reclamando...';

    try {
        const r = await fetch(`${API_URL}/daily/claim`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({username: currentUser.username})
        });
        const data = await r.json();
        if (data.success) {
            const reward = data.reward || {};
            btn.textContent = `âœ… ${reward.label || 'Â¡Premio reclamado!'}`;
            document.getElementById('dailyDot').style.display = 'none';
            Sound.playDailyReward();

            // â”€â”€ Actualizar XP en la burbuja de la estrella â”€â”€
            if (data.total_xp !== undefined) {
                userScore = data.total_xp;
                const scoreEl = document.getElementById('scoreDisplay');
                scoreEl.textContent = userScore.toLocaleString();
                // AnimaciÃ³n flash si ganÃ³ XP
                if (data.xp_gained > 0) {
                    scoreEl.parentElement.style.transition = 'transform 0.15s';
                    scoreEl.parentElement.style.transform = 'scale(1.35)';
                    scoreEl.parentElement.style.color = '#FFD700';
                    setTimeout(() => {
                        scoreEl.parentElement.style.transform = 'scale(1)';
                        scoreEl.parentElement.style.color = '';
                    }, 500);
                }
            }

            // AnimaciÃ³n especial si es jugador
            if (reward.type === 'player' && data.unlocked_player) {
                setTimeout(() => {
                    document.getElementById('dailyModal').classList.remove('show');
                    // Reusar la secciÃ³n de desbloqueo
                    showUnlockedPlayer(data.unlocked_player);
                }, 1500);
            }
        } else {
            btn.textContent = data.message || 'Error al reclamar';
        }
    } catch (e) {
        btn.textContent = 'Error de conexiÃ³n';
        btn.disabled = false;
    }
}

function showUnlockedPlayer(player) {
    // Reutilizar el mismo modal de resultados brevemente
    const sec = document.getElementById('unlockSection');
    if (!sec) return;
    const avatar = document.getElementById('unlockAvatar');
    avatar.innerHTML = player.photo
        ? `<img src="${player.photo}" alt="${player.name}" referrerpolicy="no-referrer" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
        : 'âš½';
    document.getElementById('unlockName').textContent = player.name;
    const rarityEl = document.getElementById('unlockRarity');
    rarityEl.textContent = (player.rarity || 'bronce').charAt(0).toUpperCase() + (player.rarity||'bronce').slice(1);
    rarityEl.className = `unlock-rarity rarity-${player.rarity || 'bronce'}`;
    sec.style.display = 'block';
    setTimeout(() => { sec.style.display = 'none'; }, 5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RIVAL BOT â€” MODO DUELO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let botData         = null;   // datos del bot generado por API
let duelBotScore    = 0;      // puntos acumulados del bot
let duelPlayerScore = 0;      // puntos acumulados del jugador en duelo
let isDuelMode      = false;
let botThinkTimeout = null;

async function startDuelMode() {
    // 1. Verificar energÃ­a
    const hasEnergy = await consumeEnergy();
    if (!hasEnergy) return;

    // 2. Generar bot
    showLoading(T('loading_default'));
    try {
        const username = currentUser?.username || 'guest';
        const r = await fetch(`${API_URL}/bot/generate/${username}`);
        botData = r.ok ? await r.json() : {
            name: 'CrackBot', flag: 'ğŸ¤–', difficulty: 'medium',
            avatar: 'https://api.dicebear.com/7.x/bottts/svg?seed=default',
            accuracy_min: 0.5, accuracy_max: 0.7, speed_min: 5, speed_max: 14
        };
    } catch (e) {
        botData = {
            name: 'CrackBot', flag: 'ğŸ¤–', difficulty: 'medium',
            avatar: 'https://api.dicebear.com/7.x/bottts/svg?seed=default',
            accuracy_min: 0.5, accuracy_max: 0.7, speed_min: 5, speed_max: 14
        };
    }

    // 3. Inicializar estado
    duelBotScore    = 0;
    duelPlayerScore = 0;
    isDuelMode      = true;

    // 4. Configurar HUD del duelo
    document.getElementById('duelBotName').textContent  = `${botData.flag} ${botData.name}`;
    document.getElementById('duelBotAvatar').src        = botData.avatar;
    document.getElementById('duelPlayerName').textContent = currentUser?.username || 'TÃº';
    document.getElementById('duelPlayerScore').textContent = '0';
    document.getElementById('duelBotScore').textContent    = '0';
    document.getElementById('duelHud').classList.add('active');

    hideLoading();

    // 5. Iniciar partida normal (10 preguntas modo clÃ¡sico)
    await startGame('classic', 10);
}

function updateDuelScores() {
    if (!isDuelMode) return;
    const playerEl = document.getElementById('duelPlayerScore');
    const botEl    = document.getElementById('duelBotScore');

    playerEl.textContent = duelPlayerScore;
    botEl.textContent    = duelBotScore;

    // Colorear segÃºn quiÃ©n va ganando
    playerEl.className = 'duel-score' +
        (duelPlayerScore > duelBotScore ? ' winning' :
         duelPlayerScore < duelBotScore ? ' losing' : '');
    botEl.className = 'duel-score' +
        (duelBotScore > duelPlayerScore ? ' winning' :
         duelBotScore < duelPlayerScore ? ' losing' : '');
}

function simulateBotAnswer(pointsIfCorrect) {
    if (!isDuelMode || !botData) return;
    // El bot decide si responde bien segÃºn su accuracy
    const acc = botData.accuracy_min + Math.random() * (botData.accuracy_max - botData.accuracy_min);
    const correct = Math.random() < acc;
    // Tiempo que tarda el bot en "pensar"
    const spd = botData.speed_min + Math.random() * (botData.speed_max - botData.speed_min);
    const thinkEl = document.getElementById('duelBotThinking');

    if (thinkEl) thinkEl.textContent = 'ğŸ¤” pensando...';

    botThinkTimeout = setTimeout(() => {
        if (correct) {
            // Puntos con bonus de velocidad aleatorio
            const timeLimit = 30;
            const timeTaken = spd;
            const bonus = Math.max(0, 1 - timeTaken / timeLimit);
            duelBotScore += Math.round(pointsIfCorrect * (1 + bonus * 0.5));
        }
        if (thinkEl) thinkEl.textContent = correct ? 'âœ“' : 'âœ—';
        setTimeout(() => { if (thinkEl) thinkEl.textContent = ''; }, 800);
        updateDuelScores();
    }, spd * 1000);
}

async function finalizeDuel(playerFinalScore) {
    if (!isDuelMode) return;
    duelPlayerScore = playerFinalScore;

    // Simular puntos finales del bot via API
    try {
        const r = await fetch(`${API_URL}/bot/simulate_score`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                total_questions: 10,
                difficulty: botData?.difficulty || 'medium'
            })
        });
        if (r.ok) {
            const botResult = await r.json();
            duelBotScore = botResult.score;
        }
    } catch (e) { /* usar el acumulado local */ }

    updateDuelScores();

    // Determinar ganador
    const won  = duelPlayerScore > duelBotScore;
    const draw = duelPlayerScore === duelBotScore;

    // Mostrar secciÃ³n de resultado del duelo en resultados
    const section = document.getElementById('duelResultSection');
    section.classList.add('show');
    document.getElementById('duelResultEmoji').textContent  =
        won ? 'ğŸ†' : draw ? 'ğŸ¤' : 'ğŸ˜¤';
    const titleEl = document.getElementById('duelResultTitle');
    titleEl.textContent = won  ? 'Â¡Ganaste el Duelo!' :
                          draw ? 'Â¡Empate!' : 'Perdiste el Duelo';
    titleEl.className   = 'duel-result-title ' + (won ? 'win' : draw ? 'draw' : 'lose');
    document.getElementById('duelFinalYou').textContent = duelPlayerScore;
    document.getElementById('duelFinalBot').textContent = duelBotScore;
    document.getElementById('duelFinalBotName').textContent =
        `${botData?.flag || ''} ${botData?.name || 'Bot'}`;

    // Registrar resultado en liga
    const leagueResult = await submitLeagueResult(won);
    if (leagueResult) {
        const leagueText = document.getElementById('duelLeagueResultText');
        if (leagueResult.promoted) {
            leagueText.textContent = `ğŸ† Â¡Ascendiste a ${leagueResult.league?.division_info?.name}!`;
            setTimeout(() => showLeagueToast(true, false, leagueResult.division_before, leagueResult.division_after), 2000);
        } else if (leagueResult.relegated) {
            leagueText.textContent = `ğŸ“‰ Descendiste a ${leagueResult.league?.division_info?.name}`;
            setTimeout(() => showLeagueToast(false, true, leagueResult.division_before, leagueResult.division_after), 2000);
        } else {
            const lg = leagueResult.league;
            leagueText.textContent = won
                ? `Liga: ${lg?.wins_in_division}/${lg?.wins_needed} victorias â†‘`
                : `Liga: ${lg?.losses_in_division}/${lg?.losses_to_drop} derrotas â†“`;
        }
    }

    // Limpiar HUD de duelo
    document.getElementById('duelHud').classList.remove('active');
    isDuelMode = false;

    // BotÃ³n "Jugar de nuevo" â†’ otro duelo
    const btnPlayAgain = document.getElementById('btnPlayAgain');
    if (btnPlayAgain) {
        btnPlayAgain.onclick = () => startDuelMode();
        btnPlayAgain.textContent = 'âš”ï¸ Revancha';
    }
}

function playAgainAfterDuel() {
    isDuelMode = false;
    document.getElementById('duelResultSection')?.classList.remove('show');
    goToModeSelector();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEADERBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let lbCurrentTab = 'scores';

function switchLbTab(tab, btn) {
    lbCurrentTab = tab;
    document.querySelectorAll('.lb-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadLeaderboard(tab);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VER EQUIPO DE OTRO USUARIO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function viewUserTeam(username) {
    showLoading('Cargando equipo...');
    try {
        const res  = await fetch(`${API_URL}/user/${username}/team`);
        const data = await res.json();
        const team = data.team || {};

        // Actualizar cabecera
        document.getElementById('viewTeamUsername').textContent = username;
        document.getElementById('viewTeamValue').textContent    = data.team_value || 0;

        // Pintar posiciones (solo lectura, prefijo vslot_)
        const positions = ['POR','DEF1','DEF2','DEF3','DEF4','MED1','MED2','MED3','DEL1','DEL2','DEL3'];
        const labels    = { POR:'POR', DEF1:'DEF', DEF2:'DEF', DEF3:'DEF', DEF4:'DEF',
                            MED1:'MED', MED2:'MED', MED3:'MED', DEL1:'DEL', DEL2:'DEL', DEL3:'DEL' };

        positions.forEach(pos => {
            const slot   = document.getElementById('vslot_' + pos);
            const player = team[pos];
            const nameEl = slot?.parentElement?.querySelector('.slot-name');
            if (player) {
                const bg = RARITY_COLORS[player.rarity]?.gradient || 'linear-gradient(135deg,#95A5A6,#BDC3C7)';
                slot.style.background = bg;
                slot.style.border     = '2px solid rgba(255,255,255,0.55)';
                slot.classList.add('filled');
                if (player.photo) {
                    slot.innerHTML = `<img src="${player.photo}" alt="${player.name}"
                        referrerpolicy="no-referrer" onerror="this.style.display='none'">`;
                } else {
                    slot.innerHTML = `<span style="font-size:1em;line-height:1">${player.name.split(' ')[0]}</span>`;
                }
                if (nameEl) nameEl.textContent = player.name.split(' ').pop();
            } else {
                slot.style.background = '';
                slot.style.border     = '';
                slot.classList.remove('filled');
                slot.innerHTML = 'â­•';
                if (nameEl) nameEl.textContent = labels[pos];
            }
        });

        hideLoading();
        showScreen('viewTeamScreen');
    } catch (e) {
        hideLoading();
        alert('No se pudo cargar el equipo de ' + username);
    }
}

async function loadLeaderboard(tab) {
    const list = document.getElementById('lbList');
    list.innerHTML = `<div style="text-align:center;padding:30px;color:#BDC3C7">${T('ranking_loading')}</div>`;

    try {
        const endpoint = tab === 'scores' ? '/leaderboard' : '/ranking/teams';
        const res  = await fetch(API_URL + endpoint);
        const data = await res.json();

        list.innerHTML = '';

        const entries = tab === 'scores' ? (data.leaderboard || data) : (data.rankings || data);

        if (!entries || entries.length === 0) {
            list.innerHTML = `<div style="text-align:center;padding:30px;color:#BDC3C7">${T('ranking_empty')}</div>`;
            return;
        }

        entries.forEach((entry, i) => {
            const rankNum  = i + 1;
            const rankEmoj = rankNum === 1 ? 'ğŸ¥‡' : rankNum === 2 ? 'ğŸ¥ˆ' : rankNum === 3 ? 'ğŸ¥‰' : rankNum;
            const rankCls  = rankNum <= 3 ? `top${rankNum}` : '';

            const name  = entry.username || entry.player_name || 'AnÃ³nimo';
            const score = tab === 'scores'
                ? `${(entry.score ?? entry.best_score ?? 0).toLocaleString()} ${T('ranking_pts')}`
                : `${entry.team_value} ${T('ranking_val')}`;
            const meta  = tab === 'scores'
                ? `ğŸ® ${entry.total_games ?? 1} ${entry.total_games === 1 ? 'partida' : 'partidas'}`
                : `${entry.players_in_team || 0} ${T('ranking_starters')}`;

            const el = document.createElement('div');
            el.className = 'lb-entry';

            const isOwn = (name === currentUser?.username);

            // BotÃ³n "Ver equipo" solo en tab de equipos
            let viewBtn = null;
            if (tab === 'teams') {
                viewBtn = document.createElement('button');
                viewBtn.className = `lb-view-btn${isOwn ? ' own' : ''}`;
                viewBtn.textContent = isOwn ? 'âœï¸ Mi equipo' : 'ğŸ‘ Ver equipo';
                viewBtn.dataset.username = name;
                viewBtn.dataset.own = isOwn ? '1' : '0';
            }

            el.innerHTML = `
                <div class="lb-rank ${rankCls}">${rankEmoj}</div>
                <div class="lb-name">${name}</div>
                <div style="flex:1">
                    <div class="lb-score">${score}</div>
                    <div class="lb-meta">${meta}</div>
                </div>
            `;

            if (viewBtn) {
                viewBtn.addEventListener('click', () => {
                    if (viewBtn.dataset.own === '1') goToTeam();
                    else viewUserTeam(viewBtn.dataset.username);
                });
                el.appendChild(viewBtn);
            }

            // Resaltar usuario actual
            if (isOwn) {
                el.style.background = 'linear-gradient(135deg, #E8F8F5, #D5F4E6)';
                el.style.border = '2px solid var(--primary)';
            }
            list.appendChild(el);
        });
    } catch (err) {
        list.innerHTML = `<div style="text-align:center;padding:30px;color:var(--danger)">${T('ranking_error')}</div>`;
        console.error(err);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INICIALIZACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// DOMContentLoaded: intentar FB SDK, luego sesiÃ³n guardada
window.addEventListener('DOMContentLoaded', async () => {
    // 1. Inicializar idioma
    initLanguage();

    // 2. Actualizar saludo cuando cambia el idioma (si ya hay sesiÃ³n)
    document.addEventListener('langchange', () => {
        if (currentUser) {
            document.getElementById('menuWelcome').textContent =
                `${T('hello')}${currentUser.username}${T('hello_suffix')}`;
        }
        // Actualizar el texto de "Cargando..." del overlay dinÃ¡mico
        const loadingEl = document.getElementById('loadingText');
        if (!document.getElementById('loadingOverlay').classList.contains('show')) {
            loadingEl.textContent = T('loading_default');
        }
        // Si hay una pregunta activa en pantalla, redibujarla en el nuevo idioma
        if (currentQuestion && document.getElementById('quizContainer').style.display !== 'none') {
            document.getElementById('questionText').textContent = qLang(currentQuestion, 'question');
            const translatedOptions = qLang(currentQuestion, 'options');
            const btns = document.querySelectorAll('.option-btn');
            btns.forEach((btn, idx) => { if (translatedOptions[idx]) btn.textContent = translatedOptions[idx]; });
            // Actualizar feedback de respuesta si estÃ¡ visible
            const fb = document.getElementById('answerFeedback');
            if (fb.classList.contains('show')) {
                const correctDisplay = qLang(currentQuestion, 'answer');
                const wasCorrect = fb.classList.contains('correct-fb');
                document.getElementById('feedbackText').textContent =
                    wasCorrect ? T('quiz_correct') : `${T('quiz_answer')}${correctDisplay}`;
                document.getElementById('feedbackExplanation').textContent =
                    qLang(currentQuestion, 'explanation') || '';
                // Recolorear botones con el nuevo texto
                btns.forEach(btn => {
                    if (btn.textContent.trim() === correctDisplay) btn.classList.add('correct');
                });
            }
        }
    });

    // 3. FB SDK o sesiÃ³n guardada
    const fbOk = await initFacebookSDK();
    if (!fbOk) {
        const savedUser  = localStorage.getItem('currentUser');
        const savedToken = localStorage.getItem('authToken');
        if (savedUser && savedToken) {
            currentUser = JSON.parse(savedUser);
            authToken   = savedToken;
            enterGame();
        }
        // Si no: mostrar pantalla de login (ya visible por defecto)
    }
});

// Cerrar modal al hacer clic fuera
document.getElementById('playerModal').addEventListener('click', function(e) {
    if (e.target === this) closePlayerModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPLETA EL XI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let xiCurrentTeam   = null;   // datos del equipo cargado
let xiUserAnswers   = {};     // {slot: respuesta_del_usuario}
let xiActiveSlot    = null;   // slot que se estÃ¡ editando
let xiTimerInterval = null;   // intervalo del temporizador
let xiTimeLeft      = 45;     // segundos restantes
const XI_TOTAL_TIME = 45;     // duraciÃ³n total en segundos

const POSITION_ICONS = { POR:'ğŸ§¤', DEF:'ğŸ›¡ï¸', MED:'âš™ï¸', DEL:'âš½' };
const LINE_NAMES     = { POR:'ğŸ§¤', DEF:'ğŸ›¡ï¸', MED:'âš™ï¸', DEL:'âš½' };

// LINE_NAMES translated â€” computed dynamically via T()
function getLineName(line) {
    const map = { POR:'xi_line_por', DEF:'xi_line_def', MED:'xi_line_med', DEL:'xi_line_del' };
    return map[line] ? T(map[line]) : line;
}

async function goToXI() {
    showScreen('xiScreen');
    await populateXiSelector();
    await loadXiTeam(0);
}

function selectXiTeam(teamId) {
    loadXiTeamById(teamId);
}

async function populateXiSelector() {
    try {
        const res  = await fetch(`${API_URL}/xi/list`);
        const list = await res.json();
        const sel  = document.getElementById('xiTeamSelect');
        sel.innerHTML = `<option value="0" style="color:#333;">${T('xi_random')}</option>`;
        list.forEach(t => {
            const diff = t.difficulty === 'fÃ¡cil' ? 'ğŸŸ¢' : t.difficulty === 'medio' ? 'ğŸŸ¡' : 'ğŸ”´';
            const opt  = document.createElement('option');
            opt.value  = t.id;
            opt.style.color = '#333';
            opt.textContent = `${t.badge} ${t.name} â€” ${t.season} ${diff}`;
            sel.appendChild(opt);
        });
    } catch(e) { console.error('Error cargando lista XI:', e); }
}

// â”€â”€ Temporizador XI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function xiStartTimer() {
    xiStopTimer();
    xiTimeLeft = XI_TOTAL_TIME;
    xiUpdateTimerUI();
    xiTimerInterval = setInterval(() => {
        xiTimeLeft--;
        xiUpdateTimerUI();
        if (xiTimeLeft <= 0) {
            xiStopTimer();
            xiTimeExpired();
        }
    }, 1000);
}

function xiStopTimer() {
    if (xiTimerInterval) { clearInterval(xiTimerInterval); xiTimerInterval = null; }
}

function xiUpdateTimerUI() {
    const pct   = (xiTimeLeft / XI_TOTAL_TIME) * 100;
    const fill  = document.getElementById('xiTimerFill');
    const label = document.getElementById('xiTimerLabel');
    if (!fill || !label) return;

    fill.style.width = pct + '%';

    const warn = xiTimeLeft <= 10;
    fill.classList.toggle('warning', warn);
    label.classList.toggle('warning', warn && xiTimeLeft > 0);
    label.classList.toggle('expired', xiTimeLeft <= 0);

    if (xiTimeLeft > 0) {
        label.textContent = `${T('xi_timer_label')}${xiTimeLeft}s`;
    } else {
        label.textContent = T('xi_time_up');
    }
}

function xiTimeExpired() {
    // Verificar automÃ¡ticamente con lo que haya respondido
    const label = document.getElementById('xiTimerLabel');
    if (label) { label.textContent = T('xi_time_up'); label.classList.add('expired'); }
    checkXI(true);  // true = forzado por tiempo
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadXiTeam(teamId) {
    xiUserAnswers = {};
    xiStopTimer();
    document.getElementById('xiResultCard').classList.remove('show');
    document.getElementById('xiCheckBtn').style.display = 'block';
    document.getElementById('xiNextBtn').style.display  = 'none';

    showLoading(T('loading_team'));
    try {
        const res  = await fetch(`${API_URL}/xi/random`);
        const data = await res.json();
        hideLoading();
        xiCurrentTeam = data;
        renderXiField(data);
        renderXiMeta(data);
        xiStartTimer();
    } catch(e) {
        hideLoading();
        console.error(e);
    }
}

async function loadXiTeamById(teamId) {
    xiUserAnswers = {};
    xiStopTimer();
    document.getElementById('xiResultCard').classList.remove('show');
    document.getElementById('xiCheckBtn').style.display = 'block';
    document.getElementById('xiNextBtn').style.display  = 'none';
    showLoading(T('loading_team'));
    try {
        const url  = teamId === 0 ? `${API_URL}/xi/random` : `${API_URL}/xi/${teamId}`;
        const res  = await fetch(url);
        const data = await res.json();
        hideLoading();
        xiCurrentTeam = data;
        renderXiField(data);
        renderXiMeta(data);
        xiStartTimer();
    } catch(e) { hideLoading(); console.error(e); }
}

function renderXiMeta(data) {
    const diffClass = 'diff-' + data.difficulty;
    document.getElementById('xiMeta').innerHTML = `
        <span class="xi-badge">${data.badge} ${data.name}</span>
        <span class="xi-badge">${data.season}</span>
        <span class="xi-badge">${data.formation}</span>
        <span class="xi-badge ${diffClass}">${data.difficulty}</span>
        <span class="xi-badge">â“ ${data.hidden_count} ${T('xi_hidden_count')}</span>
    `;
}

function renderXiField(data) {
    const field = document.getElementById('xiField');
    field.innerHTML = '';

    // Agrupar por lÃ­nea (prefijo del slot: POR, DEF, MED, DEL)
    const lineOrder = ['DEL','MED','DEF','POR'];
    const lineMap   = {};
    data.players.forEach(p => {
        const key = p.slot.replace(/\d+$/, '');  // DEF1 â†’ DEF
        if (!lineMap[key]) lineMap[key] = [];
        lineMap[key].push(p);
    });

    lineOrder.forEach(line => {
        if (!lineMap[line]) return;
        const lineDiv = document.createElement('div');
        lineDiv.className = 'xi-line';

        // Etiqueta de lÃ­nea
        const lbl = document.createElement('div');
        lbl.className = 'xi-line-label';
        lbl.textContent = getLineName(line);
        lineDiv.appendChild(lbl);

        lineMap[line].forEach(p => {
            const slot    = document.createElement('div');
            slot.className = `xi-slot ${p.hidden ? 'hidden' : 'known'}`;
            slot.id        = `slot_${p.slot}`;

            const circle = document.createElement('div');
            circle.className = 'xi-slot-circle';

            if (p.photo && !p.hidden) {
                // Jugador conocido: mostrar foto real
                const img = document.createElement('img');
                img.className = 'player-photo';
                img.src = p.photo;
                img.alt = p.name || '';
                img.onerror = () => { img.style.display='none'; iconEl.style.display='flex'; };
                const iconEl = document.createElement('span');
                iconEl.className = 'xi-slot-icon';
                iconEl.textContent = POSITION_ICONS[line] || 'âš½';
                iconEl.style.display = 'none';
                circle.appendChild(img);
                circle.appendChild(iconEl);
            } else if (p.hidden) {
                // Jugador oculto: guardar foto en dataset para revelar despuÃ©s
                const iconEl = document.createElement('span');
                iconEl.className = 'xi-slot-icon';
                iconEl.textContent = 'â“';
                circle.appendChild(iconEl);
                if (p.photo) circle.dataset.photo = p.photo;
            } else {
                circle.textContent = POSITION_ICONS[line] || 'âš½';
            }

            const nameEl = document.createElement('div');
            nameEl.className = 'xi-slot-name';
            nameEl.id        = `slotname_${p.slot}`;

            if (!p.hidden) {
                nameEl.textContent = p.name;
            } else {
                nameEl.textContent = '?';
                nameEl.style.opacity = '0.5';
                slot.onclick = () => openXiInput(p.slot, line);
            }

            slot.appendChild(circle);
            slot.appendChild(nameEl);
            lineDiv.appendChild(slot);
        });

        field.appendChild(lineDiv);
    });
}

function openXiInput(slot, line) {
    xiActiveSlot = slot;
    const existing = xiUserAnswers[slot] || '';
    document.getElementById('xiInputTitle').textContent  = `${POSITION_ICONS[line]} ${T('xi_input_title')}${slot}?`;
    document.getElementById('xiInputHint').textContent   = T('xi_input_hint');
    document.getElementById('xiInputField').value        = existing;
    document.getElementById('xiInputModal').classList.add('show');
    setTimeout(() => document.getElementById('xiInputField').focus(), 150);
}

function closeXiInput() {
    document.getElementById('xiInputModal').classList.remove('show');
    xiActiveSlot = null;
}

function confirmXiInput() {
    if (!xiActiveSlot) return;
    const val = document.getElementById('xiInputField').value.trim();
    if (val) {
        xiUserAnswers[xiActiveSlot] = val;
        // Actualizar visual del slot
        const nameEl = document.getElementById(`slotname_${xiActiveSlot}`);
        const slotEl = document.getElementById(`slot_${xiActiveSlot}`);
        if (nameEl) { nameEl.textContent = val; nameEl.style.opacity = '1'; }
        if (slotEl) { slotEl.style.borderColor = 'var(--secondary)'; }
    }
    closeXiInput();
}

async function checkXI(forced = false) {
    xiStopTimer();
    if (!xiCurrentTeam) return;

    // Contar cuÃ¡ntos slots ocultos tienen respuesta
    const hiddenSlots = xiCurrentTeam.players.filter(p => p.hidden).map(p => p.slot);
    const answered    = hiddenSlots.filter(s => xiUserAnswers[s]);
    if (!forced && answered.length === 0) {
        alert(T('xi_no_answer'));
        xiStartTimer(); // reanudar el timer si el usuario cancela
        return;
    }

    showLoading(forced ? T('xi_verify_time') : T('xi_verifying'));
    try {
        const res  = await fetch(`${API_URL}/xi/check`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ team_id: xiCurrentTeam.id, answers: xiUserAnswers })
        });
        const data = await res.json();
        hideLoading();
        showXiResult(data, forced);
    } catch(e) {
        hideLoading();
        alert(T('xi_conn_error'));
        console.error(e);
    }
}

function showXiResult(data, forced = false) {
    // Colorear slots en el campo y revelar foto del jugador oculto
    data.results.forEach(r => {
        const slotEl   = document.getElementById(`slot_${r.slot}`);
        const nameEl   = document.getElementById(`slotname_${r.slot}`);
        if (!slotEl) return;
        slotEl.classList.remove('hidden');
        slotEl.classList.add(r.is_correct ? 'correct' : 'wrong');
        if (nameEl) {
            nameEl.textContent   = r.correct_name;
            nameEl.style.opacity = '1';
        }
        // Revelar la foto real del jugador oculto
        const circle = slotEl.querySelector('.xi-slot-circle');
        if (circle && r.photo) {
            circle.innerHTML = ''; // quitar â“
            const img = document.createElement('img');
            img.className = 'player-photo';
            img.src       = r.photo;
            img.alt       = r.correct_name;
            img.onerror   = () => { img.style.display='none'; };
            circle.appendChild(img);
        }
    });

    // PuntuaciÃ³n
    const pct = data.accuracy;
    let emoji = forced && pct < 100 ? 'â°' : pct === 100 ? 'ğŸ†' : pct >= 70 ? 'ğŸ‘' : pct >= 40 ? 'ğŸ˜…' : 'ğŸ˜¬';
    document.getElementById('xiResultScore').textContent  = `${emoji} ${data.score} ${T('xi_pts')}`;
    const extraMsg = forced ? T('xi_time_msg') : '';
    document.getElementById('xiResultDetail').textContent =
        `${data.correct}${T('xi_of')}${data.total_hidden}${T('xi_corrects')}${pct}${T('xi_correct_pct')}${extraMsg}`;

    // Filas de detalle con mini-foto
    const rows = document.getElementById('xiResultRows');
    rows.innerHTML = data.results.map(r => `
        <div class="xi-result-row ${r.is_correct ? 'ok' : 'fail'}">
            ${r.photo ? `<img class="result-row-photo" src="${r.photo}" alt="${r.correct_name}" onerror="this.style.display='none'">` : `<span class="slot-label">${r.slot}</span>`}
            <span class="answer-given">${r.user_answer || 'â€”'}</span>
            <span class="correct-ans">${r.is_correct ? 'âœ…' : 'âŒ'} ${r.correct_name}</span>
        </div>
    `).join('');

    // Curiosidad
    document.getElementById('xiCuriosity').innerHTML =
        `<strong>${T('xi_curiosity_label')}</strong>${data.curiosity}`;

    document.getElementById('xiResultCard').classList.add('show');
    document.getElementById('xiCheckBtn').style.display = 'none';
    document.getElementById('xiNextBtn').style.display  = 'block';

    // Scroll al resultado
    document.getElementById('xiResultCard').scrollIntoView({ behavior: 'smooth' });

    // Sumar puntos al marcador del juego
    userScore += data.score;
    document.getElementById('scoreDisplay').textContent = userScore;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE DUELOS PVP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let pvpCurrentWager = 'none';           // 'none' | 'xp' | 'player'
let pvpSelectedPlayerId = null;         // id del jugador apostado
let pvpPendingChallengeData = null;     // datos a enviar tras confirmaciÃ³n

function pvpShowTab(tab) {
    ['challenge','pending','active'].forEach(t => {
        document.getElementById(`pvpTabContent${t.charAt(0).toUpperCase()+t.slice(1)}`).style.display = (t === tab) ? 'block' : 'none';
        document.getElementById(`pvpTab${t.charAt(0).toUpperCase()+t.slice(1)}`).classList.toggle('active', t === tab);
    });
    if (tab === 'pending')  pvpLoadPending();
    if (tab === 'active')   pvpLoadActive();
    if (tab === 'challenge') pvpLoadMyPlayers();
}

// â”€â”€ Buscar usuario â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _pvpSearchTimer = null;
function pvpSearchUser(val) {
    clearTimeout(_pvpSearchTimer);
    document.getElementById('pvpUserFound').style.display = 'none';
    document.getElementById('pvpUserNotFound').style.display = 'none';
    if (!val.trim() || val.trim().length < 2) return;
    _pvpSearchTimer = setTimeout(async () => {
        try {
            const r = await fetch(`${API_URL}/user/${encodeURIComponent(val.trim())}/players`);
            if (r.ok) {
                const d = await r.json();
                const initial = (d.username || '?')[0].toUpperCase();
                document.getElementById('pvpFoundAvatar').textContent = initial;
                document.getElementById('pvpFoundName').textContent   = d.username;
                document.getElementById('pvpFoundLevel').textContent  = `${d.unlocked_count} cartas`;
                document.getElementById('pvpUserFound').style.display = 'flex';
                document.getElementById('pvpUserNotFound').style.display = 'none';
            } else {
                document.getElementById('pvpUserFound').style.display = 'none';
                document.getElementById('pvpUserNotFound').style.display = 'block';
            }
        } catch {
            document.getElementById('pvpUserFound').style.display = 'none';
        }
    }, 600);
}

// â”€â”€ SelecciÃ³n tipo de apuesta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pvpSelectWager(type) {
    pvpCurrentWager = type;
    pvpSelectedPlayerId = null;
    ['none','xp','player'].forEach(t => {
        document.getElementById(`wager${t.charAt(0).toUpperCase()+t.slice(1)}`).classList.toggle('active', t === type);
    });
    document.getElementById('pvpWagerXpDiv').style.display    = (type === 'xp')     ? 'block' : 'none';
    document.getElementById('pvpWagerPlayerDiv').style.display = (type === 'player') ? 'block' : 'none';

    if (type === 'xp') {
        // Mostrar XP del usuario
        fetch(`${API_URL}/user/${encodeURIComponent(currentUser.username)}/xp`)
            .then(r => r.json())
            .then(d => { document.getElementById('pvpMyXpLabel').textContent = `Tu XP: â­ ${(d.xp||0).toLocaleString()}`; })
            .catch(() => {});
    }
    if (type === 'player') pvpLoadMyPlayers();
}

// â”€â”€ Cargar jugadores propios para apuesta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pvpLoadMyPlayers() {
    const container = document.getElementById('pvpPlayerPickList');
    if (!container) return;
    if (pvpCurrentWager !== 'player') return;
    try {
        const r = await fetch(`${API_URL}/user/${encodeURIComponent(currentUser.username)}/players`);
        const d = await r.json();
        container.innerHTML = '';
        const owned = d.unlocked || [];
        if (owned.length === 0) {
            container.innerHTML = '<div class="pvp-empty" style="padding:10px 0;">Sin cartas desbloqueadas</div>';
            return;
        }
        owned.forEach(p => {
            const chip = document.createElement('div');
            chip.className = 'pvp-player-chip';
            chip.dataset.pid = p.id;
            chip.innerHTML = `
                <img src="${p.photo||''}" referrerpolicy="no-referrer" onerror="this.style.display='none'" />
                <div class="chip-name rarity-${p.rarity}">${p.name}</div>
                <div style="font-size:0.65em;color:var(--text3);">â­${p.rating}</div>`;
            chip.onclick = () => pvpSelectPlayer(p, chip);
            container.appendChild(chip);
        });
    } catch {
        container.innerHTML = '<div style="color:#FF6B6B;font-size:0.82em;padding:8px 0;">Error cargando cartas.</div>';
    }
}

function pvpSelectPlayer(player, chipEl) {
    pvpSelectedPlayerId = player.id;
    document.querySelectorAll('.pvp-player-chip').forEach(c => c.classList.remove('selected'));
    chipEl.classList.add('selected');
    const infoEl = document.getElementById('pvpSelectedPlayerInfo');
    const rarityColors = {diamante:'#00BCD4',leyenda:'#FF6F00',oro:'#FFD700',plata:'#C0C0C0',bronce:'#CD7F32'};
    infoEl.style.display = 'flex';
    infoEl.innerHTML = `
        <img src="${player.photo||''}" referrerpolicy="no-referrer" onerror="this.style.display='none'" />
        <div>
            <div class="sp-name">${player.name}</div>
            <div class="sp-rarity" style="color:${rarityColors[player.rarity]||'white'};">${player.position} Â· â­${player.rating} Â· ${player.rarity.toUpperCase()}</div>
        </div>`;
}

// â”€â”€ Enviar desafÃ­o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pvpSendChallenge() {
    const opponent = document.getElementById('pvpOpponentInput').value.trim();
    if (!opponent) { alert('Escribe el nombre del rival'); return; }
    if (opponent === currentUser.username) { alert('No puedes desafiarte a ti mismo'); return; }

    const wagerType = pvpCurrentWager === 'none' ? null : pvpCurrentWager;
    const xpAmount  = parseInt(document.getElementById('pvpXpAmount')?.value || 0) || 0;

    if (wagerType === 'xp' && xpAmount < 100) {
        alert('La apuesta mÃ­nima de XP es 100'); return;
    }
    if (wagerType === 'player' && !pvpSelectedPlayerId) {
        alert('Selecciona el jugador a apostar'); return;
    }

    // Guardar datos del reto para confirmar
    pvpPendingChallengeData = { opponent, wagerType, xpAmount, playerId: pvpSelectedPlayerId };

    // Mostrar modal de confirmaciÃ³n
    const wagerDesc = wagerType === 'xp'
        ? `â­ ${xpAmount.toLocaleString()} XP`
        : wagerType === 'player'
            ? `ğŸƒ ${document.querySelector('.pvp-player-chip.selected span')?.textContent || 'un jugador'}`
            : 'Sin apuesta';
    document.getElementById('pvpWagerModalText').innerHTML =
        `DesafiarÃ¡s a <strong>${opponent}</strong><br>Apuesta: <strong>${wagerDesc}</strong><br><em style="font-size:0.85em;color:rgba(255,255,255,0.5);">Esta acciÃ³n no se puede deshacer.</em>`;
    document.getElementById('pvpWagerModalEmoji').textContent = wagerType ? 'ğŸ’°' : 'âš”ï¸';

    const modal = document.getElementById('pvpWagerModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.style.opacity = '1', 10);
}

function pvpCloseWagerModal() {
    const modal = document.getElementById('pvpWagerModal');
    modal.style.opacity = '0';
    setTimeout(() => modal.style.display = 'none', 300);
}

async function pvpConfirmSend() {
    pvpCloseWagerModal();
    if (!pvpPendingChallengeData) return;
    const { opponent, wagerType, xpAmount, playerId } = pvpPendingChallengeData;

    const resultEl = document.getElementById('pvpSendResult');
    resultEl.style.display = 'none';

    try {
        const body = {
            challenger: currentUser.username,
            opponent_username: opponent,
            wager_type: wagerType,
            wager_xp_amount: xpAmount,
            wager_player_id: playerId,
        };
        const r = await fetch(`${API_URL}/duel/challenge`, {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        const d = await r.json();
        if (!r.ok || d.error) {
            resultEl.style.cssText = 'display:block;background:rgba(255,100,100,0.12);border:1px solid rgba(255,100,100,0.35);border-radius:10px;padding:9px 12px;color:#FF6B6B;';
            resultEl.textContent = `âŒ ${d.error || 'Error enviando desafÃ­o'}`;
        } else {
            resultEl.style.cssText = 'display:block;background:rgba(0,200,83,0.1);border:1px solid rgba(0,200,83,0.3);border-radius:10px;padding:9px 12px;color:#00C853;';
            resultEl.innerHTML = `âœ… DesafÃ­o enviado a <strong>${opponent}</strong>`;
            document.getElementById('pvpOpponentInput').value = '';
            document.getElementById('pvpUserFound').style.display = 'none';
            pvpSelectWager('none');
            pvpPendingChallengeData = null;
            await pvpLoadPendingBadge();
        }
    } catch {
        resultEl.style.cssText = 'display:block;background:rgba(255,100,100,0.15);border:1px solid rgba(255,100,100,0.4);border-radius:10px;padding:12px;color:#FF6B6B;';
        resultEl.textContent = 'âŒ Error de conexiÃ³n';
    }
}

// â”€â”€ Cargar desafÃ­os pendientes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pvpLoadPending() {
    const list = document.getElementById('pvpPendingList');
    if (!list) return;
    list.innerHTML = '<div class="pvp-empty"><div class="pvp-empty-icon">â³</div>Cargandoâ€¦</div>';
    try {
        const r = await fetch(`${API_URL}/duel/pending/${encodeURIComponent(currentUser.username)}`);
        const d = await r.json();
        const pending = d.pending || [];
        pvpUpdateBadge(pending.length);
        if (pending.length === 0) {
            list.innerHTML = '<div class="pvp-empty"><div class="pvp-empty-icon">ğŸ“¬</div>Sin desafÃ­os pendientes</div>';
            return;
        }
        list.innerHTML = '';
        pending.forEach(ch => { list.appendChild(pvpBuildChallengeCard(ch)); });
    } catch {
        list.innerHTML = '<div class="pvp-empty" style="color:var(--danger);">Error cargando desafÃ­os</div>';
    }
}

async function pvpLoadActive() {
    const list = document.getElementById('pvpActiveList');
    if (!list) return;
    list.innerHTML = '<div class="pvp-empty"><div class="pvp-empty-icon">â³</div>Cargandoâ€¦</div>';
    try {
        const r = await fetch(`${API_URL}/duel/pending/${encodeURIComponent(currentUser.username)}`);
        const d = await r.json();
        const active = d.active || [];
        if (active.length === 0) {
            list.innerHTML = '<div class="pvp-empty"><div class="pvp-empty-icon">âš”ï¸</div>Sin duelos en curso</div>';
            return;
        }
        list.innerHTML = '';
        active.forEach(ch => { list.appendChild(pvpBuildActiveCard(ch)); });
    } catch {
        list.innerHTML = '<div class="pvp-empty" style="color:var(--danger);">Error cargando duelos</div>';
    }
}

function pvpBuildChallengeCard(ch) {
    const card = document.createElement('div');
    card.className = 'pvp-challenge-card';
    const wagerText = ch.wager_type === 'xp'
        ? `â­ ${ch.wager_xp_amount?.toLocaleString()} XP`
        : ch.wager_type === 'player' && ch.wager_player
            ? `ğŸƒ ${ch.wager_player.name}`
            : 'Sin apuesta';
    const initial = (ch.challenger_name || '?')[0].toUpperCase();
    const dateStr  = new Date(ch.created_at).toLocaleDateString('es', {day:'numeric',month:'short'});
    card.innerHTML = `
        <div class="pvp-card-top">
            <div class="pvp-card-avatar">${initial}</div>
            <div class="pvp-card-info">
                <div class="pvp-card-name">âš”ï¸ ${ch.challenger_name} te desafÃ­a</div>
                <div class="pvp-card-wager">${wagerText}</div>
            </div>
            <div class="pvp-card-time">${dateStr}</div>
        </div>
        <div class="pvp-challenge-btns">
            <button class="pvp-accept-btn">âœ… Aceptar</button>
            <button class="pvp-reject-btn">âŒ Rechazar</button>
        </div>`;
    card.querySelector('.pvp-accept-btn').addEventListener('click', () => pvpRespondChallenge(ch.id, true));
    card.querySelector('.pvp-reject-btn').addEventListener('click', () => pvpRespondChallenge(ch.id, false));
    return card;
}

function pvpBuildActiveCard(ch) {
    const isChallenger = ch.challenger_name === currentUser.username;
    const rival = isChallenger ? ch.opponent_name : ch.challenger_name;
    const card = document.createElement('div');
    card.className = 'pvp-active-card';

    const wagerText = ch.wager_type === 'xp'
        ? `â­ ${ch.wager_xp_amount?.toLocaleString()} XP en juego`
        : ch.wager_type === 'player' && ch.wager_player
            ? `ğŸƒ ${ch.wager_player.name} en juego`
            : 'Sin apuesta';

    // Determinar si hay sesiÃ³n activa (rival tambiÃ©n conectado recientemente)
    const hasSession    = ch.has_active_session === true;
    const ageMin        = ch.age_minutes || 0;
    const ageText       = ageMin < 60
        ? `Hace ${ageMin} min`
        : `Hace ${Math.floor(ageMin/60)}h ${ageMin%60}min`;

    // Estado visual de la sesiÃ³n
    let sessionBadge = '';
    let actionBtns   = '';

    if (hasSession) {
        // Hay heartbeat reciente â†’ rival conectado, se puede jugar
        sessionBadge = `<span style="color:#00C853;font-size:0.72em;font-weight:700;">â— Rival en lÃ­nea</span>`;
        actionBtns   = `<button class="pvp-play-duel-btn pvp-btn-play">â–¶ï¸ Entrar al duelo</button>`;
    } else {
        // Sin sesiÃ³n activa â†’ mostrar alerta y opciÃ³n de cancelar
        sessionBadge = `<span style="color:var(--danger);font-size:0.72em;font-weight:700;">â— Rival no conectado</span>`;
        actionBtns   = `
            <button class="pvp-play-duel-btn pvp-btn-play" style="background:linear-gradient(135deg,#444,#666);color:rgba(255,255,255,0.6);cursor:not-allowed;" disabled>
                â³ Esperando rivalâ€¦
            </button>
            <button class="pvp-play-duel-btn pvp-btn-cancel" style="background:rgba(255,50,50,0.2);border:1px solid rgba(255,50,50,0.4);color:#FF6B6B;margin-top:6px;">
                ğŸ—‘ï¸ Cancelar partida
            </button>`;
    }

    card.innerHTML = `
        <div class="pvp-active-vs">
            <div class="pvp-active-player">
                <div class="ap-name">TÃº</div>
            </div>
            <div class="pvp-vs-badge">VS</div>
            <div class="pvp-active-player">
                <div class="ap-name">${rival}</div>
            </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <div class="pvp-active-wager" style="margin:0;">${wagerText}</div>
            <div style="display:flex;align-items:center;gap:6px;">
                ${sessionBadge}
                <span style="color:var(--text3);font-size:0.68em;">${ageText}</span>
            </div>
        </div>
        <div class="pvp-active-actions">
            ${actionBtns}
        </div>`;

    const playBtn   = card.querySelector('.pvp-btn-play');
    const cancelBtn = card.querySelector('.pvp-btn-cancel');
    if (playBtn && !playBtn.disabled)   playBtn.addEventListener('click',   () => pvpStartMyDuel(ch.id, rival));
    if (cancelBtn)                       cancelBtn.addEventListener('click', () => pvpAbandonDuel(ch.id, card));
    return card;
}

async function pvpAbandonDuel(challengeId, cardEl) {
    const hasWager = cardEl.querySelector('.pvp-active-wager')?.textContent?.includes('en juego');
    const msg = hasWager
        ? 'âš ï¸ Â¿Seguro que quieres cancelar? Si el rival ya jugÃ³, podrÃ­a ganar por WO y llevarse la apuesta.'
        : 'Â¿Cancelar esta partida? Se eliminarÃ¡ sin penalizaciÃ³n.';
    if (!confirm(msg)) return;

    const cancelBtn = cardEl.querySelector('.pvp-btn-cancel');
    if (cancelBtn) { cancelBtn.disabled = true; cancelBtn.textContent = 'Cancelandoâ€¦'; }

    try {
        const r = await fetch(`${API_URL}/duel/abandon`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ username: currentUser.username, challenge_id: challengeId })
        });
        const d = await r.json();
        if (!r.ok || d.error) {
            showToast('âŒ ' + (d.error || 'Error al cancelar'));
        } else {
            showToast(d.wo ? 'âŒ Partida cancelada â€” el rival gana por WO' : 'âœ… Partida cancelada');
            cardEl.style.opacity = '0.4';
            cardEl.style.pointerEvents = 'none';
            setTimeout(() => pvpLoadActive(), 800);
        }
    } catch {
        showToast('Error de conexiÃ³n');
    }
}

async function pvpRespondChallenge(challengeId, accept) {
    try {
        const r = await fetch(`${API_URL}/duel/accept`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ username: currentUser.username, challenge_id: challengeId, accept })
        });
        const d = await r.json();
        if (!r.ok || d.error) {
            alert(`Error: ${d.error || 'Respuesta fallida'}`);
        } else {
            alert(accept ? 'âœ… Â¡DesafÃ­o aceptado! Ahora ve a "En Curso" para jugar.' : 'âŒ DesafÃ­o rechazado.');
            await pvpLoadPending();
        }
    } catch {
        alert('Error de conexiÃ³n');
    }
}

function pvpStartMyDuel(challengeId, rivalName) {
    // Guardar contexto del duelo real
    window._pvpActiveChallengeId = challengeId;
    window._pvpRivalName         = rivalName;
    window._pvpIsRealDuel        = true;

    // Configurar HUD con nombre del rival (modo real, no bot)
    document.getElementById('duelBotName').textContent  = rivalName || 'Rival';
    document.getElementById('duelPlayerName').textContent = currentUser?.username || 'TÃº';
    document.getElementById('duelPlayerScore').textContent = '0';
    document.getElementById('duelBotScore').textContent    = 'â€”';
    document.getElementById('duelHud').classList.add('active');
    document.getElementById('duelRivalStatus').textContent  = 'â— online';
    document.getElementById('duelRivalStatus').className    = 'duel-rival-status connected';

    // Iniciar sesiÃ³n de duelo en el servidor
    fetch(`${API_URL}/duel/session/start`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ username: currentUser.username, challenge_id: challengeId }),
    }).catch(() => {});

    // Iniciar heartbeat cada 8 s
    pvpStartHeartbeat(challengeId);

    // Iniciar partida (modo pvp, 10 preguntas)
    isDuelMode      = false; // no usar bot
    duelBotScore    = 0;
    duelPlayerScore = 0;
    startGame('pvp', 10);
}

// â”€â”€ Heartbeat del duelo real â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _pvpHeartbeatTimer = null;

function pvpStartHeartbeat(challengeId) {
    pvpStopHeartbeat();
    _pvpHeartbeatTimer = setInterval(async () => {
        if (!currentUser || !challengeId) return;
        try {
            const r = await fetch(`${API_URL}/duel/session/heartbeat`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ username: currentUser.username, challenge_id: challengeId }),
            });
            const d = await r.json();
            // Actualizar indicador de conexiÃ³n del rival
            const statusEl = document.getElementById('duelRivalStatus');
            if (statusEl) {
                if (d.rival_disconnected) {
                    statusEl.textContent = 'â— offline';
                    statusEl.className   = 'duel-rival-status disconnected';
                } else {
                    statusEl.textContent = 'â— online';
                    statusEl.className   = 'duel-rival-status connected';
                }
            }
        } catch {}
    }, 8000);
}

function pvpStopHeartbeat() {
    if (_pvpHeartbeatTimer) { clearInterval(_pvpHeartbeatTimer); _pvpHeartbeatTimer = null; }
}

// â”€â”€ Llamado al terminar una partida PvP real â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pvpFinishRealDuel(myScore) {
    const cid = window._pvpActiveChallengeId;
    if (!cid) return;

    pvpStopHeartbeat();
    document.getElementById('duelHud').classList.remove('active');

    // Mostrar overlay de espera al rival
    const overlay = document.getElementById('duelWaitRivalOverlay');
    document.getElementById('duelWaitMyScore').textContent = myScore.toLocaleString();
    document.getElementById('duelWaitTitle').textContent   = 'Esperando al rival...';
    document.getElementById('duelWaitSub').textContent     = 'Tu rival todavÃ­a estÃ¡ jugando. Espera hasta 60 s.';
    document.getElementById('duelWaitIcon').textContent    = 'â³';
    overlay.classList.add('active');

    // Enviar mi resultado al servidor
    let result = null;
    try {
        const r = await fetch(`${API_URL}/duel/session/finish`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ username: currentUser.username, challenge_id: cid, score: myScore }),
        });
        result = await r.json();
    } catch {
        overlay.classList.remove('active');
        return;
    }

    if (result.resolved) {
        // Ambos terminaron al mismo tiempo â†’ resultado inmediato
        overlay.classList.remove('active');
        pvpShowRealDuelResult(result, myScore);
        return;
    }

    // Esperar al rival con polling (mÃ¡x 60 s)
    let elapsed = 0;
    const MAX_WAIT = 60;
    const fill = document.getElementById('duelWaitFill');
    const pollInterval = setInterval(async () => {
        elapsed++;
        if (fill) fill.style.width = Math.max(0, 100 - (elapsed / MAX_WAIT * 100)) + '%';

        if (elapsed >= MAX_WAIT) {
            clearInterval(pollInterval);
            overlay.classList.remove('active');
            // Timeout: si el servidor tiene WO, usarlo; si no, no hacer nada
            try {
                const r2 = await fetch(`${API_URL}/duel/session/${cid}/status/${encodeURIComponent(currentUser.username)}`);
                const d2 = await r2.json();
                if (d2.state === 'finished') {
                    pvpShowRealDuelResult(d2, myScore);
                } else {
                    showToast('El rival no respondiÃ³ a tiempo. Partida sin resultado.');
                }
            } catch {}
            return;
        }

        try {
            const r2 = await fetch(`${API_URL}/duel/session/${cid}/status/${encodeURIComponent(currentUser.username)}`);
            const d2 = await r2.json();

            if (d2.rival_disconnected && d2.state !== 'finished') {
                // Rival desconectado: WO inmediato
                document.getElementById('duelWaitTitle').textContent = 'Â¡Rival desconectado!';
                document.getElementById('duelWaitSub').textContent   = 'Victoria por walkover...';
                document.getElementById('duelWaitIcon').textContent  = 'ğŸ†';
            }

            if (d2.state === 'finished') {
                clearInterval(pollInterval);
                overlay.classList.remove('active');
                pvpShowRealDuelResult(d2, myScore);
            }
        } catch {}
    }, 1000);
}

// â”€â”€ Mostrar resultado del duelo real â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pvpShowRealDuelResult(data, myScore) {
    const myUserId  = currentUser?.id;
    const winnerName = data.winner_username || '';
    const won = (winnerName === currentUser?.username) ||
                (data.winner_id && data.winner_id === myUserId);

    // Enriquecer data para el modal existente
    const rivalName = window._pvpRivalName || 'Rival';
    const isP1      = data.p1_name === currentUser?.username;
    const myFinalScore    = isP1 ? (data.p1_score ?? myScore) : (data.p2_score ?? myScore);
    const rivalFinalScore = isP1 ? (data.p2_score ?? 0) : (data.p1_score ?? 0);

    const modalData = {
        winner_username:  winnerName,
        challenger_score: myFinalScore,
        opponent_score:   rivalFinalScore,
        wager_result:     data.wager_result,
        duel_player_reward: null,
    };

    pvpShowResultModal(modalData);

    // Refrescar stats en el banner (sin bloquear)
    setTimeout(() => pvpLoadDuelStats(), 600);

    // Limpiar contexto
    window._pvpActiveChallengeId = null;
    window._pvpRivalName         = null;
    window._pvpIsRealDuel        = false;
}

// â”€â”€ Badge de notificaciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pvpUpdateBadge(count) {
    const badge = document.getElementById('pvpPendingBadge');
    const countEl = document.getElementById('pvpPendingCount');
    if (!badge) return;
    if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline-flex';
        if (countEl) { countEl.textContent = count; countEl.style.display = 'inline'; }
    } else {
        badge.style.display = 'none';
        if (countEl) countEl.style.display = 'none';
    }
}

async function pvpLoadPendingBadge() {
    if (!currentUser) return;
    try {
        const r = await fetch(`${API_URL}/duel/pending/${encodeURIComponent(currentUser.username)}`);
        const d = await r.json();
        pvpUpdateBadge(d.pending_count || 0);
    } catch {}
}

// â”€â”€ Mostrar resultado modal PvP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pvpShowResultModal(data) {
    const won = data.winner_username === currentUser.username;
    if (won) { Sound.playPvpWin(); if (navigator.vibrate) navigator.vibrate([100,50,200]); }
    else      { Sound.playPvpLose(); }
    document.getElementById('pvpResultEmoji').textContent = won ? 'ğŸ†' : 'ğŸ’€';
    document.getElementById('pvpResultTitle').textContent = won ? 'Â¡Ganaste el Duelo!' : 'Derrota...';

    const scoresEl = document.getElementById('pvpResultScores');
    scoresEl.innerHTML = `
        <div style="text-align:center;background:rgba(255,255,255,0.07);border-radius:10px;padding:10px 18px;">
            <div style="color:rgba(255,255,255,0.5);font-size:0.75em;">TÃº</div>
            <div style="color:white;font-size:1.4em;">${data.challenger_score || data.opponent_score}</div>
        </div>
        <div style="align-self:center;font-size:1.2em;">VS</div>
        <div style="text-align:center;background:rgba(255,255,255,0.07);border-radius:10px;padding:10px 18px;">
            <div style="color:rgba(255,255,255,0.5);font-size:0.75em;">${window._pvpRivalName||'Rival'}</div>
            <div style="color:white;font-size:1.4em;">${data.opponent_score || data.challenger_score}</div>
        </div>`;

    const wagerEl = document.getElementById('pvpResultWager');
    if (data.wager_result && data.wager_result.type) {
        wagerEl.style.display = 'block';
        if (data.wager_result.type === 'xp') {
            wagerEl.innerHTML = won
                ? `ğŸ’° <strong>+${data.wager_result.amount?.toLocaleString()} XP</strong> ganados`
                : `ğŸ’¸ <strong>-${data.wager_result.amount?.toLocaleString()} XP</strong> perdidos`;
        } else {
            const pname = data.wager_result.player?.name || 'Jugador';
            wagerEl.innerHTML = won
                ? `ğŸƒ Â¡Conseguiste a <strong>${pname}</strong>!`
                : `ğŸƒ Perdiste a <strong>${pname}</strong>`;
        }
    } else {
        wagerEl.style.display = 'none';
    }

    const rewardEl = document.getElementById('pvpResultReward');
    if (won && data.duel_player_reward) {
        const rp = data.duel_player_reward;
        rewardEl.style.display = 'block';
        rewardEl.innerHTML = `ğŸ… Recompensa por victoria: <strong class="rarity-${rp.rarity}">${rp.name}</strong>`;
    } else {
        rewardEl.style.display = 'none';
    }

    const modal = document.getElementById('pvpResultModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.style.opacity = '1', 10);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MATCHMAKING â€” Sistema de notificaciones 1v1
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MATCHMAKING â€” estado interno ampliado
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MM = {
    state: 'idle',   // idle | setup | waiting | matched | waiting_other | both_accepted | cancelled
    matchId: null, challengeId: null, rivalName: null,
    totalSecs: 30, secondsLeft: 30,
    pollTimer: null, countdownTimer: null,
    // apuesta
    wagerType: 'none',      // 'none' | 'xp' | 'player'
    wagerXpAmount: 0,
    wagerPlayerId: null,
    wagerPlayerName: '',
};

// â”€â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mmStopPolling()    { if (MM.pollTimer)     { clearInterval(MM.pollTimer);     MM.pollTimer     = null; } }
function mmStopCountdown()  { if (MM.countdownTimer){ clearInterval(MM.countdownTimer);MM.countdownTimer= null; } }

/** Muestra el overlay con el estado indicado */
function mmShowOverlay(state) {
    document.getElementById('matchmakingOverlay').classList.add('active');
    const map = {
        setup:         'mmStateSetup',
        waiting:       'mmStateWaiting',
        matched:       'mmStateMatched',
        waiting_other: 'mmStateWaitingOther',
        both_accepted: 'mmStateAccepted',
        cancelled:     'mmStateCancelled',
    };
    Object.values(map).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
    const target = document.getElementById(map[state]);
    if (target) target.style.display = '';
}

/** Cierra el overlay y resetea el estado */
function mmClose() {
    document.getElementById('matchmakingOverlay').classList.remove('active');
    mmStopPolling(); mmStopCountdown();
    MM.state = 'idle'; MM.matchId = null; MM.challengeId = null; MM.rivalName = null;
    const btn = document.getElementById('mmSearchBtn');
    if (btn) { btn.textContent = 'ğŸ” Buscar Rival 1v1'; btn.disabled = false; }
}

// â”€â”€â”€ SETUP â€” configurar apuesta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** Punto de entrada desde el botÃ³n del menÃº */
function mmOpenSetup() {
    if (!currentUser) { showToast('Inicia sesiÃ³n primero'); return; }
    MM.wagerType = 'none'; MM.wagerXpAmount = 0; MM.wagerPlayerId = null; MM.wagerPlayerName = '';
    mmShowOverlay('setup');
    mmSelectWager('none');
}

/** Cambia el tipo de apuesta seleccionado */
async function mmSelectWager(type) {
    MM.wagerType = type;
    // Actualizar botones activos
    ['none','xp','player'].forEach(t => {
        const btn = document.getElementById('mmOpt' + t.charAt(0).toUpperCase() + t.slice(1));
        if (btn) btn.classList.toggle('active', t === type);
    });
    // Mostrar/ocultar detalle
    const xpDiv     = document.getElementById('mmWagerDetailXp');
    const playerDiv = document.getElementById('mmWagerDetailPlayer');
    if (xpDiv)     xpDiv.style.display     = (type === 'xp')     ? '' : 'none';
    if (playerDiv) playerDiv.style.display = (type === 'player') ? '' : 'none';

    if (type === 'xp') {
        // Mostrar XP disponible
        try {
            const r = await fetch(`${API_URL}/user/profile/${encodeURIComponent(currentUser.username)}`);
            const d = await r.json();
            const hint = document.getElementById('mmXpHint');
            if (hint) hint.textContent = `Tienes ${(d.xp || 0).toLocaleString()} pts disponibles`;
        } catch {}
    } else if (type === 'player') {
        mmLoadMyPlayers();
    }
}

/** Carga los jugadores del usuario como chips seleccionables */
async function mmLoadMyPlayers() {
    const scroll = document.getElementById('mmPlayerScroll');
    if (!scroll) return;
    scroll.innerHTML = '<div style="color:var(--text2);font-size:0.82em;padding:8px;">Cargando jugadores...</div>';
    try {
        const r = await fetch(`${API_URL}/players/my-collection/${encodeURIComponent(currentUser.username)}`);
        const players = await r.json();
        if (!players.length) {
            scroll.innerHTML = '<div style="color:var(--text2);font-size:0.82em;padding:8px;">No tienes jugadores en tu colecciÃ³n.</div>';
            return;
        }
        scroll.innerHTML = players.map(p => `
            <div class="mm-player-chip" id="mmChip${p.id}"
                 onclick="mmSelectPlayer(${p.id}, '${(p.name||'').replace(/'/g,"\\'")}', '${p.rarity||''}')">
                <span class="mm-player-chip-name">${p.name || p.player_name || 'Jugador'}</span>
                <span class="mm-player-chip-rarity rarity-${p.rarity || 'comun'}">${p.rarity || ''}</span>
            </div>
        `).join('');
    } catch (e) {
        scroll.innerHTML = '<div style="color:var(--danger);font-size:0.82em;padding:8px;">Error al cargar jugadores.</div>';
    }
}

/** Selecciona un jugador como apuesta */
function mmSelectPlayer(id, name, rarity) {
    MM.wagerPlayerId   = id;
    MM.wagerPlayerName = name;
    // Marcar chip seleccionado
    document.querySelectorAll('.mm-player-chip').forEach(c => c.classList.remove('selected'));
    const chip = document.getElementById('mmChip' + id);
    if (chip) chip.classList.add('selected');
    const info = document.getElementById('mmSelectedPlayerInfo');
    if (info) { info.textContent = `Apostando: ${name} (${rarity})`; info.style.display = ''; }
}

/** Valida la configuraciÃ³n y entra en la cola de matchmaking */
async function mmConfirmSetupAndSearch() {
    const body = { username: currentUser.username };

    if (MM.wagerType === 'xp') {
        const amt = parseInt(document.getElementById('mmXpInput')?.value || '0', 10);
        if (!amt || amt < 100) { showToast('Introduce una cantidad vÃ¡lida de pts (mÃ­n. 100)'); return; }
        body.wager_type       = 'xp';
        body.wager_xp_amount  = amt;
        MM.wagerXpAmount = amt;
    } else if (MM.wagerType === 'player') {
        if (!MM.wagerPlayerId) { showToast('Selecciona un jugador para apostar'); return; }
        body.wager_type      = 'player';
        body.wager_player_id = MM.wagerPlayerId;
    }

    // Mostrar spinner de bÃºsqueda
    const wagerLabel = document.getElementById('mmWaitingWagerLabel');
    if (wagerLabel) {
        if (MM.wagerType === 'xp')     wagerLabel.textContent = `â­ Apostando ${MM.wagerXpAmount.toLocaleString()} pts`;
        else if (MM.wagerType === 'player') wagerLabel.textContent = `ğŸƒ Apostando a ${MM.wagerPlayerName}`;
        else wagerLabel.textContent = 'ğŸ¤ Sin apuesta';
    }
    mmShowOverlay('waiting');

    try {
        const res = await fetch(`${API_URL}/matchmaking/join`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
        });
        const data = await res.json();
        if (data.error) { showToast(data.error); mmShowOverlay('setup'); return; }
    } catch (e) {
        showToast('Error de conexiÃ³n'); mmShowOverlay('setup'); return;
    }

    MM.state = 'waiting';
    mmStartPolling();
}

// â”€â”€â”€ CANCEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function mmCancelQueue() {
    mmStopPolling(); mmStopCountdown();
    try {
        await fetch(`${API_URL}/matchmaking/cancel`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: currentUser.username }),
        });
    } catch {}
    mmClose();
}

// â”€â”€â”€ RESPONDER (aceptar/rechazar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function mmRespondMatch(accept) {
    if (!MM.matchId) return;
    document.querySelectorAll('.mm-btn-accept,.mm-btn-reject').forEach(b => b.disabled = true);
    try {
        const res = await fetch(`${API_URL}/matchmaking/respond`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: currentUser.username, match_id: MM.matchId, accept }),
        });
        const data = await res.json();

        if (!accept || data.state === 'cancelled') {
            mmStopCountdown(); mmStopPolling();
            MM.state = 'cancelled';
            document.getElementById('mmCancelledTitle').textContent = accept ? 'Partida cancelada' : 'Rechazaste la partida';
            document.getElementById('mmCancelledSub').textContent   = accept ? 'El rival rechazÃ³ la partida.' : 'Has rechazado la partida.';
            mmShowOverlay('cancelled');
            const btn = document.getElementById('mmSearchBtn');
            if (btn) { btn.textContent='ğŸ” Buscar Rival 1v1'; btn.disabled=false; }
            return;
        }
        if (data.state === 'both_accepted') {
            mmStopCountdown();
            MM.state = 'both_accepted'; MM.challengeId = data.challenge_id;
            document.getElementById('mmAcceptedSub').textContent = `Iniciando duelo vs ${MM.rivalName}...`;
            mmShowOverlay('both_accepted');
            setTimeout(() => mmLaunchDuel(), 1800);
            return;
        }
        MM.state = 'waiting_other';
        mmShowOverlay('waiting_other');
    } catch (e) {
        showToast('Error al responder');
        document.querySelectorAll('.mm-btn-accept,.mm-btn-reject').forEach(b => b.disabled = false);
    }
}

function mmLaunchDuel() {
    mmClose();
    if (MM.challengeId && MM.rivalName) pvpStartMyDuel(MM.challengeId, MM.rivalName);
}

// â”€â”€â”€ COUNTDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mmStartCountdown(seconds) {
    mmStopCountdown();
    MM.totalSecs = seconds || 30; MM.secondsLeft = MM.totalSecs;
    mmUpdateCountdownUI();
    MM.countdownTimer = setInterval(() => {
        MM.secondsLeft--;
        if (MM.secondsLeft <= 0) {
            mmStopCountdown(); mmStopPolling();
            MM.state = 'cancelled';
            document.getElementById('mmCancelledTitle').textContent = 'Â¡Tiempo agotado!';
            document.getElementById('mmCancelledSub').textContent   = 'No respondiste a tiempo.';
            mmShowOverlay('cancelled');
            const btn = document.getElementById('mmSearchBtn');
            if (btn) { btn.textContent='ğŸ” Buscar Rival 1v1'; btn.disabled=false; }
        } else { mmUpdateCountdownUI(); }
    }, 1000);
}

function mmUpdateCountdownUI() {
    const pct   = (MM.secondsLeft / MM.totalSecs) * 100;
    const fill  = document.getElementById('mmCountdownFill');
    const label = document.getElementById('mmCountdownSecs');
    if (fill)  fill.style.width = pct + '%';
    if (label) label.textContent = MM.secondsLeft;
    if (fill)  fill.style.background = MM.secondsLeft <= 10
        ? 'linear-gradient(90deg,var(--danger),#FF8C00)'
        : 'linear-gradient(90deg,var(--primary),var(--secondary))';
}

// â”€â”€â”€ POLLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mmStartPolling() {
    mmStopPolling();
    MM.pollTimer = setInterval(mmPollStatus, 2500);
}

async function mmPollStatus() {
    if (!currentUser) { mmStopPolling(); return; }
    try {
        const res = await fetch(`${API_URL}/matchmaking/status/${encodeURIComponent(currentUser.username)}`);
        if (!res.ok) return;
        const data = await res.json();
        mmHandleStatusUpdate(data);
    } catch {}
}

function mmHandleStatusUpdate(data) {
    const { state, match_id, opponent, seconds_left, challenge_id, reason } = data;
    switch (state) {

        case 'not_in_queue':
        case 'cancelled':
            if (MM.state !== 'cancelled' && MM.state !== 'idle') {
                mmStopPolling(); mmStopCountdown();
                MM.state = 'cancelled';
                document.getElementById('mmCancelledTitle').textContent = 'Partida cancelada';
                document.getElementById('mmCancelledSub').textContent = reason === 'expired'
                    ? 'El tiempo de aceptaciÃ³n expirÃ³.'
                    : 'La partida fue cancelada o rechazada.';
                mmShowOverlay('cancelled');
                const btn = document.getElementById('mmSearchBtn');
                if (btn) { btn.textContent='ğŸ” Buscar Rival 1v1'; btn.disabled=false; }
            }
            break;

        case 'waiting':
            if (MM.state !== 'waiting') { MM.state = 'waiting'; mmShowOverlay('waiting'); }
            break;

        case 'matched':
            if (MM.state !== 'matched' && MM.state !== 'waiting_other') {
                MM.state = 'matched'; MM.matchId = match_id; MM.rivalName = opponent;

                // Avatares
                document.getElementById('mmMyAvatar').textContent   = (currentUser.username||'Y')[0].toUpperCase();
                document.getElementById('mmMyName').textContent      = currentUser.username || '';
                document.getElementById('mmRivalAvatar').textContent = (opponent||'?')[0].toUpperCase();
                document.getElementById('mmRivalName').textContent   = opponent || '...';

                // Pill de apuesta
                const pillEl = document.getElementById('mmWagerPill');
                if (pillEl) {
                    if (data.wager_type === 'xp') {
                        pillEl.className = 'mm-wager-pill';
                        pillEl.textContent = `â­ ${(data.wager_xp_amount||0).toLocaleString()} pts en juego`;
                    } else if (data.wager_type === 'player') {
                        pillEl.className = 'mm-wager-pill';
                        pillEl.textContent = `ğŸƒ ${data.wager_player_name || 'Jugador'} en juego`;
                    } else {
                        pillEl.className = 'mm-wager-pill no-wager';
                        pillEl.textContent = 'ğŸ¤ Sin apuesta';
                    }
                }

                mmShowOverlay('matched');
                mmStartCountdown(seconds_left || 30);
                if (navigator.vibrate) navigator.vibrate([100,80,200]);
                try { Sound.playUnlock(); } catch {}
            } else if (MM.state === 'matched') {
                MM.secondsLeft = seconds_left;
                mmUpdateCountdownUI();
            }
            break;

        case 'waiting_other':
            if (MM.state !== 'waiting_other') { MM.state = 'waiting_other'; mmShowOverlay('waiting_other'); }
            break;

        case 'both_accepted':
            if (MM.state !== 'both_accepted') {
                mmStopCountdown();
                MM.state = 'both_accepted'; MM.challengeId = challenge_id; MM.rivalName = opponent || MM.rivalName;
                document.getElementById('mmAcceptedSub').textContent = `Iniciando duelo vs ${MM.rivalName}...`;
                mmShowOverlay('both_accepted');
                mmStopPolling();
                setTimeout(() => mmLaunchDuel(), 1800);
            }
            break;
    }
}

</script>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MATCHMAKING OVERLAY â€” notificaciones 1v1
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="matchmakingOverlay" role="dialog" aria-modal="true" aria-label="Matchmaking">
    <div class="mm-sheet">
        <div class="mm-drag-handle"></div>

        <!-- â‘  SETUP: configurar apuesta antes de buscar -->
        <div id="mmStateSetup" style="display:none;">
            <div class="mm-setup-title">âš”ï¸ Duelo 1v1 Real</div>
            <div class="mm-setup-sub">Elige quÃ© quieres apostar en esta partida</div>

            <div class="mm-wager-options">
                <button class="mm-wager-opt active" id="mmOptNone"   onclick="mmSelectWager('none')">ğŸ¤ Sin apuesta</button>
                <button class="mm-wager-opt"        id="mmOptXp"     onclick="mmSelectWager('xp')">â­ Pts</button>
                <button class="mm-wager-opt"        id="mmOptPlayer" onclick="mmSelectWager('player')">ğŸƒ Jugador</button>
            </div>

            <!-- Detalle apuesta XP -->
            <div class="mm-wager-detail" id="mmWagerDetailXp" style="display:none;">
                <input type="number" id="mmXpInput" class="mm-wager-input"
                    placeholder="Cantidad de pts a apostar..." min="100" step="100"/>
                <div class="mm-xp-hint" id="mmXpHint">Tus pts: cargando...</div>
            </div>

            <!-- Detalle apuesta jugador -->
            <div class="mm-wager-detail" id="mmWagerDetailPlayer" style="display:none;">
                <div id="mmPlayerScroll" class="mm-player-scroll">
                    <div style="color:var(--text2);font-size:0.82em;padding:8px;">Cargando jugadores...</div>
                </div>
                <div id="mmSelectedPlayerInfo" style="display:none;margin-top:8px;font-size:0.82em;color:var(--secondary);"></div>
            </div>

            <button class="mm-btn-accept" style="width:100%;margin-top:4px;" onclick="mmConfirmSetupAndSearch()">
                ğŸ” Buscar rival
            </button>
            <button class="mm-btn-reject" style="width:100%;margin-top:8px;" onclick="mmClose()">
                Cancelar
            </button>
        </div>

        <!-- â‘¡ WAITING: buscando rival -->
        <div id="mmStateWaiting" class="mm-waiting" style="display:none;">
            <div class="mm-waiting-icon">ğŸ”</div>
            <div class="mm-waiting-title">Buscando rival...</div>
            <div class="mm-waiting-sub" id="mmWaitingWagerLabel">Sin apuesta</div>
            <div class="mm-dots"><span></span><span></span><span></span></div>
            <button class="mm-btn-reject" style="margin-top:20px;width:100%;" onclick="mmCancelQueue()">Cancelar bÃºsqueda</button>
        </div>

        <!-- â‘¢ MATCHED: rival encontrado â€” esperando respuesta -->
        <div id="mmStateMatched" class="mm-matched" style="display:none;">
            <div class="mm-matched-badge">Â¡Rival encontrado!</div>
            <div class="mm-rival-row">
                <div>
                    <div class="mm-avatar" id="mmMyAvatar"></div>
                    <div class="mm-rival-name" id="mmMyName"></div>
                </div>
                <div class="mm-vs-sep">VS</div>
                <div>
                    <div class="mm-avatar" id="mmRivalAvatar"></div>
                    <div class="mm-rival-name" id="mmRivalName">...</div>
                </div>
            </div>
            <!-- Pill de apuesta -->
            <div id="mmWagerPill" class="mm-wager-pill no-wager">ğŸ¤ Sin apuesta</div>
            <div class="mm-countdown-bar">
                <div class="mm-countdown-fill" id="mmCountdownFill" style="width:100%;"></div>
            </div>
            <div class="mm-countdown-label">â± <span id="mmCountdownSecs">30</span>s para aceptar</div>
            <div class="mm-actions">
                <button class="mm-btn-accept" onclick="mmRespondMatch(true)">âœ… Aceptar</button>
                <button class="mm-btn-reject" onclick="mmRespondMatch(false)">âŒ Rechazar</button>
            </div>
        </div>

        <!-- â‘£ WAITING_OTHER: esperando que el otro jugador acepte -->
        <div id="mmStateWaitingOther" class="mm-accepted" style="display:none;">
            <div class="mm-accepted-icon">â³</div>
            <div class="mm-accepted-title">Esperando al rival...</div>
            <div class="mm-accepted-sub">Aceptaste la partida. Esperando confirmaciÃ³n del otro jugador.</div>
        </div>

        <!-- â‘¤ BOTH_ACCEPTED: ambos aceptaron -->
        <div id="mmStateAccepted" class="mm-accepted" style="display:none;">
            <div class="mm-accepted-icon">âš¡</div>
            <div class="mm-accepted-title">Â¡Partida confirmada!</div>
            <div class="mm-accepted-sub" id="mmAcceptedSub">Iniciando duelo...</div>
        </div>

        <!-- â‘¥ CANCELLED: rechazado/expirado -->
        <div id="mmStateCancelled" class="mm-cancelled" style="display:none;">
            <div class="mm-cancelled-icon">ğŸ˜”</div>
            <div class="mm-cancelled-title" id="mmCancelledTitle">Partida cancelada</div>
            <div class="mm-cancelled-sub" id="mmCancelledSub">El rival rechazÃ³ o el tiempo expirÃ³.</div>
            <button class="mm-btn-accept" style="width:100%;" onclick="mmOpenSetup()">ğŸ”„ Buscar de nuevo</button>
            <button class="mm-btn-reject" style="width:100%;margin-top:8px;" onclick="mmClose()">Cerrar</button>
        </div>
    </div>
</div>

<!-- Contenedor confetti (fuera del game container para cubrir toda la pantalla) -->
<div id="confettiContainer" aria-hidden="true"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     OVERLAY: Espera al rival (post-partida 1v1 real)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="duelWaitRivalOverlay">
    <div class="duel-wait-icon" id="duelWaitIcon">â³</div>
    <div class="duel-wait-title" id="duelWaitTitle">Esperando al rival...</div>
    <div class="duel-wait-sub" id="duelWaitSub">Tu rival todavÃ­a estÃ¡ jugando. Espera hasta 60 s.</div>
    <div class="duel-wait-score">Tu puntuaciÃ³n: <span id="duelWaitMyScore">â€”</span></div>
    <div class="duel-wait-bar"><div class="duel-wait-fill" id="duelWaitFill" style="width:100%;"></div></div>
</div>
</body>
</html>
